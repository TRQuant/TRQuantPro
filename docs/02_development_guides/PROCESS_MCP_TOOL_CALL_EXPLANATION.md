# process_mcp_tool_call è¯´æ˜æ–‡æ¡£

## ğŸ“– ä»€ä¹ˆæ˜¯ process_mcp_tool_callï¼Ÿ

`process_mcp_tool_call` æ˜¯TRQuantç³»ç»Ÿä¸­**ç»Ÿä¸€çš„MCPå·¥å…·è°ƒç”¨å¤„ç†å‡½æ•°**ï¼Œä½äº `mcp_servers/utils/mcp_integration_helper.py`ã€‚

### æ ¸å¿ƒä½œç”¨

å®ƒå°è£…äº†MCPå·¥å…·è°ƒç”¨çš„**æ ‡å‡†åŒ–æµç¨‹**ï¼ŒåŒ…æ‹¬ï¼š

1. **trace_idè¿½è¸ª** (é˜¶æ®µ1.2è¦æ±‚)
   - è‡ªåŠ¨æå–å’Œè®¾ç½®trace_id
   - åœ¨æ—¥å¿—ä¸­è®°å½•trace_id
   - åœ¨å“åº”ä¸­åŒ…å«trace_id

2. **å‚æ•°éªŒè¯** (é˜¶æ®µ1.1è¦æ±‚)
   - æ ¹æ®å·¥å…·schemaè‡ªåŠ¨éªŒè¯å‚æ•°
   - ç»Ÿä¸€çš„å‚æ•°éªŒè¯é”™è¯¯å¤„ç†
   - æ”¯æŒå¿…å¡«ã€å¯é€‰ã€ç±»å‹ã€å–å€¼èŒƒå›´ç­‰éªŒè¯

3. **é”™è¯¯å¤„ç†** (é˜¶æ®µ1.3è¦æ±‚)
   - ç»Ÿä¸€çš„é”™è¯¯ç ä½“ç³»
   - æ ‡å‡†åŒ–çš„é”™è¯¯å“åº”æ ¼å¼
   - è‡ªåŠ¨åˆ†ç±»é”™è¯¯ï¼ˆå‚æ•°é”™è¯¯ã€ç³»ç»Ÿé”™è¯¯ã€ä¸šåŠ¡é”™è¯¯ï¼‰

4. **ç»“æœåŒ…è£…**
   - ç»Ÿä¸€çš„ç»“æœæ ¼å¼
   - è‡ªåŠ¨æ·»åŠ trace_id
   - æ”¯æŒå¤šç§è¿”å›ç±»å‹è½¬æ¢

### ä½¿ç”¨æ–¹å¼

```python
# åœ¨MCPæœåŠ¡å™¨çš„call_toolæ–¹æ³•ä¸­ä½¿ç”¨
async def call_tool(name: str, arguments: Dict[str, Any]) -> List[TextContent]:
    tools_list = await list_tools()
    
    if name == "tool_name":
        def handler(args):
            # å®é™…çš„å·¥å…·å¤„ç†é€»è¾‘
            return {"result": "success", "data": ...}
        
        result = process_mcp_tool_call(
            tool_name=name,
            arguments=arguments,
            tools_list=tools_list,
            tool_handler_func=handler,
            server_name="my-server",
            version="1.0.0"
        )
        
        # è½¬æ¢ä¸ºTextContentæ ¼å¼
        return _adapt_mcp_result_to_text_content(result)
```

## ğŸ“‹ ä¸å¼€å‘è®¡åˆ’çš„å¯¹åº”å¯¹ç…§

### é˜¶æ®µ1.1: å‘½åä¸å‚æ•°è§„åˆ™åˆ¶å®š âœ…

**è¦æ±‚**:
- âœ… åˆ›å»ºç»Ÿä¸€çš„å‚æ•°éªŒè¯å·¥å…·ç±»ï¼š`mcp_servers/utils/parameter_validator.py`
- âœ… ä¸ºæ‰€æœ‰MCPæœåŠ¡å™¨æ·»åŠ å‚æ•°éªŒè¯

**å®ç°**:
- `process_mcp_tool_call` å†…éƒ¨è°ƒç”¨ `validate_mcp_tool_params` è¿›è¡Œå‚æ•°éªŒè¯
- æ‰€æœ‰ä½¿ç”¨ `process_mcp_tool_call` çš„æœåŠ¡å™¨è‡ªåŠ¨è·å¾—å‚æ•°éªŒè¯èƒ½åŠ›

### é˜¶æ®µ1.2: trace_idè¿½è¸ªæœºåˆ¶ âœ…

**è¦æ±‚**:
- âœ… æ‰€æœ‰MCPè°ƒç”¨éƒ½æœ‰trace_id
- âœ… trace_idè´¯ç©¿æ•´ä¸ªè°ƒç”¨é“¾è·¯
- âœ… æ—¥å¿—ä¸­è®°å½•trace_id

**å®ç°**:
- `process_mcp_tool_call` è‡ªåŠ¨è°ƒç”¨ `get_trace_id_from_args_or_context` æå–trace_id
- ä½¿ç”¨ `TraceManager.set_trace_id` è®¾ç½®å…¨å±€trace_id
- æ‰€æœ‰æ—¥å¿—è‡ªåŠ¨åŒ…å«trace_id
- å“åº”ä¸­è‡ªåŠ¨åŒ…å«trace_id

### é˜¶æ®µ1.3: é”™è¯¯ç ä¸å¼‚å¸¸å¤„ç† âœ…

**è¦æ±‚**:
- âœ… æ‰€æœ‰é”™è¯¯éƒ½æœ‰é”™è¯¯ç 
- âœ… é”™è¯¯å“åº”æ ¼å¼ç»Ÿä¸€
- âœ… é”™è¯¯å¤„ç†è¦†ç›–ç‡è¾¾åˆ°100%

**å®ç°**:
- `process_mcp_tool_call` ä½¿ç”¨ `ErrorCodes` å®šä¹‰é”™è¯¯ç 
- è‡ªåŠ¨æ•è·å¹¶è½¬æ¢å¼‚å¸¸ä¸ºæ ‡å‡†åŒ–é”™è¯¯å“åº”
- æ”¯æŒ `MCPParameterError`ã€`MCPSystemError`ã€`MCPBusinessError` ä¸‰ç§é”™è¯¯ç±»å‹

## ğŸ“Š å½“å‰å®ŒæˆçŠ¶æ€

### âœ… å·²å®Œæˆ

1. **æ ¸å¿ƒå·¥å…·ç±»åˆ›å»º**:
   - âœ… `mcp_integration_helper.py` - ç»Ÿä¸€è°ƒç”¨å¤„ç†å‡½æ•°
   - âœ… `parameter_validator.py` - å‚æ•°éªŒè¯å·¥å…·
   - âœ… `trace_manager.py` - trace_idç®¡ç†
   - âœ… `error_handler.py` - é”™è¯¯å¤„ç†å·¥å…·
   - âœ… `mcp_tool_helper.py` - å·¥å…·schemaè·å–

2. **æœåŠ¡å™¨é›†æˆ**:
   - âœ… 26/26 æœåŠ¡å™¨å·²å¯¼å…¥ `process_mcp_tool_call`
   - âœ… 16/26 æœåŠ¡å™¨å·²å®Œå…¨é›†æˆï¼ˆä½¿ç”¨process_mcp_tool_callï¼‰
   - âœ… 24/26 æœåŠ¡å™¨æœ‰é€‚é…å‡½æ•°

### âš ï¸ å¾…å®Œæˆ

**10ä¸ªæœåŠ¡å™¨å·²å¯¼å…¥ä½†æœªä½¿ç”¨**:
1. `data_quality_server.py` - 4ä¸ªå·¥å…·
2. `engineering_server.py` - 8ä¸ªå·¥å…·
3. `factor_server.py` - 6ä¸ªå·¥å…·
4. `kb_server.py` - 3ä¸ªå·¥å…·
5. `report_server.py` - 6ä¸ªå·¥å…·
6. `schema_server.py` - 4ä¸ªå·¥å…·
7. `strategy_kb_server.py` - 8ä¸ªå·¥å…·
8. `strategy_template_server.py` - 6ä¸ªå·¥å…·
9. `trading_server.py` - 5ä¸ªå·¥å…·
10. `workflow_server.py` - 7ä¸ªå·¥å…·

## ğŸ¯ éªŒæ”¶æ ‡å‡†å¯¹ç…§

æ ¹æ®å¼€å‘è®¡åˆ’é˜¶æ®µ1çš„éªŒæ”¶æ ‡å‡†ï¼š

| éªŒæ”¶æ ‡å‡† | çŠ¶æ€ | è¯´æ˜ |
|---------|------|------|
| âœ… æ‰€æœ‰MCPå·¥å…·éµå¾ªå‘½åè§„èŒƒ | è¿›è¡Œä¸­ | éœ€è¦æ£€æŸ¥æ‰€æœ‰å·¥å…·å‘½å |
| âœ… æ‰€æœ‰å‚æ•°éƒ½æœ‰JSON Schemaå®šä¹‰ | è¿›è¡Œä¸­ | éœ€è¦éªŒè¯æ‰€æœ‰å·¥å…·schema |
| âœ… å‚æ•°éªŒè¯è¦†ç›–ç‡è¾¾åˆ°100% | è¿›è¡Œä¸­ | 10ä¸ªæœåŠ¡å™¨æœªä½¿ç”¨process_mcp_tool_call |
| âœ… æ‰€æœ‰MCPè°ƒç”¨éƒ½æœ‰trace_id | âœ… å®Œæˆ | process_mcp_tool_callè‡ªåŠ¨å¤„ç† |
| âœ… trace_idè´¯ç©¿æ•´ä¸ªè°ƒç”¨é“¾è·¯ | âœ… å®Œæˆ | TraceManagerç»Ÿä¸€ç®¡ç† |
| âœ… æ‰€æœ‰é”™è¯¯éƒ½æœ‰é”™è¯¯ç  | âœ… å®Œæˆ | ErrorCodesç»Ÿä¸€ä½“ç³» |
| âœ… é”™è¯¯å“åº”æ ¼å¼ç»Ÿä¸€ | âœ… å®Œæˆ | create_error_responseç»Ÿä¸€æ ¼å¼ |
| âœ… é”™è¯¯å¤„ç†è¦†ç›–ç‡è¾¾åˆ°100% | è¿›è¡Œä¸­ | 10ä¸ªæœåŠ¡å™¨æœªä½¿ç”¨process_mcp_tool_call |

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ä¿®å¤10ä¸ªæœªä½¿ç”¨çš„æœåŠ¡å™¨**
   - å°†å®ƒä»¬çš„å·¥å…·å¤„ç†é€»è¾‘æ”¹ä¸ºä½¿ç”¨ `process_mcp_tool_call`
   - ç¡®ä¿æ‰€æœ‰å·¥å…·éƒ½é€šè¿‡ç»Ÿä¸€æµç¨‹å¤„ç†

2. **éªŒè¯æ‰€æœ‰å·¥å…·å‘½å**
   - æ£€æŸ¥æ˜¯å¦ç¬¦åˆ `æ¨¡å—_åŠ¨ä½œ` æ ¼å¼
   - æ›´æ–°ä¸ç¬¦åˆè§„èŒƒçš„å‘½å

3. **éªŒè¯æ‰€æœ‰å·¥å…·schema**
   - ç¡®ä¿æ¯ä¸ªå·¥å…·éƒ½æœ‰å®Œæ•´çš„JSON Schemaå®šä¹‰
   - éªŒè¯å‚æ•°ç±»å‹å’ŒéªŒè¯è§„åˆ™

4. **æµ‹è¯•éªŒè¯**
   - å¯¹æ‰€æœ‰æœåŠ¡å™¨è¿›è¡Œé›†æˆæµ‹è¯•
   - éªŒè¯trace_idè¿½è¸ªã€å‚æ•°éªŒè¯ã€é”™è¯¯å¤„ç†æ˜¯å¦æ­£å¸¸å·¥ä½œ









