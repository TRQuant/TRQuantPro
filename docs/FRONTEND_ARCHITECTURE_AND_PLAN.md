# TRQuant 前端方案总结与继续开发计划

> **创建时间**: 2024-12-17  
> **文档版本**: v1.0  
> **状态**: 部分完成，持续开发中

---

## 📊 一、前端架构总览

### 1.1 双前端架构

TRQuant采用**双前端架构**，分别服务于不同的工作流程：

```
┌─────────────────────────────────────────────────────────┐
│                    TRQuant 前端系统                       │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌──────────────────┐        ┌──────────────────┐      │
│  │  Cursor扩展       │        │  PyQt6桌面GUI     │      │
│  │  (TypeScript)    │        │  (Python)        │      │
│  ├──────────────────┤        ├──────────────────┤      │
│  │ • 工作流面板      │        │ • 策略管理        │      │
│  │ • 市场分析        │        │ • 回测执行        │      │
│  │ • 策略生成        │        │ • 结果分析        │      │
│  │ • 回测配置        │        │ • 策略优化        │      │
│  │ • 数据可视化      │        │ • 报告查看        │      │
│  └────────┬─────────┘        └────────┬─────────┘      │
│           │                           │                 │
│           └───────────┬───────────────┘                 │
│                       │                                 │
│              ┌────────▼────────┐                        │
│              │   MCP统一层      │                        │
│              │  (core/mcp/)    │                        │
│              └────────┬────────┘                        │
│                       │                                 │
│              ┌────────▼────────┐                        │
│              │  MCP服务器集群   │                        │
│              └─────────────────┘                        │
└─────────────────────────────────────────────────────────┘
```

---

## 🖥️ 二、PyQt6桌面GUI（工程型GUI）

### 2.1 当前状态

**完成度**: 85%

#### 已完成模块 ✅

| 模块 | 文件 | 行数 | 状态 |
|------|------|------|------|
| **主窗口** | `gui/main_window_v2.py` | 478 | ✅ 完成 |
| **策略管理** | `gui/widgets/strategy_manager_panel.py` | 507 | ✅ 完成 |
| **回测进度** | `gui/widgets/backtest_progress_panel.py` | 506 | ✅ 完成 |
| **回测结果** | `gui/widgets/backtest_result_panel.py` | 475 | ✅ 完成 |
| **报告查看** | `gui/widgets/report_viewer_panel.py` | 413 | ✅ 完成 |
| **MCP客户端** | `core/mcp/client.py` | 574 | ✅ 完成 |

**总计**: 2,953行代码

#### 待完善模块 ⚠️

| 模块 | 优先级 | 说明 |
|------|--------|------|
| **策略优化面板** | 高 | Optuna优化界面 |
| **券商App回测** | 中 | QMT/PTrade回测集成 |
| **实盘交易面板** | 中 | 交易执行和监控 |
| **设置页面** | 低 | 系统配置界面 |
| **PDF导出** | 低 | 报告导出功能 |

---

### 2.2 技术架构

#### 技术栈

- **GUI框架**: PyQt6
- **图表绘制**: 原生QPainter（无需额外图表库）
- **异步处理**: QThread + ThreadPoolExecutor
- **网络请求**: requests（通过MCP客户端）
- **样式**: QSS深色主题

#### 架构模式

**当前**: 单窗口多面板模式
- 主窗口包含多个功能面板
- 通过侧边栏切换面板
- 信号槽机制连接各组件

**目标**: MVC/MVVM模式（待重构）
- Model: 数据模型和业务逻辑
- View: UI组件
- Controller: 控制器和信号处理

---

### 2.3 UI设计特点

1. **深色主题**: 专业量化风格
2. **渐变色彩**: 青色(#00d9ff)主题色
3. **卡片式布局**: 清晰的信息展示
4. **响应式设计**: 可调整分割面板
5. **图表原生绘制**: 无需额外图表库

---

### 2.4 MCP集成

**MCP客户端**: `core/mcp/client.py`

**支持的工具** (33个):
- `backtest.bullettrade` - BulletTrade回测
- `backtest.qmt` - QMT回测
- `backtest.quick` - 快速回测
- `optimizer.optuna` - Optuna优化
- `factor.recommend` - 因子推荐
- `workflow.run_step` - 工作流步骤
- `report.generate` - 报告生成
- ... 等

---

## 💻 三、Cursor扩展（研究型GUI）

### 3.1 当前状态

**完成度**: 90%

#### 已完成模块 ✅

| 模块 | 文件 | 功能 |
|------|------|------|
| **工作流面板** | `extension/src/views/workflowPanel.ts` | 9步工作流可视化 |
| **市场分析面板** | `extension/src/views/marketPanel.ts` | 市场状态和趋势 |
| **策略生成面板** | `extension/src/views/strategyGeneratorPanel.ts` | 策略代码生成 |
| **回测面板** | `extension/src/views/backtestPanel.ts` | 回测配置和执行 |
| **优化面板** | `extension/src/views/optimizerPanel.ts` | 策略优化 |
| **报告面板** | `extension/src/views/reportPanel.ts` | 回测报告查看 |
| **策略管理面板** | `extension/src/views/strategyManagerPanel.ts` | 策略库管理 |
| **主仪表板** | `extension/src/views/mainDashboard.ts` | 综合仪表板 |

#### 核心服务 ✅

| 服务 | 文件 | 功能 |
|------|------|------|
| **MCP客户端** | `extension/src/services/mcpClient.ts` | MCP工具调用封装 |
| **TRQuant客户端** | `extension/src/services/trquantClient.ts` | TRQuant API调用 |
| **回测管理器** | `extension/src/services/backtestManager.ts` | 回测任务管理 |
| **策略优化器** | `extension/src/services/strategyOptimizer/` | 策略优化服务 |

---

### 3.2 技术架构

#### 技术栈

- **语言**: TypeScript
- **框架**: VS Code Extension API
- **UI**: React + WebView
- **图表**: ECharts
- **通信**: MCP Protocol (stdio)

#### 架构模式

**命令模式**:
- 每个功能对应一个Command
- 通过命令面板调用
- 支持快捷键绑定

**面板模式**:
- WebView展示复杂UI
- 原生VS Code组件用于简单交互
- 数据通过MCP协议获取

---

### 3.3 数据可视化

**图表库**: ECharts

**已实现图表**:
- 市场趋势图（K线图）
- 投资主线雷达图
- 回测收益曲线
- 回撤曲线
- 五维评分雷达图
- 因子暴露热力图

---

## 📋 四、前端功能对比

| 功能模块 | Cursor扩展 | PyQt6 GUI | 说明 |
|---------|-----------|----------|------|
| **工作流** | ✅ | ❌ | 9步工作流可视化 |
| **市场分析** | ✅ | ⚠️ | 市场状态、趋势、主线 |
| **策略生成** | ✅ | ⚠️ | 策略代码生成 |
| **策略管理** | ✅ | ✅ | 策略库管理 |
| **回测执行** | ✅ | ✅ | 回测配置和执行 |
| **回测结果** | ✅ | ✅ | 结果分析和可视化 |
| **策略优化** | ✅ | ⚠️ | Optuna优化 |
| **报告查看** | ✅ | ✅ | HTML/PDF报告 |
| **实盘交易** | ❌ | ⚠️ | 交易执行和监控 |
| **文件管理** | ✅ | ✅ | 策略代码、回测报告、研究文档管理 |
| **实盘交易** | ❌ | ⚠️ | 交易执行和监控 |

---

## 📁 五、文件查看管理系统（Web Dashboard）

### 5.1 系统概述

TRQuant提供**独立的Web文件管理系统**，用于统一管理策略代码、回测报告、研究文档等文件资源。

**架构**:
```
┌─────────────────────────────────────────┐
│      Web Dashboard (Flask)              │
│  http://localhost:5000                  │
├─────────────────────────────────────────┤
│ • 策略代码管理                           │
│ • 回测报告查看                           │
│ • 研究文档浏览                           │
│ • MongoDB数据库管理                      │
└─────────────────────────────────────────┘
```

### 5.2 实现位置

#### Web服务 ✅

| 组件 | 文件 | 端口 | 状态 |
|------|------|------|------|
| **主Dashboard** | `dashboard/dashboard_server.py` | 5000 | ✅ 完成 |
| **扩展Dashboard** | `extension/dashboard/server.py` | 5000 | ✅ 完成 |
| **启动脚本** | `extension/start_dashboard.py` | - | ✅ 完成 |

#### PyQt6集成 ✅

| 组件 | 文件 | 功能 |
|------|------|------|
| **数据管理面板** | `gui/widgets/data_manager_panel.py` | 整合Web Dashboard入口 |
| **数据查看器** | `gui/widgets/data_viewer.py` | 通用数据查看对话框 |
| **日志查看器** | `gui/widgets/log_viewer.py` | 系统日志查看 |

### 5.3 功能特性

#### 5.3.1 策略代码管理

- **多平台支持**: PTrade、QMT、QuantConnect、本地示例
- **代码预览**: 在线查看策略代码
- **版本管理**: Git版本控制集成
- **快速筛选**: 按平台、类型筛选

#### 5.3.2 回测报告查看

- **报告列表**: 展示所有回测报告
- **HTML渲染**: 在线查看HTML报告
- **PDF下载**: 支持PDF格式下载
- **报告对比**: 多标签页对比分析

#### 5.3.3 研究文档管理

- **文档分类**:
  - 平台总览与架构
  - 策略研究与回测
  - 实盘交易与券商集成
  - 部署运维与环境
- **Markdown渲染**: 自动渲染为HTML
- **文档搜索**: 关键词搜索功能
- **在线查看**: 无需下载即可查看

#### 5.3.4 数据库管理

- **MongoDB集成**: 显示集合信息
- **数据统计**: 文档数、大小、最后更新
- **数据导出**: 支持JSON格式导出

### 5.4 访问方式

#### 方式1: 从PyQt6 GUI访问

1. 打开PyQt6桌面应用
2. 点击"数据管理中心"面板
3. 点击"📂 打开文件管理系统"按钮
4. 自动启动Web服务并打开浏览器

#### 方式2: 直接访问

```bash
# 启动Dashboard服务
cd /home/taotao/dev/QuantTest/TRQuant
python start_dashboard.py

# 或使用扩展目录的Dashboard
cd extension
python start_dashboard.py
```

浏览器访问: `http://localhost:5000`

### 5.5 技术实现

#### 技术栈

- **Web框架**: Flask
- **模板引擎**: Jinja2
- **Markdown渲染**: markdown库
- **数据库**: MongoDB (pymongo)
- **CORS支持**: flask-cors

#### 目录结构

```
TRQuant/
├── dashboard/
│   ├── dashboard_server.py      # 主Dashboard服务
│   ├── templates/
│   │   ├── dashboard.html        # 主页面模板
│   │   └── doc_viewer.html       # 文档查看模板
│   └── static/                   # 静态资源
├── extension/
│   ├── dashboard/
│   │   └── server.py             # 扩展Dashboard服务
│   └── start_dashboard.py        # 启动脚本
└── gui/widgets/
    ├── data_manager_panel.py     # 数据管理面板
    ├── data_viewer.py            # 数据查看器
    └── log_viewer.py             # 日志查看器
```

### 5.6 与Cursor扩展集成

**当前状态**: ⚠️ 待集成

**计划**:
- [ ] 在Cursor扩展中添加"文件管理"面板
- [ ] 调用Web Dashboard API
- [ ] 支持在WebView中打开Dashboard

---

## 🎯 六、继续开发计划

---


### Phase 1: PyQt6 GUI完善（2周，高优先级）

#### 1.1 策略优化面板开发 ⚠️ 高优先级

**目标**: 实现策略参数优化界面

**任务分解**:
1. **UI设计** (2天)
   - [ ] 优化参数配置界面
   - [ ] 优化进度显示
   - [ ] 结果对比图表

2. **功能实现** (3天)
   - [ ] 集成Optuna优化器
   - [ ] 实时显示优化进度
   - [ ] 参数空间可视化

3. **测试和优化** (2天)
   - [ ] 编写测试用例
   - [ ] 性能优化

**验收标准**:
- ✅ 支持Optuna优化
- ✅ 实时进度显示
- ✅ 结果可视化

**预计完成时间**: 2024-12-31

---

#### 1.2 MVC/MVVM架构重构 ⚠️ 中优先级

**目标**: 重构GUI代码，采用MVC/MVVM模式

**任务分解**:
1. **架构设计** (2天)
   - [ ] 设计Model/View/Controller结构
   - [ ] 设计信号槽机制
   - [ ] 创建文档：`docs/02_development_guides/GUI_ARCHITECTURE_DESIGN.md`

2. **基础框架实现** (3天)
   - [ ] 创建：`gui/framework/`
   - [ ] 实现：BaseModel、BaseView、BaseController
   - [ ] 实现：信号槽管理器

3. **重构现有代码** (5天)
   - [ ] 重构主窗口
   - [ ] 重构功能面板
   - [ ] 应用MVC/MVVM模式

**验收标准**:
- ✅ 架构方案设计完成
- ✅ 基础框架实现完成
- ✅ 现有GUI重构完成

**预计完成时间**: 2025-01-15

---

#### 1.3 任务触发与异步优化 ⚠️ 中优先级

**目标**: 实现多线程/异步任务触发器

**任务分解**:
1. **任务触发器组件** (3天)
   - [ ] 创建：`gui/components/task_trigger.py`
   - [ ] 功能：任务队列管理、进度显示、取消控制

2. **集成到GUI** (3天)
   - [ ] 为回测、数据更新等耗时操作添加任务触发器
   - [ ] 实现进度条显示
   - [ ] 实现取消功能

**验收标准**:
- ✅ 任务触发器组件实现完成
- ✅ 集成到GUI完成
- ✅ UI不阻塞

**预计完成时间**: 2025-01-10

---

#### 1.4 图表展示库增强 ⚠️ 中优先级

**目标**: 引入专业绘图组件

**任务分解**:
1. **图表库选择** (1天)
   - [ ] 评估：PyQtGraph vs Qt Charts
   - [ ] 选择：PyQtGraph（实时更新）+ Qt Charts（静态图表）

2. **图表组件实现** (3天)
   - [ ] 创建：`gui/components/charts/`
   - [ ] 实现：K线图、收益曲线、回撤曲线、因子暴露热力图

3. **集成到GUI** (2天)
   - [ ] 集成图表组件到主窗口
   - [ ] 实现数据绑定和实时更新

**验收标准**:
- ✅ 图表组件实现完成
- ✅ 集成到GUI完成
- ✅ 实时更新正常

**预计完成时间**: 2025-01-20

---

### Phase 2: Cursor扩展完善（1-2周，中优先级）

#### 2.1 工作流状态持久化 ⚠️ 中优先级

**目标**: 支持工作流状态保存和恢复

**任务分解**:
1. **状态存储设计** (2天)
   - [ ] 设计状态存储结构
   - [ ] 状态恢复机制

2. **功能实现** (3天)
   - [ ] 实现状态保存
   - [ ] 实现状态恢复
   - [ ] 状态查询接口

**验收标准**:
- ✅ 支持工作流状态保存和恢复
- ✅ 错误恢复成功率>90%

**预计完成时间**: 2025-01-15

---

#### 2.2 数据可视化增强 ⚠️ 中优先级

**目标**: 增强图表展示功能

**任务分解**:
1. **新图表类型** (2天)
   - [ ] 持仓分析饼图
   - [ ] 交易明细表格
   - [ ] 风险指标仪表盘

2. **交互功能** (2天)
   - [ ] 图表缩放和平移
   - [ ] 数据点提示
   - [ ] 图表导出

**验收标准**:
- ✅ 新图表类型实现完成
- ✅ 交互功能可用

**预计完成时间**: 2025-01-20

---

#### 2.3 错误处理和用户体验优化 ⚠️ 中优先级

**目标**: 提升用户体验

**任务分解**:
1. **错误处理** (2天)
   - [ ] 统一错误提示
   - [ ] 错误恢复机制
   - [ ] 错误日志记录

2. **用户体验** (2天)
   - [ ] 加载状态提示
   - [ ] 操作确认对话框
   - [ ] 快捷键支持

**验收标准**:
- ✅ 错误处理完善
- ✅ 用户体验提升

**预计完成时间**: 2025-01-25

---

### Phase 3: 跨平台支持（1周，低优先级）

#### 3.1 构建和部署工具链

**目标**: 建立完整的构建、调试和部署工具链

**任务分解**:
1. **构建工具链** (2天)
   - [ ] 使用PyInstaller打包PyQt6应用
   - [ ] 创建：`scripts/build.py`
   - [ ] 支持Windows和Linux

2. **部署方案** (2天)
   - [ ] 桌面应用安装包
   - [ ] 源码运行脚本
   - [ ] Docker镜像

**验收标准**:
- ✅ 构建工具链完成
- ✅ 部署方案完成

**预计完成时间**: 2025-02-10

---

## 📅 七、开发时间表

### 2024年12月（当前月）

- ⚠️ 策略优化面板开发（进行中）
- ⚠️ 任务触发与异步优化（计划中）

### 2025年1月

- MVC/MVVM架构重构
- 图表展示库增强
- 工作流状态持久化
- 数据可视化增强

### 2025年2月

- 错误处理和用户体验优化
- 构建和部署工具链
- 跨平台支持

---

## 🎯 八、关键里程碑

| 里程碑 | 目标日期 | 状态 |
|--------|---------|------|
| 策略优化面板完成 | 2024-12-31 | ⚠️ 进行中 |
| MVC/MVVM重构完成 | 2025-01-15 | 📅 计划中 |
| 图表库增强完成 | 2025-01-20 | 📅 计划中 |
| 工作流状态持久化 | 2025-01-15 | 📅 计划中 |
| 构建工具链完成 | 2025-02-10 | 📅 计划中 |

---

## 📊 九、技术债务

### 8.1 代码质量

1. **架构重构**: 当前单窗口模式，需要重构为MVC/MVVM
2. **代码复用**: 部分功能在PyQt6和Cursor扩展中重复
3. **测试覆盖**: GUI测试用例不足

### 8.2 性能优化

1. **启动速度**: GUI启动时间需要优化
2. **内存占用**: 长时间运行内存占用较高
3. **响应速度**: 部分操作响应较慢

### 8.3 用户体验

1. **错误提示**: 错误信息不够友好
2. **操作引导**: 缺少新手引导
3. **快捷键**: 快捷键支持不完整

---

## 📝 十、总结

### 9.1 当前成果

1. **PyQt6 GUI**: 核心功能完成85%，策略管理、回测、报告查看已实现
2. **Cursor扩展**: 核心功能完成90%，工作流、市场分析、策略生成已实现
3. **MCP集成**: 统一接口，支持33个工具调用
4. **数据可视化**: ECharts集成，支持多种图表类型

### 9.2 下一步重点

1. **策略优化面板**（最高优先级）
   - Optuna优化界面
   - 参数空间可视化

2. **架构重构**（高优先级）
   - MVC/MVVM模式
   - 代码组织优化

3. **用户体验**（中优先级）
   - 错误处理完善
   - 操作引导
   - 性能优化

---

**文档维护**: TRQuant Team  
**最后更新**: 2024-12-17  
**下次更新**: 2024-12-31
