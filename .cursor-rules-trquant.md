# TRQuant Cursor AI 规则

## 自动备份规则

### 触发条件
- 完成重要功能开发后自动commit和push
- 完成章节内容更新后自动commit和push
- 修复重要bug后自动commit和push
- 用户明确说"提交"、"commit"、"推送"、"push"时
- 完成大规模代码重构后自动commit和push

### 执行流程
1. 检查是否有未提交的更改：`git status --porcelain`
2. 如果有更改，生成合适的commit message
3. 执行 `git add -A` 添加所有更改
4. 执行 `git commit -m "<message>"`
5. **只commit，不自动push**（避免推送太频繁）
6. 当有多个提交或用户明确要求时，才执行 `git push trquantpro main-clean:main`

### Commit Message规范
- 格式：`<type>: <description>`
- 类型：
  - `feat`: 新功能
  - `fix`: 修复bug
  - `docs`: 文档更新
  - `chore`: 构建/工具/配置更新
  - `refactor`: 代码重构
- 示例：
  - `feat: 完成第六册系统开发手册基础框架`
  - `fix: 修复代码自动更新功能`
  - `docs: 更新GitHub推送问题解决方案`

### 安全措施
- 自动提交前检查 `.gitignore`，确保敏感文件不会被提交
- 不提交包含密码、token、密钥的文件
- 不提交大文件（已配置在.gitignore中）
- 推送失败时提示用户，不强制推送

### 推送目标
- 默认推送到：`trquantpro` 远程（TRQuant/TRQuantPro仓库）
- 分支映射：`main-clean` → `main`
- 命令：`git push trquantpro main-clean:main`

### 自动备份规则（⚠️ 强制要求）

#### ⚠️ 强制规则：restore/reset 前必须备份
**绝对禁止**：在执行任何 `git restore`、`git reset`、`git checkout` 等可能覆盖本地更改的命令前，**必须先备份**。

#### 触发条件（必须备份）
- ✅ **执行 git restore 前** → **强制备份**
- ✅ **执行 git reset 前** → **强制备份**
- ✅ **执行 git checkout 前**（切换分支或恢复文件）→ **强制备份**
- ✅ **大规模重构或删除前** → **强制备份**
- ✅ **用户说"备份"时** → **立即备份**

#### 备份策略
- **默认使用 backup_essential**（快速，只备份代码和配置）
- **重要节点使用 backup_full**（完整备份）
- **restore/reset 操作前** → 使用 **backup_essential**（必须）

### 备份策略
- 默认使用 backup_essential（快速，只备份代码和配置）
- 重要节点使用 backup_full（完整备份）

### 执行流程
1. 检测到危险操作 → 提示"正在创建备份..."
2. 调用 backup_essential 工具
3. 显示备份结果（路径、大小、文件数）
4. 确认后执行用户请求

### 工具调用
- backup_essential: 日常备份
- backup_full: 完整备份
- list_backups: 查看备份列表
- delete_backup: 删除旧备份

备份位置: /mnt/data/backups/TRQuant/

## 文件创建和编辑规则（⚠️ 重要）

### 文件创建规则

#### ⚠️ 核心原则：避免write工具超时

**问题**: `write` 工具在创建文件时会将内容显示在chat窗口，导致大文件超时。

**解决方案**: 创建文件时，**默认使用 `cat heredoc`**，避免使用 `write` 工具。

#### 文件创建决策树

1. **创建新文件（任何大小）** → **必须使用 `cat heredoc`**
   ```bash
   cat > target_file.py << 'ENDOFFILE'
   # 文件内容
   ...
   ENDOFFILE
   ```

2. **小文件修改（<50行）** → 可以使用 `search_replace`
3. **大文件修改（>50行）** → 使用 Python 脚本
4. **完全重写文件** → 使用 `cat heredoc`

#### 禁止行为

- ❌ **禁止**使用 `write` 工具创建新文件（会超时）
- ❌ **禁止**在chat窗口显示大文件内容（除非用户明确要求）
- ❌ **禁止**创建文件后自动读取并显示内容

#### 文件内容显示规则

- **默认不显示文件内容**（除非用户明确要求）
- **只显示操作结果和统计信息**：
  - 文件路径
  - 文件大小
  - 行数统计
  - 创建/修改状态

#### 大文件处理规则

- **大文件定义**: 文件行数 > 100行 或 文件大小 > 10KB
- **大文件必须使用 `cat heredoc`**
- **大文件创建后不显示内容，只显示统计信息**

#### 文件生成和显示规则

1. **文件命名规范**:
   - 使用英文、描述性名称
   - 避免数字索引（除非必要）
   - 遵循snake_case命名

2. **文件生成流程**:
   - 评估文件大小
   - 选择合适的方法（cat heredoc / Python脚本）
   - 创建文件
   - 验证文件创建成功（可选）
   - **不显示文件内容**（除非用户要求）

3. **操作结果报告**:
   ```
   ✅ 文件创建成功: path/to/file.py
   - 大小: 15.2 KB
   - 行数: 234 行
   - 编码: UTF-8
   ```

### 文件修改规则

#### 小修改（<50行）
- 使用 `search_replace` 工具
- 提供足够的上下文确保唯一匹配

#### 大修改（>50行）
- 使用 Python 脚本
- 读取文件 → 修改内容 → 写入文件
- 验证语法（如需要）

#### 完全重写
- 使用 `cat heredoc`
- 不显示内容，只显示统计信息

