# TRQuant Cursor AI 规则

## 文件生成和显示规则（⚠️ 重要）

### ⚠️ 核心原则：减少聊天窗口输出
- **默认行为**：生成文件时，**不在聊天窗口显示文件内容**（除非用户明确要求）
- **原因**：大文件内容会严重影响响应速度，造成聊天窗口卡顿
- **例外情况**：用户明确说"显示"、"查看"、"展示"文件内容时，才显示

### 文件操作优化
- **生成文件**：使用 `write` 或 `search_replace` 工具，完成后只显示简短确认信息
- **批量操作**：批量生成文件时，只显示统计信息（如"已生成 10 个文件"）
- **大文件处理**：文件 > 30KB 时，使用 `cat heredoc` 或脚本批量处理，不显示内容

### 显示规则
- ✅ **显示**：文件路径、操作结果、统计信息
- ❌ **不显示**：文件完整内容、大段代码、批量文件内容
- ✅ **例外**：用户明确要求查看文件内容时，可以显示

## 自动提交和推送规则

### 触发条件
- 完成重要功能开发后自动commit（不自动push）
- 完成章节内容更新后自动commit（不自动push）
- 修复重要bug后自动commit（不自动push）
- 用户明确说"提交"、"commit"时 → 只commit
- 用户明确说"推送"、"push"时 → commit + push
- 完成大规模代码重构后自动commit（不自动push）
- 积累多个提交后，可以批量push

### 执行流程
1. 检查是否有未提交的更改：`git status --porcelain`
2. 如果有更改，生成合适的commit message
3. 执行 `git add -A` 添加所有更改
4. 执行 `git commit -m "<message>"`
5. **只commit，不自动push**（避免推送太频繁）
6. 当有多个提交或用户明确要求时，才执行 `git push trquantpro main-clean:main`

### Commit Message规范
- 格式：`<type>: <description>`
- 类型：
  - `feat`: 新功能
  - `fix`: 修复bug
  - `docs`: 文档更新
  - `chore`: 构建/工具/配置更新
  - `refactor`: 代码重构
- 示例：
  - `feat: 完成第六册系统开发手册基础框架`
  - `fix: 修复代码自动更新功能`
  - `docs: 更新GitHub推送问题解决方案`

### 安全措施
- 自动提交前检查 `.gitignore`，确保敏感文件不会被提交
- 不提交包含密码、token、密钥的文件
- 不提交大文件（已配置在.gitignore中）
- 推送失败时提示用户，不强制推送

### 推送目标
- 默认推送到：`trquantpro` 远程（TRQuant/TRQuantPro仓库）
- 分支映射：`main-clean` → `main`
- 命令：`git push trquantpro main-clean:main`

### 自动备份规则（⚠️ 强制要求）

#### ⚠️ 强制规则：restore/reset 前必须备份
**绝对禁止**：在执行任何 `git restore`、`git reset`、`git checkout` 等可能覆盖本地更改的命令前，**必须先备份**。

#### 触发条件（必须备份）
- ✅ **执行 git restore 前** → **强制备份**
- ✅ **执行 git reset 前** → **强制备份**
- ✅ **执行 git checkout 前**（切换分支或恢复文件）→ **强制备份**
- ✅ **大规模重构或删除前** → **强制备份**
- ✅ **用户说"备份"时** → **立即备份**

#### 备份策略
- **默认使用 backup_essential**（快速，只备份代码和配置）
- **重要节点使用 backup_full**（完整备份）
- **restore/reset 操作前** → 使用 **backup_essential**（必须）

#### 执行流程（严格遵循）
1. **检测到危险操作**（restore/reset/checkout）→ **立即停止**
2. **提示用户**："⚠️ 检测到危险操作，正在创建备份..."
3. **强制调用 backup_essential 工具**（不允许跳过）
4. **等待备份完成**，显示备份结果（路径、大小、文件数）
5. **备份成功后**，才允许执行用户请求的restore/reset操作
6. **如果备份失败**，**禁止执行**restore/reset，提示用户手动备份

#### 禁止行为
- ❌ **禁止**：在未备份的情况下执行 restore/reset
- ❌ **禁止**：跳过备份步骤
- ❌ **禁止**：假设用户已经备份
- ❌ **禁止**：在备份失败后继续执行restore/reset

#### 工具调用
- backup_essential: 日常备份
- backup_full: 完整备份
- list_backups: 查看备份列表
- delete_backup: 删除旧备份

备份位置: /mnt/data/backups/TRQuant/

## 文件操作优化规则

### 大文件处理策略
- **文件大小 > 30KB**：优先使用 `cat heredoc` 或 `run_terminal_cmd` 直接写入，避免 `write` 工具可能导致的超时。
- **文件大小 <= 30KB**：可使用 `write` 工具。

### 性能优化指南
- 减少不必要的 `read_file` 调用，尤其是在循环中。
- 批量操作时，尽量使用脚本一次性完成，减少工具调用次数。
- 避免频繁的 `search_replace`，尤其是在大文件中。

### 工具选择标准
- **`write`**：适用于小文件或已知精确内容的写入。
- **`cat heredoc`**：适用于写入大文件或多行内容，且内容已知。
- **`search_replace`**：适用于精确的字符串替换，但对性能敏感。

## 代码文件命名规范

### 命名格式
- **格式**：`code_{chapter}_{section}_{function_name_or_description}.py`
- **示例**：
  - `code_3_1_1_calculate_sma.py`（函数名）
  - `code_2_1_data_source_base.py`（描述性名称）
  - `code_2_2_check_missing_values.py`（函数名）

### 命名优先级
1. **优先使用函数名**：如果代码块中有 `def function_name`，使用函数名
2. **其次使用类名**：如果代码块中有 `class ClassName`，使用类名
3. **最后使用描述**：从Markdown标题或上下文提取描述性名称

### 命名要求
- **统一使用英文**：所有文件名使用英文，不使用中文
- **使用下划线分隔**：单词之间使用下划线 `_`
- **避免数字索引**：除非有多个相同主题的代码块，否则不使用数字索引
- **保持一致性**：所有章节使用相同的命名风格
