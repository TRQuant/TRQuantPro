# TRQuant 系统 Cursor AI 开发规则

> **重要：在修改任何代码前，请严格遵守以下规则**

## 🛡️ 核心保护规则

### 1. **文件保护级别**

**🔴 核心文件（禁止直接修改，必须先获得确认）：**
- `extension/src/extension.ts` - 扩展入口
- `extension/src/providers/workflowProvider.ts` - 工作流提供者
- `extension/src/views/workflowStepPanel.ts` - 工作流步骤面板
- `extension/src/services/trquantClient.ts` - 核心客户端
- `extension/package.json` - 扩展配置
- `TRQuant.py` - Python 主程序
- `core/workflow_orchestrator.py` - 工作流编排器

**🟡 重要文件（修改前需显示 diff）：**
- `extension/src/views/*.ts` - 所有视图文件
- `extension/src/services/*.ts` - 所有服务文件
- `extension/src/commands/*.ts` - 所有命令文件
- `core/services/*.py` - Python 核心服务

**🟢 可自由修改：**
- 测试文件
- 文档文件
- 临时文件

---

### 2. **修改前必须执行的步骤**

```
1. 先分析问题，不要立即修改代码
2. 生成执行计划（Plan），列出：
   - 要修改的文件列表
   - 每处修改的原因
   - 修改后的预期效果
3. 显示 diff 预览
4. 等待确认后再执行
```

---

### 3. **架构约束**

**VS Code Extension 架构：**
- 使用 `vscode.ExtensionContext` 管理生命周期
- 命令注册：`vscode.commands.registerCommand()`
- 树视图：实现 `vscode.TreeDataProvider`
- WebView：使用 `vscode.window.createWebviewPanel()`
- 消息传递：`webview.postMessage()` 和 `webview.onDidReceiveMessage()`

**Python 后端架构：**
- 使用 `WorkflowOrchestrator` 统一管理工作流
- 服务通过 `TRQuantClient` 桥接
- 数据源：JQData, AKShare, MongoDB
- 交易接口：BulletTrade (PTrade/QMT)

**禁止的操作：**
- ❌ 直接修改核心架构文件
- ❌ 删除已注册的命令或视图
- ❌ 修改 `package.json` 的激活事件
- ❌ 破坏现有的消息传递机制
- ❌ 修改 Python 主程序的启动逻辑

---

### 4. **工作流步骤定义（8步）**

当前系统使用 8 步工作流，定义在 `workflowStepPanel.ts` 中：

1. 📡 **数据中心** (`data-center`) - 更新数据库和知识库
2. 📈 **市场分析** (`market-analysis`) - 分析市场环境和趋势
3. 🔥 **投资主线** (`mainlines`) - 识别市场热点和投资主线
4. 📦 **候选池** (`candidate-pool`) - 构建股票候选池
5. 📊 **因子中心** (`factor-center`) - 构建和优化量化因子
6. 🛠️ **策略开发** (`strategy-dev`) - 开发和优化交易策略
7. 🔄 **回测中心** (`backtest-center`) - 验证策略历史表现
8. 🚀 **交易中心** (`trading-center`) - 实盘模拟和交易

**注意：** 不要随意修改步骤定义或顺序。

---

### 5. **错误处理规则**

- 所有异步操作必须使用 `try-catch`
- 使用 `logger` 记录错误，不要直接 `console.log`
- 用户操作失败时显示友好的错误提示
- 不要静默失败，必须给用户反馈

---

### 6. **代码质量要求**

- TypeScript 严格模式
- 所有函数必须有类型注解
- 避免 `any` 类型
- 使用 async/await，避免回调地狱
- 遵循现有代码风格（2 空格缩进）

---

### 7. **测试要求**

修改代码后：
1. 运行 `npm run compile` 确保无编译错误
2. 打包扩展：`npx vsce package`
3. 安装测试：`code --install-extension *.vsix --force`
4. 重新加载 VS Code 窗口测试功能

---

### 8. **备份规则**

**修改核心文件前必须：**
1. 检查 `.backups/` 目录是否有最新备份
2. 如果修改失败，可以快速恢复

**备份命令：**
```bash
# 创建备份
cp -r extension .backups/backup-$(date +%Y-%m-%dT%H-%M-%S-%3NZ)
```

---

## 📋 标准操作流程模板

### 场景：修复工作流面板问题

```
1. 【分析】先查看错误日志和用户反馈，定位问题
2. 【计划】列出需要修改的文件和修改点
3. 【预览】显示 diff，确认修改范围
4. 【执行】确认后修改代码
5. 【验证】编译、打包、安装、测试
6. 【记录】在代码中添加版本标记（如需要）
```

### 场景：添加新功能

```
1. 【分析】确认功能需求和实现方式
2. 【设计】设计文件结构和接口
3. 【计划】列出新增文件和修改文件
4. 【预览】显示所有变更的 diff
5. 【执行】确认后创建/修改文件
6. 【测试】编译测试，确保无错误
```

---

## 🚨 紧急恢复流程

如果修改导致系统崩溃：

1. **立即停止**：不要继续修改
2. **恢复备份**：
   ```bash
   rm -rf extension
   cp -r .backups/backup-最新时间戳/extension extension
   ```
3. **重新编译安装**：
   ```bash
   cd extension
   npm install
   npm run compile
   npx vsce package
   code --install-extension *.vsix --force
   ```
4. **重新加载窗口**：`Ctrl+Shift+P` → `Reload Window`

---

## 💡 提示

- 不确定时，先提问，不要猜测
- 大改动前，先做小范围测试
- 保持代码简洁，避免过度设计
- 遵循现有架构，不要随意重构

---

**最后更新：** 2024-12-06
**适用系统：** TRQuant 量化投资系统





















