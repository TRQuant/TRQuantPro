# TRQuant Cursor AI 规则

## 自动提交和推送规则

### 触发条件
- 完成重要功能开发后自动commit和push
- 完成章节内容更新后自动commit和push
- 修复重要bug后自动commit和push
- 用户明确说"提交"、"commit"、"推送"、"push"时
- 完成大规模代码重构后自动commit和push

### 执行流程
1. 检查是否有未提交的更改：`git status --porcelain`
2. 如果有更改，生成合适的commit message
3. 执行 `git add -A` 添加所有更改
4. 执行 `git commit -m "<message>"`
5. **只commit，不自动push**（避免推送太频繁）
6. 当有多个提交或用户明确要求时，才执行 `git push trquantpro main-clean:main`

### Commit Message规范
- 格式：`<type>: <description>`
- 类型：
  - `feat`: 新功能
  - `fix`: 修复bug
  - `docs`: 文档更新
  - `chore`: 构建/工具/配置更新
  - `refactor`: 代码重构
- 示例：
  - `feat: 完成第六册系统开发手册基础框架`
  - `fix: 修复代码自动更新功能`
  - `docs: 更新GitHub推送问题解决方案`

### 安全措施
- 自动提交前检查 `.gitignore`，确保敏感文件不会被提交
- 不提交包含密码、token、密钥的文件
- 不提交大文件（已配置在.gitignore中）
- 推送失败时提示用户，不强制推送

### 推送目标
- 默认推送到：`trquantpro` 远程（TRQuant/TRQuantPro仓库）
- 分支映射：`main-clean` → `main`
- 命令：`git push trquantpro main-clean:main`

### 自动备份规则（⚠️ 强制要求）

#### ⚠️ 强制规则：restore/reset 前必须备份
**绝对禁止**：在执行任何 `git restore`、`git reset`、`git checkout` 等可能覆盖本地更改的命令前，**必须先备份**。

#### 触发条件（必须备份）
- ✅ **执行 git restore 前** → **强制备份**
- ✅ **执行 git reset 前** → **强制备份**
- ✅ **执行 git checkout 前**（切换分支或恢复文件）→ **强制备份**
- ✅ **大规模重构或删除前** → **强制备份**
- ✅ **用户说"备份"时** → **立即备份**

#### 备份策略
- **默认使用 backup_essential**（快速，只备份代码和配置）
- **重要节点使用 backup_full**（完整备份）
- **restore/reset 操作前** → 使用 **backup_essential**（必须）

#### 执行流程（严格遵循）
1. **检测到危险操作**（restore/reset/checkout）→ **立即停止**
2. **提示用户**："⚠️ 检测到危险操作，正在创建备份..."
3. **强制调用 backup_essential 工具**（不允许跳过）
4. **等待备份完成**，显示备份结果（路径、大小、文件数）
5. **备份成功后**，才允许执行用户请求的restore/reset操作
6. **如果备份失败**，**禁止执行**restore/reset，提示用户手动备份

#### 禁止行为
- ❌ **禁止**：在未备份的情况下执行 restore/reset
- ❌ **禁止**：跳过备份步骤
- ❌ **禁止**：假设用户已经备份
- ❌ **禁止**：在备份失败后继续执行restore/reset

#### 工具调用
- backup_essential: 日常备份
- backup_full: 完整备份
- list_backups: 查看备份列表
- delete_backup: 删除旧备份

备份位置: /mnt/data/backups/TRQuant/

## 文件操作优化规则

### 大文件处理
- **避免使用 `write` 工具处理大文件**（>50KB），改用 `cat heredoc` 或直接命令
- **Markdown文件生成**：优先使用 `cat > file << 'EOF'` 方式，避免工具超时
- **批量操作**：使用脚本批量处理，减少工具调用次数

### 性能优化
- **避免频繁的 `read_file`**：只在必要时读取文件
- **使用 `grep` 替代全文读取**：查找内容时优先使用 `grep`
- **批量提交**：积累多个更改后统一提交，减少Git操作频率

## 文件操作性能优化

### 大文件处理策略
- **>30KB的文件**：使用 `cat heredoc` 或 `run_terminal_cmd` 直接写入，避免 `write` 工具超时
- **Markdown文件**：优先使用 `cat > file << 'EOF'` 方式
- **批量操作**：使用脚本批量处理，减少工具调用次数

### 避免卡顿的方法
1. **分批处理**：大文件分段写入
2. **使用命令**：`cat heredoc` 比 `write` 工具更快
3. **异步处理**：长时间操作使用后台任务
4. **减少读取**：只在必要时读取文件，使用 `grep` 查找内容

### 工具选择指南
- **小文件（<10KB）**：可以使用 `write` 工具
- **中等文件（10-30KB）**：优先使用 `cat heredoc`
- **大文件（>30KB）**：必须使用 `cat heredoc` 或脚本
