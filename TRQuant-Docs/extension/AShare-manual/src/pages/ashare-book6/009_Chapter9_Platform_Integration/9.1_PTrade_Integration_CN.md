---
title: "9.1 PTradeé›†æˆ"
description: "æ·±å…¥è§£æPTradeå¹³å°é›†æˆï¼ŒåŒ…æ‹¬APIå°è£…ã€äº¤æ˜“æ¥å£ã€æ•°æ®æ¥å£ã€é£é™©æ§åˆ¶å’Œç­–ç•¥éƒ¨ç½²ï¼Œå®ç°ä¸å›½é‡‘è¯åˆ¸PTradeå¹³å°çš„å®Œæ•´é›†æˆ"
lang: "zh-CN"
layout: "/src/layouts/HandbookLayout.astro"
currentBook: "ashare-book6"
updateDate: "2025-12-12"
---

# ğŸ”Œ 9.1 PTradeé›†æˆ

> **æ ¸å¿ƒæ‘˜è¦ï¼š**
> 
> æœ¬èŠ‚ç³»ç»Ÿä»‹ç»TRQuantç³»ç»Ÿä¸å›½é‡‘è¯åˆ¸PTradeå¹³å°çš„é›†æˆï¼ŒåŒ…æ‹¬PTrade APIå°è£…ã€äº¤æ˜“æ¥å£ã€æ•°æ®æ¥å£ã€é£é™©æ§åˆ¶å’Œç­–ç•¥éƒ¨ç½²ã€‚é€šè¿‡ç†è§£PTradeé›†æˆçš„æ ¸å¿ƒæŠ€æœ¯ï¼Œå¸®åŠ©å¼€å‘è€…æŒæ¡å¦‚ä½•å°†ç»è¿‡BulletTradeå›æµ‹éªŒè¯çš„ç­–ç•¥éƒ¨ç½²åˆ°PTradeå¹³å°ï¼Œå®ç°å®ç›˜äº¤æ˜“å’Œåˆ¸å•†ç¯å¢ƒå›æµ‹ã€‚

PTradeé›†æˆæ˜¯TRQuantç³»ç»Ÿå®ç°å®ç›˜äº¤æ˜“çš„å…³é”®ç¯èŠ‚ï¼Œè´Ÿè´£å°†ç­–ç•¥ä»å†…éƒ¨å›æµ‹ç¯å¢ƒéƒ¨ç½²åˆ°å›½é‡‘è¯åˆ¸çš„PTradeäº¤æ˜“å¹³å°ã€‚

## ğŸ“‹ ç« èŠ‚æ¦‚è§ˆ

<script>
function scrollToSection(sectionId) {
  const element = document.getElementById(sectionId);
  if (element) {
    const headerOffset = 100;
    const elementPosition = element.getBoundingClientRect().top;
    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
    window.scrollTo({
      top: offsetPosition,
      behavior: 'smooth'
    });
  }
}
</script>

<div class="section-overview">
  <div class="section-item" onclick="scrollToSection('section-9-1-1')">
    <h4>ğŸ”Œ 9.1.1 PTradeè¿æ¥</h4>
    <p>è¿æ¥é…ç½®ã€è¿æ¥å»ºç«‹ã€è¿æ¥ç®¡ç†ã€å›½é‡‘è¯åˆ¸é…ç½®</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-9-1-2')">
    <h4>ğŸ’¹ 9.1.2 äº¤æ˜“æ¥å£</h4>
    <p>ä¸‹å•ã€æ’¤å•ã€æŸ¥è¯¢ã€è®¢å•ç®¡ç†</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-9-1-3')">
    <h4>ğŸ“Š 9.1.3 æ•°æ®æ¥å£</h4>
    <p>è¡Œæƒ…æ•°æ®ã€è´¦æˆ·æ•°æ®ã€æŒä»“æ•°æ®</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-9-1-4')">
    <h4>ğŸ›¡ï¸ 9.1.4 é£é™©æ§åˆ¶</h4>
    <p>äº¤æ˜“é£æ§ã€æŒä»“é£æ§ã€å®æ—¶ç›‘æ§</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-9-1-5')">
    <h4>ğŸš€ 9.1.5 ç­–ç•¥éƒ¨ç½²</h4>
    <p>ä»£ç è½¬æ¢ã€ç­–ç•¥ä¸Šä¼ ã€éƒ¨ç½²éªŒè¯ã€ä¸ç¬¬8ç« çš„è¡”æ¥</p>
  </div>
</div>

## ğŸ¯ å­¦ä¹ ç›®æ ‡

é€šè¿‡æœ¬èŠ‚å­¦ä¹ ï¼Œæ‚¨å°†èƒ½å¤Ÿï¼š

- **é…ç½®PTradeè¿æ¥**ï¼šæŒæ¡å›½é‡‘è¯åˆ¸PTradeå¹³å°çš„è¿æ¥é…ç½®æ–¹æ³•
- **ä½¿ç”¨äº¤æ˜“æ¥å£**ï¼šç†è§£ä¸‹å•ã€æ’¤å•ã€æŸ¥è¯¢ç­‰äº¤æ˜“æ¥å£çš„ä½¿ç”¨
- **è·å–æ•°æ®æ¥å£**ï¼šæŒæ¡è¡Œæƒ…æ•°æ®ã€è´¦æˆ·æ•°æ®ã€æŒä»“æ•°æ®çš„è·å–æ–¹æ³•
- **å®ç°é£é™©æ§åˆ¶**ï¼šç†è§£äº¤æ˜“é£æ§å’ŒæŒä»“é£æ§çš„å®ç°æœºåˆ¶
- **éƒ¨ç½²ç­–ç•¥**ï¼šæŒæ¡ä»BulletTradeå›æµ‹åˆ°PTradeéƒ¨ç½²çš„å®Œæ•´æµç¨‹

## ğŸ“š æ ¸å¿ƒæ¦‚å¿µ

### æ¨¡å—å®šä½

- **å·¥ä½œæµä½ç½®**ï¼šæ­¥éª¤8 - ğŸš€ å®ç›˜äº¤æ˜“ï¼ˆåˆ¸å•†å¹³å°éƒ¨ç½²ï¼‰
- **æ ¸å¿ƒèŒè´£**ï¼šPTradeå¹³å°é›†æˆã€ç­–ç•¥éƒ¨ç½²ã€å®ç›˜äº¤æ˜“æ‰§è¡Œ
- **æœåŠ¡å¯¹è±¡**ï¼šç»è¿‡BulletTradeå›æµ‹éªŒè¯çš„ç­–ç•¥

### æŠ€æœ¯æ ˆ

- **äº¤æ˜“å¹³å°**ï¼šå›½é‡‘è¯åˆ¸PTradeï¼ˆæ’ç”Ÿäº¤æ˜“ç³»ç»Ÿï¼‰
- **è¿æ¥æ–¹å¼**ï¼šPTrade APIï¼ˆTCP/IPè¿æ¥ï¼‰
- **ç­–ç•¥æ ¼å¼**ï¼šèšå®½é£æ ¼ â†’ PTradeæ ¼å¼è½¬æ¢
- **æ•°æ®æº**ï¼šPTradeå®æ—¶è¡Œæƒ…ã€è´¦æˆ·æ•°æ®

### ä¸ç¬¬8ç« çš„è¡”æ¥

PTradeé›†æˆæ˜¯ç¬¬8ç« å›æµ‹éªŒè¯çš„åç»­ç¯èŠ‚ï¼š

1. **ç¬¬8ç« **ï¼šåœ¨éŸ¬ç¿ç³»ç»Ÿå†…éƒ¨ä½¿ç”¨BulletTrade+èšå®½æ•°æ®æºè¿›è¡Œå›æµ‹éªŒè¯
2. **ç¬¬9ç« **ï¼šå°†éªŒè¯é€šè¿‡çš„ç­–ç•¥éƒ¨ç½²åˆ°PTradeå¹³å°è¿›è¡Œåˆ¸å•†ç¯å¢ƒå›æµ‹å’Œå®ç›˜äº¤æ˜“

> **è¯¦ç»†æµç¨‹**ï¼šè¯·å‚è€ƒ[ç¬¬8ç« ï¼šå›æµ‹éªŒè¯](/ashare-book6/008_Chapter8_Backtest/8.1_Backtest_Framework_CN)ä¸­çš„"PTrade/QMTå¹³å°éƒ¨ç½²"éƒ¨åˆ†ã€‚

<h2 id="section-9-1-1">ğŸ”Œ 9.1.1 PTradeè¿æ¥</h2>

PTradeè¿æ¥æ˜¯å¹³å°é›†æˆçš„åŸºç¡€ï¼Œè´Ÿè´£å»ºç«‹ä¸å›½é‡‘è¯åˆ¸PTradeå¹³å°çš„è¿æ¥ã€‚

### è¿æ¥é…ç½®

<CodeFromFile 
  filePath="code_library/009_Chapter9_Platform_Integration/9.1/code_9_1_validate.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
from dataclasses import dataclass
from typing import Optional

@dataclass
class PTradeConfig:
    """PTradeè¿æ¥é…ç½®ï¼ˆå›½é‡‘è¯åˆ¸ï¼‰"""
    
    host: str                    # PTradeæœåŠ¡å™¨åœ°å€
    port: int = 7709            # PTradeç«¯å£ï¼ˆé»˜è®¤7709ï¼‰
    account_id: str             # è´¦æˆ·ID
    password: Optional[str] = None  # å¯†ç ï¼ˆå¯é€‰ï¼‰
    strategy_path: str          # ç­–ç•¥æ–‡ä»¶è·¯å¾„
    timeout: int = 30           # è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰
    
    def validate(self) -> Tuple[bool, List[str]]:
        """éªŒè¯é…ç½®"""
        errors = []
        
        if not self.host:
            errors.append("PTradeæœåŠ¡å™¨åœ°å€ä¸èƒ½ä¸ºç©º")
        
        if not self.account_id:
            errors.append("è´¦æˆ·IDä¸èƒ½ä¸ºç©º")<CodeFromFile 
  filePath="code_library/009_Chapter9_Platform_Integration/9.1/code_9_1___init__.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
import socket
import struct
from typing import Dict, Any, Optional
from datetime import datetime

class PTradeConnection:
    """PTradeè¿æ¥ç®¡ç†å™¨ï¼ˆå›½é‡‘è¯åˆ¸ï¼‰"""
    
    def __init__(self, config: PTradeConfig):
        """
        åˆå§‹åŒ–PTradeè¿æ¥
        
        Args:
            config: PTradeé…ç½®
        """
        self.config = config
        self.socket: Optional[socket.socket] = None
        self.connected = False
        self.session_id: Optional[str] = None
    
    def connect(self) -> bool:
        """
        å»ºç«‹PTradeè¿æ¥
        
        Returns:
            bool: è¿æ¥æ˜¯å¦æˆåŠŸ
        """
        try:
            # éªŒè¯é…ç½®
            valid, errors = self.config.validate()
            if not valid:
                raise ValueError(f"é…ç½®é”™è¯¯: {errors}")
            
            # åˆ›å»ºTCPè¿æ¥
            self.socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
            self.socket.settimeout(self.config.timeout)
            
            # è¿æ¥åˆ°PTradeæœåŠ¡å™¨
            self.socket.connect((self.config.host, self.config.port))
            
            # å‘é€ç™»å½•è¯·æ±‚
            login_result = self._login()
            
            if login_result:
                self.connected = True
                self.session_id = self._get_session_id()
                return True
            else:
                self.socket.close()
                self.socket = None
                return False
                
        except Exception as e:
            logger.error(f"PTradeè¿æ¥å¤±è´¥: {e}")
            if self.socket:
                self.socket.close()
                self.socket = None
            return False
    
    def _login(self) -> bool:
        """ç™»å½•PTrade"""
        try:
            # æ„å»ºç™»å½•æ¶ˆæ¯
            login_msg = {
                'action': 'login',
                'account_id': self.config.account_id,
                'password': self.config.password or '',
                'timestamp': datetime.now().isoformat()
            }
            
            # å‘é€ç™»å½•æ¶ˆæ¯
            self._send_message(login_msg)
            
            # æ¥æ”¶ç™»å½•å“åº”
            response = self._receive_message()
            
            if response.get('status') == 'success':
                return True
            else:
                logger.error(f"ç™»å½•å¤±è´¥: {response.get('message')}")
                return False
                
        except Exception as e:
            logger.error(f"ç™»å½•å¼‚å¸¸: {e}")
            return False
    
    def _send_message(self, message: Dict[str, Any]):
        """å‘é€æ¶ˆæ¯åˆ°PTrade"""
        if not self.socket:
            raise ConnectionError("æœªè¿æ¥åˆ°PTradeæœåŠ¡å™¨")
        
        # åºåˆ—åŒ–æ¶ˆæ¯
        msg_bytes = json.dumps(message).encode('utf-8')
        msg_len = len(msg_bytes)
        
        # å‘é€æ¶ˆæ¯é•¿åº¦ï¼ˆ4å­—èŠ‚ï¼‰
        self.socket.send(struct.pack('>I', msg_len))
        # å‘é€æ¶ˆæ¯å†…å®¹
        self.socket.send(msg_bytes)
    
    def _receive_message(self) -> Dict[str, Any]:
        """ä»PTradeæ¥æ”¶æ¶ˆæ¯"""
        if not self.socket:
            raise ConnectionError("æœªè¿æ¥åˆ°PTradeæœåŠ¡å™¨")
        
        # æ¥æ”¶æ¶ˆæ¯é•¿åº¦ï¼ˆ4å­—èŠ‚ï¼‰
        len_bytes = self.socket.recv(4)
        if len(len_bytes) < 4:
            raise ConnectionError("æ¥æ”¶æ¶ˆæ¯é•¿åº¦å¤±è´¥")
        
        msg_len = struct.unpack('>I', len_bytes)[0]
        
        # æ¥æ”¶æ¶ˆæ¯å†…å®¹
        msg_bytes = b''
        while len(msg_bytes) < msg_len:
            chunk = self.socket.recv(msg_len - len(msg_bytes))
            if not chunk:
                raise ConnectionError("æ¥æ”¶æ¶ˆæ¯å†…å®¹å¤±è´¥")
            msg_bytes += chunk
        
        # ååºåˆ—åŒ–æ¶ˆæ¯
        return json.loads(msg_bytes.decode('utf-8'))
    
    def disconnect(self):
        """æ–­å¼€PTradeè¿æ¥"""
        if self.socket:
            try:
                # å‘é€ç™»å‡ºæ¶ˆæ¯
                logout_msg = {
                    'action': 'logout',
                    'session_id': self.session_id
                }
                self._send_message(logout_msg)
            except Exception as e:
                logger.warning(f"ç™»å‡ºå¤±è´¥: {e}")
            finally:
                self.socket.close()
                self.socket = None
                self.connected = False
                self.session_id = None
    
    def is_connected(self) -> bool:
        """æ£€æŸ¥è¿æ¥çŠ¶æ€"""
        return self.connected and self.socket is not None
    
    def _get_ses<CodeFromFile 
  filePath="code_library/009_Chapter9_Platform_Integration/9.1/code_9_1___init__.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
class PTradeConnectionManager:
    """PTradeè¿æ¥ç®¡ç†å™¨"""
    
    def __init__(self):
        self.connections: Dict[str, PTradeConnection] = {}
    
    def get_connection(
        self,
        config: PTradeConfig
    ) -> PTradeConnection:
        """
        è·å–PTradeè¿æ¥ï¼ˆå¤ç”¨æˆ–åˆ›å»ºï¼‰
        
        Args:
            config: PTradeé…ç½®
        
        Returns:
            PTradeConnection: PTradeè¿æ¥å¯¹è±¡
        """
        connection_key = f"{config.host}:{config.port}:{config.account_id}"
        
        if connection_key in self.connections:
            connection = self.connections[connection_key]
            if connection.is_connected():
                return connection
            else:
                # è¿æ¥å·²æ–­å¼€ï¼Œé‡æ–°è¿æ¥
                del self.connections[connection_key]
        
        # åˆ›å»ºæ–°è¿æ¥
        connection = PTradeConnection(config)
        if connection.connect():
            self.connections[connection_key] = connection
            return connection
        else:
            raise ConnectionError("æ— æ³•å»ºç«‹PTradeè¿æ¥")
    
    def close_all(self):
        """å…³é—­æ‰€æœ‰è¿æ¥"""
        for connection in se<CodeFromFile 
  filePath="code_library/009_Chapter9_Platform_Integration/9.1/code_9_1___init__.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
from enum import Enum
from typing import Optional

class OrderType(Enum):
    """è®¢å•ç±»å‹"""
    MARKET = "market"      # å¸‚ä»·å•
    LIMIT = "limit"       # é™ä»·å•
    STOP = "stop"         # æ­¢æŸå•

class OrderSide(Enum):
    """è®¢å•æ–¹å‘"""
    BUY = "buy"           # ä¹°å…¥
    SELL = "sell"         # å–å‡º

@dataclass
class OrderRequest:
    """è®¢å•è¯·æ±‚"""
    symbol: str           # è‚¡ç¥¨ä»£ç 
    side: OrderSide       # ä¹°å–æ–¹å‘
    quantity: int         # æ•°é‡
    order_type: OrderType = OrderType.LIMIT  # è®¢å•ç±»å‹
    price: Optional[float] = None  # ä»·æ ¼ï¼ˆé™ä»·å•å¿…éœ€ï¼‰
    stop_price: Optional[float] = None  # æ­¢æŸä»·ï¼ˆæ­¢æŸå•å¿…éœ€ï¼‰

class PTradeTrader:
    """PTradeäº¤æ˜“æ¥å£"""
    
    def __init__(self, connection: PTradeConnection):
        """
        åˆå§‹åŒ–äº¤æ˜“æ¥å£
        
        Args:
            connection: PTradeè¿æ¥
        """
        self.connection = connection
    
    def submit_order(
        self,
        order_request: OrderRequest
    ) -> Dict[str, Any]:
        """
        æäº¤è®¢å•
        
        Args:
            order_request: è®¢å•è¯·æ±‚
        
        Returns:
            Dict: è®¢å•ç»“æœï¼ˆåŒ…å«order_id, statusç­‰ï¼‰
        """
        if not self.connection.is_connected():
            raise ConnectionError("æœªè¿æ¥åˆ°PTradeæœåŠ¡å™¨")
        
        # æ„å»ºè®¢å•æ¶ˆæ¯
        order_msg = {
            'action': 'submit_order',
            'session_id': self.connection.session_id,
            'symbol': order_request.symbol,
            'side': order_request.side.value,
            'quantity': order_request.quantity,
            'order_type': order_request.order_type.value,
            'price': order_request.price,
            'stop_price': order_request.stop_price,
            'timestamp': datetime.now().isoformat()
        }
        
        # å‘é€è®¢å•æ¶ˆæ¯
        self.connection._send_message(order_msg)
        
        # æ¥æ”¶è®¢å•å“åº”
        response = self.connection._receive_message()
        
        if response.get('status') == 'success':
            return {
                'order_id': response.get('order_id'),
                'status': 'submitted',
                'message': 'è®¢å•æäº¤æˆåŠŸ'
            }
        else:
            raise ValueError(f"è®¢å•æäº¤å¤±è´¥: {response.get('message')}")
    
    def cancel_order(
        self,
        order_id: str
    ) -> Dict[str, Any]:
        """
        æ’¤é”€è®¢å•
        
        Args:
            order_id: è®¢å•ID
        
        Returns:
            Dict: æ’¤å•ç»“æœ
        """
        if not self.connection.is_connected():
            raise ConnectionError("æœªè¿æ¥åˆ°PTradeæœåŠ¡å™¨")
        
        # æ„å»ºæ’¤å•æ¶ˆæ¯
        cancel_msg = {
            'action': 'cancel_order',
            'session_id': self.connection.session_id,
            'order_id': order_id,
            'timestamp': datetime.now().isoformat()
        }
        
        # å‘é€æ’¤å•æ¶ˆæ¯
        self.connection._send_message(cancel_msg)
        
        # æ¥æ”¶æ’¤å•å“åº”
        response = self.connection._receive_message()
        
        if response.get('status') == 'success':
            return {
                'order_id': order_id,
                'status': 'cancelled',
                'message': 'è®¢å•æ’¤é”€æˆåŠŸ'
            }
        else:
            raise ValueError(f"è®¢å•æ’¤é”€å¤±è´¥: {response.get('message')}")
    
    def query_order(
        self,
        order_id: Optional[str] = None
    ) -> List[Dict[str, Any]]:
        """
        æŸ¥è¯¢è®¢å•
        
        Args:
            order_id: è®¢å•IDï¼ˆå¯é€‰ï¼Œä¸æä¾›åˆ™æŸ¥è¯¢æ‰€æœ‰è®¢å•ï¼‰
        
        Returns:
            List[Dict]: è®¢å•åˆ—è¡¨
        """
        if not self.connection.is_connected():
            raise ConnectionError("æœªè¿æ¥åˆ°PTradeæœåŠ¡å™¨")
        
        # æ„å»ºæŸ¥è¯¢æ¶ˆæ¯
        query_msg = {
            'action': 'query_order',
            'session_id': self.connection.session_id,
            'order_id': order_id,
            'timestamp': datetime.now().isoformat()
        }
        
        # å‘é€æŸ¥è¯¢æ¶ˆæ¯
        self.connection._send_message(query_msg)
        
        # æ¥æ”¶æŸ¥è¯¢å“åº”
        response = self.connection._receive_message()
        
        if response.get('status') == 'success':
            return response.get('orders',<CodeFromFile 
  filePath="code_library/009_Chapter9_Platform_Integration/9.1/code_9_1___init__.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
class PTradeDataProvider:
    """PTradeæ•°æ®æä¾›è€…"""
    
    def __init__(self, connection: PTradeConnection):
        """
        åˆå§‹åŒ–æ•°æ®æä¾›è€…
        
        Args:
            connection: PTradeè¿æ¥
        """
        self.connection = connection
    
    def get_market_data(
        self,
        symbols: List[str],
        fields: List[str] = None
    ) -> pd.DataFrame:
        """
        è·å–è¡Œæƒ…æ•°æ®
        
        Args:
            symbols: è‚¡ç¥¨ä»£ç åˆ—è¡¨
            fields: å­—æ®µåˆ—è¡¨ï¼ˆå¯é€‰ï¼Œé»˜è®¤æ‰€æœ‰å­—æ®µï¼‰
        
        Returns:
            pd.DataFrame: è¡Œæƒ…æ•°æ®
        """
        if not self.connection.is_connected():
            raise ConnectionError("æœªè¿æ¥åˆ°PTradeæœåŠ¡å™¨")
        
        # æ„å»ºæŸ¥è¯¢æ¶ˆæ¯
        query_msg = {
            'action': 'get_market_data',
            'session_id': self.connection.session_id,
            'symbols': symbols,
            'fields': fields or ['open', 'high', 'low', 'close', 'volume'],
            'timestamp': datetime.now().isoformat()
        }
        
        # å‘é€æŸ¥è¯¢æ¶ˆæ¯
        self.connection._send_message(query_msg)
        
        # æ¥æ”¶æŸ¥è¯¢å“åº”
        response = self.connection._receive_message()
        
        if response.get('status') == 'success':
            data = response.get('data', [])
            return pd.DataFrame(data)
        else:
            raise ValueError(f"è¡Œæƒ…æ•°æ®è·å–å¤±è´¥: {response.get('message')}")
    
    def get_account_info(self) -> Dict[str, Any]:
        """
        è·å–è´¦æˆ·ä¿¡æ¯
        
        Returns:
            Dict: è´¦æˆ·ä¿¡æ¯
        """
        if not self.connection.is_connected():
            raise ConnectionError("æœªè¿æ¥åˆ°PTradeæœåŠ¡å™¨")
        
        # æ„å»ºæŸ¥è¯¢æ¶ˆæ¯
        query_msg = {
            'action': 'get_account_info',
            'session_id': self.connection.session_id,
            'timestamp': datetime.now().isoformat()
        }
        
        # å‘é€æŸ¥è¯¢æ¶ˆæ¯
        self.connection._send_message(query_msg)
        
        # æ¥æ”¶æŸ¥è¯¢å“åº”
        response = self.connection._receive_message()
        
        if response.get('status') == 'success':
            return response.get('account_info', {})
        else:
            raise ValueError(f"è´¦æˆ·ä¿¡æ¯è·å–å¤±è´¥: {response.get('message')}")
    
    def get_positions(self) -> pd.DataFrame:
        """
        è·å–æŒä»“ä¿¡æ¯
        
        Returns:
            pd.DataFrame: æŒä»“æ•°æ®
        """
        if not self.connection.is_connected():
            raise ConnectionError("æœªè¿æ¥åˆ°PTradeæœåŠ¡å™¨")
        
        # æ„å»ºæŸ¥è¯¢æ¶ˆæ¯
        query_msg = {
            'action': 'get_positions',
            'session_id': self.connection.session_id,
            'timestamp': datetime.now().isoformat()
        }
        
        # å‘é€æŸ¥è¯¢æ¶ˆæ¯
        self.connection._send_message(query_msg)
        
        # æ¥æ”¶æŸ¥è¯¢å“åº”
        response = self.connection._receive_message()
        
        if response.get('status') == 'success':
            data = response.get('positions', [])
            return pd.DataFrame<CodeFromFile 
  filePath="code_library/009_Chapter9_Platform_Integration/9.1/code_9_1___init__.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
@dataclass
class RiskControlConfig:
    """é£é™©æ§åˆ¶é…ç½®"""
    max_position_ratio: float = 0.1      # å•ç¥¨æœ€å¤§ä»“ä½æ¯”ä¾‹
    max_total_position: float = 0.95     # æ€»ä»“ä½ä¸Šé™
    max_daily_loss: float = 0.05         # å•æ—¥æœ€å¤§äºæŸæ¯”ä¾‹
    min_price: float = 0.01              # æœ€å°ä»·æ ¼
    max_price: float = 1000.0            # æœ€å¤§ä»·æ ¼

class PTradeRiskController:
    """PTradeé£é™©æ§åˆ¶å™¨"""
    
    def __init__(
        self,
        connection: PTradeConnection,
        config: RiskControlConfig
    ):
        """
        åˆå§‹åŒ–é£é™©æ§åˆ¶å™¨
        
        Args:
            connection: PTradeè¿æ¥
            config: é£é™©æ§åˆ¶é…ç½®
        """
        self.connection = connection
        self.config = config
        self.data_provider = PTradeDataProvider(connection)
    
    def check_order_risk(
        self,
        order_request: OrderRequest
    ) -> Tuple[bool, str]:
        """
        æ£€æŸ¥è®¢å•é£é™©
        
        Args:
            order_request: è®¢å•è¯·æ±‚
        
        Returns:
            Tuple[bool, str]: (æ˜¯å¦é€šè¿‡, é”™è¯¯ä¿¡æ¯)
        """
        # 1. æ£€æŸ¥ä»·æ ¼èŒƒå›´
        if order_request.price:
            if order_request.price < self.config.min_price:
                return False, f"ä»·æ ¼ä½äºæœ€å°å€¼: {order_request.price}"
            if order_request.price > self.config.max_price:
                return False, f"ä»·æ ¼é«˜äºæœ€å¤§å€¼: {order_request.price}"
        
        # 2. è·å–è´¦æˆ·ä¿¡æ¯
        account_info = self.data_provider.get_account_info()
        total_value = account_info.get('total_value', 0)
        available_cash = account_info.get('available_cash', 0)
        
        # 3. æ£€æŸ¥å•ç¥¨ä»“ä½
        if order_request.side == OrderSide.BUY:
            order_value = order_request.quantity * (order_request.price or 0)
            position_ratio = order_value / total_value if total_value > 0 else 0
            
            if position_ratio > self.config.max_position_ratio:
                return False, f"å•ç¥¨ä»“ä½è¶…è¿‡é™åˆ¶: {position_ratio:.2%}"
            
            if order_value > available_cash:
                return False, f"å¯ç”¨èµ„é‡‘ä¸è¶³: {available_cash:.2f}"
        
        # 4. æ£€æŸ¥æ€»ä»“ä½
        positions = self.data_provider.get_positions()
        total_position_value = positions['market_value'].sum() if not positions.empty else 0
        total_position_ratio = total_position_value / total_value if total_value > 0 else 0
        
        if total_position_ratio > self.config.max_total_position:
            return False, f"æ€»ä»“ä½è¶…è¿‡é™åˆ¶: {total_position_ratio:.2%}"
        
        return True, "é£é™©æ£€æŸ¥é€šè¿‡"
```
-->OrderSide.BUY:
            order_value = order_request.quantity * (order_request.price or 0)
            position_ratio = order_va<CodeFromFile 
  filePath="code_library/009_Chapter9_Platform_Integration/9.1/code_9_1___init__.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
from core.strategy_converter import StrategyCodeConverter

class PTradeStrategyDeployer:
    """PTradeç­–ç•¥éƒ¨ç½²å™¨"""
    
    def __init__(self, connection: PTradeConnection):
        """
        åˆå§‹åŒ–ç­–ç•¥éƒ¨ç½²å™¨
        
        Args:
            connection: PTradeè¿æ¥
        """
        self.connection = connection
        self.converter = StrategyCodeConverter()
    
    def deploy_strategy(
        self,
        jq_strategy_path: str,
        strategy_name: str
    ) -> Dict[str, Any]:
        """
        éƒ¨ç½²ç­–ç•¥åˆ°PTradeå¹³å°
        
        Args:
            jq_strategy_path: èšå®½é£æ ¼ç­–ç•¥ä»£ç è·¯å¾„
            strategy_name: ç­–ç•¥åç§°
        
        Returns:
            Dict: éƒ¨ç½²ç»“æœ
        """
        # 1. è¯»å–èšå®½é£æ ¼ç­–ç•¥ä»£ç 
        with open(jq_strategy_path, 'r', encoding='utf-8') as f:
            jq_code = f.read()
        
        # 2. è½¬æ¢ä¸ºPTradeæ ¼å¼
        ptrade_code = self.converter.convert_to_ptrade(jq_code)
        
        # 3. ä¿å­˜PTradeæ ¼å¼ä»£ç 
        ptrade_strategy_path = jq_strategy_path.replace('.py', '_ptrade.py')
        with open(ptrade_strategy_path, 'w', encoding='utf-8') as f:
            f.write(ptrade_code)
        
        # 4. ä¸Šä¼ åˆ°PTradeå¹³å°
        upload_result = self._upload_to_ptrade(
            ptrade_strategy_path,
            strategy_name
        )
        
        return {
            'strategy_name': strategy_name,
            'ptrade_code_path': ptrade_strategy_path,
            'upload_result': upload_result
        }
    
    def _upload_to_ptrade(
        self,
        strategy_path: str,
        strategy_name: str
    ) -> Dict[str, Any]:
        """ä¸Šä¼ ç­–ç•¥åˆ°PTradeå¹³å°"""
        # è¯»å–ç­–ç•¥ä»£ç 
        with open(strategy_path, 'r', encoding='utf-8') as f:
            strategy_code = f.read()
        
        # æ„å»ºä¸Šä¼ æ¶ˆæ¯
        upload_msg = {
            'action': 'upload_strategy',
            'session_id': self.connection.session_id,
            'strategy_name': strategy_name,
            'strategy_code': strategy_code,
            'timestamp': datetime.now().isoformat()
        }
        
        # å‘é€ä¸Šä¼ æ¶ˆæ¯
        self.connection._send_message(upload_msg)
        
        # æ¥æ”¶ä¸Šä¼ å“åº”
        response = self.connection._receive_message()
        
        if response.get('status') == 'success':
            return {
                'success': True,
                'strategy_id': response.get('strategy_id'),
                'message': 'ç­–ç•¥ä¸Šä¼ æˆåŠŸ'
            }
        else:
<CodeFromFile 
  filePath="code_library/009_Chapter9_Platform_Integration/9.1/code_9_1_ptrade_deployment_workflow.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
def ptrade_deployment_workflow(
    jq_strategy_path: str,
    strategy_name: str,
    ptrade_config: PTradeConfig
) -> Dict[str, Any]:
    """
    PTradeéƒ¨ç½²å®Œæ•´å·¥ä½œæµ
    
    1. å»ºç«‹PTradeè¿æ¥
    2. è½¬æ¢ç­–ç•¥ä»£ç ï¼ˆèšå®½é£æ ¼ â†’ PTradeæ ¼å¼ï¼‰
    3. ä¸Šä¼ ç­–ç•¥åˆ°PTradeå¹³å°
    4. éªŒè¯éƒ¨ç½²ç»“æœ
    
    Args:
        jq_strategy_path: èšå®½é£æ ¼ç­–ç•¥ä»£ç è·¯å¾„
        strategy_name: ç­–ç•¥åç§°
        ptrade_config: PTradeé…ç½®
    
    Returns:
        Dict: éƒ¨ç½²ç»“æœ
    """
    # 1. å»ºç«‹PTradeè¿æ¥
    connection = PTradeConnection(ptrade_config)
    if not connection.connect():
        raise ConnectionError("æ— æ³•è¿æ¥åˆ°PTradeå¹³å°")
    
    try:
        # 2. åˆ›å»ºç­–ç•¥éƒ¨ç½²å™¨
        deployer = PTradeStrategyDeployer(connection)
        
        # 3. éƒ¨ç½²ç­–ç•¥
        deployment_result = deployer.deploy_strategy(
            jq_strategy_path,
            strategy_name
        )
        
        return {
            'success': True,
            'deployment_result': deployment_result
        }
    finally:
        # 4. æ–­å¼€è¿æ¥
        connection.disconnect()
```
-->('strategy_id'),
                'message': 'ç­–ç•¥ä¸Šä¼ æˆåŠŸ'
            }
        else:
            return {
                'success': False,
                'error': response.get('message'),
                'message': 'ç­–ç•¥ä¸Šä¼ å¤±è´¥'
            }
```

### å®Œæ•´éƒ¨ç½²å·¥ä½œæµ

```python
def ptrade_deployment_workflow(
    jq_strategy_path: str,
    strategy_name: str,
    ptrade_config: PTradeConfig
) -> Dict[str, Any]:
    """
    PTradeéƒ¨ç½²å®Œæ•´å·¥ä½œæµ
    
    1. å»ºç«‹PTradeè¿æ¥
    2. è½¬æ¢ç­–ç•¥ä»£ç ï¼ˆèšå®½é£æ ¼ â†’ PTradeæ ¼å¼ï¼‰
    3. ä¸Šä¼ ç­–ç•¥åˆ°PTradeå¹³å°
    4. éªŒè¯éƒ¨ç½²ç»“æœ
    
    Args:
        jq_strategy_path: èšå®½é£æ ¼ç­–ç•¥ä»£ç è·¯å¾„
        strategy_name: ç­–ç•¥åç§°
        ptrade_config: PTradeé…ç½®
    
    Returns:
        Dict: éƒ¨ç½²ç»“æœ
    """
    # 1. å»ºç«‹PTradeè¿æ¥
    connection = PTradeConnection(ptrade_config)
    if not connection.connect():
        raise ConnectionError("æ— æ³•è¿æ¥åˆ°PTradeå¹³å°")
    
    try:
        # 2. åˆ›å»ºç­–ç•¥éƒ¨ç½²å™¨
        deployer = PTradeStrategyDeployer(connection)
        
        # 3. éƒ¨ç½²ç­–ç•¥
        deployment_result = deployer.deploy_strategy(
            jq_strategy_path,
            strategy_name
        )
        
        return {
            'success': True,
            'deployment_result': deployment_result
        }
    finally:
        # 4. æ–­å¼€è¿æ¥
        connection.disconnect()
```

## ğŸ”— ç›¸å…³ç« èŠ‚

- **ç¬¬7ç« ï¼šç­–ç•¥å¼€å‘**ï¼šäº†è§£ç­–ç•¥å¼€å‘å’Œæµ‹è¯•æµç¨‹
- **ç¬¬8ç« ï¼šå›æµ‹éªŒè¯**ï¼šäº†è§£BulletTradeå›æµ‹å’ŒPTrade/QMTéƒ¨ç½²æµç¨‹
- **9.2 QMTé›†æˆ**ï¼šäº†è§£QMTå¹³å°é›†æˆ

## ğŸ’¡ å…³é”®è¦ç‚¹

1. **è¿æ¥ç®¡ç†**ï¼šæ­£ç¡®é…ç½®å’Œå»ºç«‹PTradeè¿æ¥æ˜¯é›†æˆçš„åŸºç¡€
2. **äº¤æ˜“æ¥å£**ï¼šæŒæ¡ä¸‹å•ã€æ’¤å•ã€æŸ¥è¯¢ç­‰äº¤æ˜“æ¥å£çš„ä½¿ç”¨
3. **æ•°æ®æ¥å£**ï¼šç†è§£è¡Œæƒ…æ•°æ®ã€è´¦æˆ·æ•°æ®ã€æŒä»“æ•°æ®çš„è·å–æ–¹æ³•
4. **é£é™©æ§åˆ¶**ï¼šå®ç°äº¤æ˜“é£æ§å’ŒæŒä»“é£æ§ï¼Œç¡®ä¿äº¤æ˜“å®‰å…¨
5. **ç­–ç•¥éƒ¨ç½²**ï¼šæŒæ¡ä»BulletTradeå›æµ‹åˆ°PTradeéƒ¨ç½²çš„å®Œæ•´æµç¨‹

## ğŸ”® æ€»ç»“ä¸å±•æœ›

<div class="summary-outlook">
  <h3>æœ¬èŠ‚å›é¡¾</h3>
  <p>æœ¬èŠ‚ç³»ç»Ÿä»‹ç»äº†PTradeå¹³å°é›†æˆï¼ŒåŒ…æ‹¬PTradeè¿æ¥ã€äº¤æ˜“æ¥å£ã€æ•°æ®æ¥å£ã€é£é™©æ§åˆ¶å’Œç­–ç•¥éƒ¨ç½²ã€‚é€šè¿‡ç†è§£PTradeé›†æˆçš„æ ¸å¿ƒæŠ€æœ¯ï¼Œå¸®åŠ©å¼€å‘è€…æŒæ¡å¦‚ä½•å°†ç»è¿‡BulletTradeå›æµ‹éªŒè¯çš„ç­–ç•¥éƒ¨ç½²åˆ°å›½é‡‘è¯åˆ¸PTradeå¹³å°ï¼Œå®ç°å®ç›˜äº¤æ˜“å’Œåˆ¸å•†ç¯å¢ƒå›æµ‹ã€‚</p>
  
  <h3>ä¸‹èŠ‚é¢„å‘Š</h3>
  <p>æŒæ¡äº†PTradeé›†æˆåï¼Œä¸‹ä¸€èŠ‚å°†ä»‹ç»QMTé›†æˆï¼ŒåŒ…æ‹¬QMTè¿æ¥ã€äº¤æ˜“æ¥å£ã€æ•°æ®æ¥å£ã€é£é™©æ§åˆ¶å’Œç­–ç•¥éƒ¨ç½²ã€‚é€šè¿‡ç†è§£QMTé›†æˆçš„æ ¸å¿ƒæŠ€æœ¯ï¼Œå¸®åŠ©å¼€å‘è€…æŒæ¡å¦‚ä½•å°†ç­–ç•¥éƒ¨ç½²åˆ°å›½é‡‘è¯åˆ¸QMTå¹³å°ã€‚</p>
  
  <a href="/ashare-book6/009_Chapter9_Platform_Integration/9.2_QMT_Integration_CN" class="next-section">
    ç»§ç»­å­¦ä¹ ï¼š9.2 QMTé›†æˆ â†’
  </a>
</div>

> **é€‚ç”¨ç‰ˆæœ¬**: v1.0.0+  
> **æœ€åæ›´æ–°**: 2025-12-12
