---
title: "10.7 MCPæœåŠ¡å™¨å¼€å‘æŒ‡å—"
description: "æ·±å…¥è§£æTRQuant MCPæœåŠ¡å™¨å¼€å‘ï¼ŒåŒ…æ‹¬MCPåè®®åŸºç¡€ã€æœåŠ¡å™¨æ¶æ„ã€å·¥å…·å¼€å‘ã€èµ„æºç®¡ç†ã€æç¤ºæ¨¡æ¿ç­‰æ ¸å¿ƒæŠ€æœ¯ï¼Œä¸ºMCPå·¥å…·å¼€å‘æä¾›å®Œæ•´çš„å¼€å‘æŒ‡å¯¼"
lang: "zh-CN"
layout: "/src/layouts/HandbookLayout.astro"
currentBook: "ashare-book6"
updateDate: "2025-12-12"
---

# ğŸ”§ 10.7 MCPæœåŠ¡å™¨å¼€å‘æŒ‡å—

> **æ ¸å¿ƒæ‘˜è¦ï¼š**
> 
> æœ¬èŠ‚ç³»ç»Ÿä»‹ç»TRQuant MCPæœåŠ¡å™¨å¼€å‘ï¼ŒåŒ…æ‹¬MCPåè®®åŸºç¡€ã€æœåŠ¡å™¨æ¶æ„ã€å·¥å…·å¼€å‘ã€èµ„æºç®¡ç†ã€æç¤ºæ¨¡æ¿ç­‰æ ¸å¿ƒæŠ€æœ¯ã€‚é€šè¿‡ç†è§£MCP Serverå¼€å‘çš„å®Œæ•´æ–¹æ³•ï¼Œå¸®åŠ©å¼€å‘è€…æŒæ¡MCPå·¥å…·çš„å¼€å‘æŠ€å·§ï¼Œä¸ºæ„å»ºä¸“ä¸šçº§çš„AIå·¥å…·é“¾å¥ å®šåŸºç¡€ã€‚

MCP (Model Context Protocol) æ˜¯Anthropicå¼€å‘çš„å¼€æ”¾åè®®ï¼Œç”¨äºAIåŠ©æ‰‹ä¸å¤–éƒ¨å·¥å…·å’Œæ•°æ®æºçš„å®‰å…¨äº¤äº’ã€‚TRQuantç³»ç»Ÿé€šè¿‡MCPæœåŠ¡å™¨å°†æ ¸å¿ƒåŠŸèƒ½æš´éœ²ç»™Cursor AIï¼Œå®ç°æ™ºèƒ½åŒ–çš„å¼€å‘è¾…åŠ©ã€‚

## ğŸ“‹ ç« èŠ‚æ¦‚è§ˆ

<script>
function scrollToSection(sectionId) {
  const element = document.getElementById(sectionId);
  if (element) {
    const headerOffset = 100;
    const elementPosition = element.getBoundingClientRect().top;
    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
    window.scrollTo({
      top: offsetPosition,
      behavior: 'smooth'
    });
  }
}
</script>

<div class="section-overview">
  <div class="section-item" onclick="scrollToSection('section-10-7-1')">
    <h4>ğŸ“š 10.7.1 MCPåè®®åŸºç¡€</h4>
    <p>åè®®æ¦‚è¿°ã€æ ¸å¿ƒæ¦‚å¿µã€é€šä¿¡åè®®ã€ä¼ è¾“æ–¹å¼</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-10-7-2')">
    <h4>ğŸ—ï¸ 10.7.2 æœåŠ¡å™¨æ¶æ„</h4>
    <p>æœåŠ¡å™¨åˆ†ç±»ã€æ¶æ„è®¾è®¡ã€é€šä¿¡æµç¨‹ã€å·¥å…·æ³¨å†Œ</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-10-7-3')">
    <h4>ğŸ› ï¸ 10.7.3 å·¥å…·å¼€å‘</h4>
    <p>å·¥å…·å®šä¹‰ã€å‚æ•°éªŒè¯ã€é”™è¯¯å¤„ç†ã€å·¥å…·ç±»å‹</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-10-7-4')">
    <h4>ğŸ“¦ 10.7.4 èµ„æºç®¡ç†</h4>
    <p>èµ„æºå®šä¹‰ã€èµ„æºè®¿é—®ã€èµ„æºç±»å‹ã€èµ„æºç¼“å­˜</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-10-7-5')">
    <h4>ğŸ’¬ 10.7.5 æç¤ºæ¨¡æ¿</h4>
    <p>æç¤ºå®šä¹‰ã€æ¨¡æ¿å˜é‡ã€æ¨¡æ¿æ¸²æŸ“ã€æç¤ºç®¡ç†</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-10-7-6')">
    <h4>ğŸ”§ 10.7.6 é…ç½®ä¸éƒ¨ç½²</h4>
    <p>Cursoré…ç½®ã€ç¯å¢ƒå˜é‡ã€ä¾èµ–ç®¡ç†ã€è°ƒè¯•æŠ€å·§</p>
  </div>
</div>

## ğŸ¯ å­¦ä¹ ç›®æ ‡

é€šè¿‡æœ¬èŠ‚å­¦ä¹ ï¼Œæ‚¨å°†èƒ½å¤Ÿï¼š

- **ç†è§£MCPåè®®**ï¼šæŒæ¡MCPåè®®çš„æ ¸å¿ƒæ¦‚å¿µå’Œé€šä¿¡æœºåˆ¶
- **è®¾è®¡æœåŠ¡å™¨æ¶æ„**ï¼šç†è§£MCPæœåŠ¡å™¨çš„æ¶æ„è®¾è®¡å’Œå®ç°æ–¹æ³•
- **å¼€å‘MCPå·¥å…·**ï¼šæŒæ¡å·¥å…·å®šä¹‰ã€å‚æ•°éªŒè¯ã€é”™è¯¯å¤„ç†ç­‰å¼€å‘æŠ€å·§
- **ç®¡ç†èµ„æº**ï¼šç†è§£èµ„æºå®šä¹‰ã€è®¿é—®å’Œç®¡ç†æ–¹æ³•
- **ä½¿ç”¨æç¤ºæ¨¡æ¿**ï¼šæŒæ¡æç¤ºæ¨¡æ¿çš„å®šä¹‰å’Œä½¿ç”¨æ–¹æ³•
- **é…ç½®ä¸éƒ¨ç½²**ï¼šæŒæ¡MCPæœåŠ¡å™¨çš„é…ç½®å’Œéƒ¨ç½²æµç¨‹

## ğŸ“š æ ¸å¿ƒæ¦‚å¿µ

### MCPåè®®

- **åè®®ç‰ˆæœ¬**ï¼š2024-11-05
- **é€šä¿¡æ–¹å¼**ï¼šJSON-RPC 2.0 over stdio/HTTP/SSE
- **æ ¸å¿ƒç»„ä»¶**ï¼šServerã€Toolsã€Resourcesã€Prompts

### æœåŠ¡å™¨ç±»å‹

- **ä¸šåŠ¡æœåŠ¡å™¨**ï¼šæä¾›TRQuantæ ¸å¿ƒåŠŸèƒ½ï¼ˆå¸‚åœºçŠ¶æ€ã€ä¸»çº¿è¯†åˆ«ã€å› å­æ¨èç­‰ï¼‰
- **çŸ¥è¯†åº“æœåŠ¡å™¨**ï¼šæä¾›çŸ¥è¯†åº“æ£€ç´¢å’ŒæŸ¥è¯¢åŠŸèƒ½
- **æ•°æ®æ”¶é›†æœåŠ¡å™¨**ï¼šæä¾›æ•°æ®æ”¶é›†å·¥å…·ï¼ˆç½‘é¡µçˆ¬è™«ã€PDFä¸‹è½½ç­‰ï¼‰

### å·¥å…·å®šä¹‰

- **å·¥å…·åç§°**ï¼šéµå¾ªå‘½åè§„èŒƒï¼ˆå¦‚ `trquant_market_status`ï¼‰
- **è¾“å…¥æ¨¡å¼**ï¼šJSON Schemaå®šä¹‰å‚æ•°ç»“æ„
- **è¿”å›å€¼**ï¼šæ ‡å‡†åŒ–çš„JSONæ ¼å¼

<h2 id="section-10-7-1">ğŸ“š 10.7.1 MCPåè®®åŸºç¡€</h2>

MCP (Model Context Protocol) æ˜¯Anthropicå¼€å‘çš„å¼€æ”¾åè®®ï¼Œç”¨äºAIåŠ©æ‰‹ä¸å¤–éƒ¨å·¥å…·å’Œæ•°æ®æºçš„å®‰å…¨äº¤äº’ã€‚

### åè®®æ¦‚è¿°

MCPåè®®çš„æ ¸å¿ƒç›®æ ‡ï¼š

- **æ ‡å‡†åŒ–äº¤äº’**ï¼šä¸ºAIåŠ©æ‰‹ä¸å¤–éƒ¨å·¥å…·æä¾›ç»Ÿä¸€çš„äº¤äº’æ¥å£
- **å®‰å…¨æ§åˆ¶**ï¼šé€šè¿‡æƒé™ç®¡ç†ç¡®ä¿æ•°æ®å®‰å…¨
- **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒè‡ªå®šä¹‰å·¥å…·å’Œèµ„æº
- **è·¨å¹³å°**ï¼šæ”¯æŒå¤šç§ç¼–ç¨‹è¯­è¨€å’Œå¹³å°

### æ ¸å¿ƒæ¦‚å¿µ

#### æœåŠ¡å™¨ï¼ˆServerï¼‰

MCPæœåŠ¡å™¨æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼Œæä¾›å·¥å…·å’Œèµ„æºï¼š

```python
# MCPæœåŠ¡å™¨åŸºæœ¬ç»“æ„
class MCPServer:
    """MCPæœåŠ¡å™¨åŸºç±»"""
    
    def __init__(self):
        self.name = "my-server"
        self.version = "1.0.0"
        self.tools = []  # å·¥å…·åˆ—è¡¨
        self.resources = []  # èµ„æºåˆ—è¡¨
    
    def list_tools(self) -> List[Dict]:
        """åˆ—å‡ºæ‰€æœ‰å¯ç”¨å·¥å…·"""
        return self.tools
    
    async def call_tool(self, name: str, arguments: Dict) -> Dict:
        """è°ƒç”¨å·¥å…·"""
        pass
```

#### å·¥å…·ï¼ˆToolsï¼‰

å·¥å…·æ˜¯æœåŠ¡å™¨æä¾›çš„å¯è°ƒç”¨åŠŸèƒ½ï¼š

```python
# å·¥å…·å®šä¹‰ç¤ºä¾‹
tool = {
    "name": "trquant_market_status",
    "description": "è·å–Aè‚¡å¸‚åœºå½“å‰çŠ¶æ€ï¼ŒåŒ…æ‹¬å¸‚åœºRegimeã€æŒ‡æ•°è¶‹åŠ¿å’Œé£æ ¼è½®åŠ¨",
    "inputSchema": {
        "type": "object",
        "properties": {
            "universe": {
                "type": "string",
                "description": "å¸‚åœºï¼Œé»˜è®¤CN_EQè¡¨ç¤ºAè‚¡",
                "default": "CN_EQ"
            }
        },
        "required": []
    }
}
```

#### èµ„æºï¼ˆResourcesï¼‰

èµ„æºæ˜¯æœåŠ¡å™¨æä¾›çš„å¯è®¿é—®æ•°æ®ï¼š

```python
# èµ„æºå®šä¹‰ç¤ºä¾‹
resource = {
    "uri": "file:///path/to/data",
    "name": "æ•°æ®æ–‡ä»¶",
    "description": "æ•°æ®æ–‡ä»¶èµ„æº",
    "mimeType": "text/plain"
}
```

### é€šä¿¡åè®®

MCPä½¿ç”¨JSON-RPC 2.0åè®®è¿›è¡Œé€šä¿¡ï¼š

```json
// è¯·æ±‚æ ¼å¼
{
    "jsonrpc": "2.0",
    "id": 1,
    "method": "tools/call",
    "params": {
        "name": "trquant_market_status",
        "arguments": {
            "universe": "CN_EQ"
        }
    }
}

// å“åº”æ ¼å¼
{
    "jsonrpc": "2.0",
    "id": 1,
    "result": {
        "content": [
            {
                "type": "text",
                "text": "{\"regime\": \"neutral\", \"index_trend\": {...}}"
            }
        ]
    }
}
```

### ä¼ è¾“æ–¹å¼

MCPæ”¯æŒå¤šç§ä¼ è¾“æ–¹å¼ï¼š

1. **stdio**ï¼šæ ‡å‡†è¾“å…¥è¾“å‡ºï¼ˆæœ€å¸¸ç”¨ï¼ŒTRQuantä½¿ç”¨æ­¤æ–¹å¼ï¼‰
2. **HTTP**ï¼šHTTPè¯·æ±‚/å“åº”
3. **SSE**ï¼šServer-Sent Events

<h2 id="section-10-7-2">ğŸ—ï¸ 10.7.2 æœåŠ¡å™¨æ¶æ„</h2>

TRQuantç³»ç»ŸåŒ…å«å¤šä¸ªMCPæœåŠ¡å™¨ï¼Œæ¯ä¸ªæœåŠ¡å™¨è´Ÿè´£ç‰¹å®šçš„åŠŸèƒ½é¢†åŸŸã€‚

### æœåŠ¡å™¨åˆ†ç±»

```
mcp_servers/
â”œâ”€â”€ kb_server.py              # çŸ¥è¯†åº“æœåŠ¡å™¨
â”œâ”€â”€ data_collector_server.py  # æ•°æ®æ”¶é›†æœåŠ¡å™¨
â””â”€â”€ extension/python/
    â””â”€â”€ mcp_server.py         # TRQuantä¸šåŠ¡æœåŠ¡å™¨
```

### ä¸šåŠ¡æœåŠ¡å™¨æ¶æ„

```python
# extension/python/mcp_server.py
from dataclasses import dataclass
from typing import List, Dict, Any

@dataclass
class MCPTool:
    """MCPå·¥å…·å®šä¹‰"""
    name: str
    description: str
    input_schema: dict

class MCPServer:
    """MCP Serverå®ç°"""
    
    def __init__(self):
        self.orchestrator = get_workflow_orchestrator() if TRQUANT_AVAILABLE else None
        logger.info(f"MCP Serveråˆå§‹åŒ–, TRQuantå¯ç”¨: {TRQUANT_AVAILABLE}")
    
    def list_tools(self) -> List[dict]:
        """åˆ—å‡ºæ‰€æœ‰å¯ç”¨å·¥å…·"""
        return [
            {
                "name": tool.name,
                "description": tool.description,
                "inputSchema": tool.input_schema
            }
            for tool in MCP_TOOLS
        ]
    
    async def call_tool(self, name: str, arguments: dict) -> dict:
        """è°ƒç”¨å·¥å…·"""
        logger.info(f"è°ƒç”¨å·¥å…·: {name}")
        
        handlers = {
            "trquant_market_status": self._get_market_status,
            "trquant_mainlines": self._get_mainlines,
            "trquant_recommend_factors": self._recommend_factors,
            "trquant_generate_strategy": self._generate_strategy,
            "trquant_analyze_backtest": self._analyze_backtest
        }
        
        handler = handlers.get(name)
        if not handler:
            return {"error": f"æœªçŸ¥å·¥å…·: {name}"}
        
        try:
            result = await handler(arguments)
            return {
                "content": [{
                    "type": "text",
                    "text": json.dumps(result, ensure_ascii=False, indent=2)
                }]
            }
        except Exception as e:
            logger.error(f"å·¥å…·æ‰§è¡Œå¤±è´¥: {e}")
            return {"error": str(e)}
```

### çŸ¥è¯†åº“æœåŠ¡å™¨æ¶æ„

```python
# mcp_servers/kb_server.py
class KBMCPServer:
    """çŸ¥è¯†åº“MCPæœåŠ¡å™¨"""
    
    def __init__(self):
        # åˆå§‹åŒ–çŸ¥è¯†åº“æœåŠ¡
        self.kb_server = KBServer()
        
        # åŠ è½½rerankerï¼ˆå¯é€‰ï¼‰
        try:
            self.reranker = CrossEncoder("cross-encoder/ms-marco-MiniLM-L-6-v2")
        except:
            self.reranker = None
    
    async def call_tool(self, name: str, arguments: Dict) -> Dict:
        if name == "kb.query":
            # 1. å‚æ•°éªŒè¯
            query = arguments.get("query")
            if not query:
                return {
                    "isError": True,
                    "content": [{"type": "text", "text": "æŸ¥è¯¢æ–‡æœ¬ä¸èƒ½ä¸ºç©º"}]
                }
            
            # 2. è°ƒç”¨åº•å±‚æœåŠ¡
            results = self.kb_server.query(
                query=query,
                scope=arguments.get("scope", "both"),
                top_k=arguments.get("top_k", 10),
                use_reranker=arguments.get("use_reranker", False)
            )
            
            # 3. æ ¼å¼åŒ–è¿”å›
            return {
                "content": [{
                    "type": "text",
                    "text": json.dumps(results, ensure_ascii=False, indent=2)
                }]
            }
```

### é€šä¿¡æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Cursor    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  MCP Server  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚   Backend   â”‚
â”‚   (Client)  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   (stdio)    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   Service   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                        â”‚                        â”‚
     â”‚  1. å‘é€å·¥å…·è°ƒç”¨è¯·æ±‚    â”‚                        â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                        â”‚
     â”‚                        â”‚  2. è°ƒç”¨åç«¯æœåŠ¡        â”‚
     â”‚                        â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                        â”‚  3. è¿”å›ç»“æœ            â”‚
     â”‚                        â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚  4. è¿”å›å·¥å…·è°ƒç”¨ç»“æœ    â”‚                        â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                        â”‚
```

<h2 id="section-10-7-3">ğŸ› ï¸ 10.7.3 å·¥å…·å¼€å‘</h2>

å·¥å…·å¼€å‘æ˜¯MCPæœåŠ¡å™¨çš„æ ¸å¿ƒï¼Œéœ€è¦éµå¾ªå•ä¸€èŒè´£ã€å‚æ•°éªŒè¯ã€é”™è¯¯å¤„ç†ç­‰åŸåˆ™ã€‚

### å·¥å…·å®šä¹‰

```python
# å®šä¹‰MCPå·¥å…·
MCP_TOOLS: List[MCPTool] = [
    MCPTool(
        name="trquant_market_status",
        description="è·å–Aè‚¡å¸‚åœºå½“å‰çŠ¶æ€ï¼ŒåŒ…æ‹¬å¸‚åœºRegimeï¼ˆrisk_on/risk_off/neutralï¼‰ã€æŒ‡æ•°è¶‹åŠ¿å’Œé£æ ¼è½®åŠ¨",
        input_schema={
            "type": "object",
            "properties": {
                "universe": {
                    "type": "string",
                    "description": "å¸‚åœºï¼Œé»˜è®¤CN_EQè¡¨ç¤ºAè‚¡",
                    "default": "CN_EQ"
                }
            },
            "required": []
        }
    ),
    MCPTool(
        name="trquant_mainlines",
        description="è·å–å½“å‰Aè‚¡å¸‚åœºçš„æŠ•èµ„ä¸»çº¿ï¼ŒåŒ…æ‹¬ä¸»çº¿åç§°ã€è¯„åˆ†ã€ç›¸å…³è¡Œä¸šå’ŒæŠ•èµ„é€»è¾‘",
        input_schema={
            "type": "object",
            "properties": {
                "top_n": {
                    "type": "integer",
                    "description": "è¿”å›å‰Næ¡ä¸»çº¿ï¼Œé»˜è®¤10",
                    "default": 10
                },
                "time_horizon": {
                    "type": "string",
                    "enum": ["short", "medium", "long"],
                    "description": "æŠ•èµ„å‘¨æœŸï¼šshort(1-5å¤©)ã€medium(1-4å‘¨)ã€long(1æœˆ+)",
                    "default": "short"
                }
            },
            "required": []
        }
    ),
    MCPTool(
        name="trquant_generate_strategy",
        description="ç”ŸæˆPTradeæˆ–QMTé‡åŒ–ç­–ç•¥ä»£ç ï¼Œæ”¯æŒå¤šå› å­ã€åŠ¨é‡æˆé•¿ã€ä»·å€¼ã€å¸‚åœºä¸­æ€§å››ç§é£æ ¼",
        input_schema={
            "type": "object",
            "properties": {
                "platform": {
                    "type": "string",
                    "enum": ["ptrade", "qmt"],
                    "description": "ç›®æ ‡å¹³å°",
                    "default": "ptrade"
                },
                "style": {
                    "type": "string",
                    "enum": ["multi_factor", "momentum_growth", "value", "market_neutral"],
                    "description": "ç­–ç•¥é£æ ¼",
                    "default": "multi_factor"
                },
                "factors": {
                    "type": "array",
                    "items": {"type": "string"},
                    "description": "ä½¿ç”¨çš„å› å­åˆ—è¡¨"
                },
                "max_position": {
                    "type": "number",
                    "description": "å•ç¥¨æœ€å¤§ä»“ä½(0-1)ï¼Œé»˜è®¤0.1",
                    "default": 0.1
                }
            },
            "required": ["factors"]
        }
    )
]
```

### å·¥å…·å®ç°

```python
async def _get_market_status(self, args: dict) -> dict:
    """è·å–å¸‚åœºçŠ¶æ€"""
    if not TRQUANT_AVAILABLE:
        return self._mock_market_status()
    
    try:
        analyzer = TrendAnalyzer()
        result = analyzer.analyze_market()
        return {
            "regime": result.regime.value if hasattr(result.regime, 'value') else str(result.regime),
            "index_trend": result.index_zscore,
            "style_rotation": result.style_rotation,
            "summary": result.summary if hasattr(result, 'summary') else self._generate_summary(result)
        }
    except Exception as e:
        logger.error(f"è·å–å¸‚åœºçŠ¶æ€å¤±è´¥: {e}")
        return self._mock_market_status()

async def _generate_strategy(self, args: dict) -> dict:
    """ç”Ÿæˆç­–ç•¥ä»£ç """
    from tools.strategy_generator import StrategyGenerator
    
    generator = StrategyGenerator()
    result = generator.generate(
        platform=args.get('platform', 'ptrade'),
        style=args.get('style', 'multi_factor'),
        factors=args.get('factors', ['ROE_ttm', 'momentum_20d']),
        risk_params={
            'max_position': args.get('max_position', 0.1),
            'stop_loss': args.get('stop_loss', 0.08),
            'take_profit': args.get('take_profit', 0.2)
        }
    )
    
    return result
```

### é”™è¯¯å¤„ç†

```python
async def call_tool(self, name: str, arguments: dict) -> dict:
    """è°ƒç”¨å·¥å…·"""
    logger.info(f"è°ƒç”¨å·¥å…·: {name}")
    
    handlers = {
        "trquant_market_status": self._get_market_status,
        "trquant_mainlines": self._get_mainlines,
        "trquant_recommend_factors": self._recommend_factors,
        "trquant_generate_strategy": self._generate_strategy,
        "trquant_analyze_backtest": self._analyze_backtest
    }
    
    handler = handlers.get(name)
    if not handler:
        return {
            "isError": True,
            "content": [{"type": "text", "text": f"æœªçŸ¥å·¥å…·: {name}"}]
        }
    
    try:
        # å‚æ•°éªŒè¯
        if not self._validate_arguments(name, arguments):
            return {
                "isError": True,
                "content": [{"type": "text", "text": "å‚æ•°éªŒè¯å¤±è´¥"}]
            }
        
        result = await handler(arguments)
        return {
            "content": [{
                "type": "text",
                "text": json.dumps(result, ensure_ascii=False, indent=2)
            }]
        }
    except ValueError as e:
        logger.error(f"å‚æ•°é”™è¯¯: {e}")
        return {
            "isError": True,
            "content": [{"type": "text", "text": f"å‚æ•°é”™è¯¯: {e}"}]
        }
    except Exception as e:
        logger.error(f"å·¥å…·æ‰§è¡Œå¤±è´¥: {e}", exc_info=True)
        return {
            "isError": True,
            "content": [{"type": "text", "text": f"æ‰§è¡Œå¤±è´¥: {e}"}]
        }
```

<h2 id="section-10-7-4">ğŸ“¦ 10.7.4 èµ„æºç®¡ç†</h2>

èµ„æºæ˜¯MCPæœåŠ¡å™¨æä¾›çš„å¯è®¿é—®æ•°æ®ï¼Œå¯ä»¥æ˜¯æ–‡ä»¶ã€URLã€æ•°æ®åº“æŸ¥è¯¢ç»“æœç­‰ã€‚

### èµ„æºå®šä¹‰

```python
# èµ„æºå®šä¹‰ç¤ºä¾‹
resources = [
    {
        "uri": "file:///path/to/data",
        "name": "æ•°æ®æ–‡ä»¶",
        "description": "æ•°æ®æ–‡ä»¶èµ„æº",
        "mimeType": "text/plain"
    },
    {
        "uri": "https://example.com/api/data",
        "name": "APIæ•°æ®",
        "description": "APIæ•°æ®èµ„æº",
        "mimeType": "application/json"
    }
]
```

### èµ„æºè®¿é—®

```python
async def get_resource(self, uri: str) -> dict:
    """è·å–èµ„æº"""
    if uri.startswith("file://"):
        # æ–‡ä»¶èµ„æº
        file_path = uri.replace("file://", "")
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()
        return {
            "content": [{
                "type": "text",
                "text": content
            }]
        }
    elif uri.startswith("https://"):
        # URLèµ„æº
        import aiohttp
        async with aiohttp.ClientSession() as session:
            async with session.get(uri) as response:
                content = await response.text()
        return {
            "content": [{
                "type": "text",
                "text": content
            }]
        }
    else:
        return {
            "isError": True,
            "content": [{"type": "text", "text": f"ä¸æ”¯æŒçš„èµ„æºç±»å‹: {uri}"}]
        }
```

<h2 id="section-10-7-5">ğŸ’¬ 10.7.5 æç¤ºæ¨¡æ¿</h2>

æç¤ºæ¨¡æ¿ï¼ˆPromptsï¼‰æ˜¯MCPæœåŠ¡å™¨æä¾›çš„é¢„å®šä¹‰æç¤ºï¼Œç”¨äºæŒ‡å¯¼AIåŠ©æ‰‹æ‰§è¡Œç‰¹å®šä»»åŠ¡ã€‚

### æç¤ºå®šä¹‰

```python
# æç¤ºå®šä¹‰ç¤ºä¾‹
prompts = [
    {
        "name": "analyze_market",
        "description": "åˆ†æå¸‚åœºçŠ¶æ€å¹¶ç»™å‡ºæŠ•èµ„å»ºè®®",
        "arguments": [
            {
                "name": "universe",
                "description": "å¸‚åœºèŒƒå›´",
                "required": False
            }
        ]
    },
    {
        "name": "generate_strategy",
        "description": "ç”Ÿæˆé‡åŒ–ç­–ç•¥ä»£ç ",
        "arguments": [
            {
                "name": "factors",
                "description": "ä½¿ç”¨çš„å› å­åˆ—è¡¨",
                "required": True
            },
            {
                "name": "platform",
                "description": "ç›®æ ‡å¹³å°ï¼ˆptrade/qmtï¼‰",
                "required": False
            }
        ]
    }
]
```

### æç¤ºæ¸²æŸ“

```python
async def get_prompt(self, name: str, arguments: dict) -> dict:
    """è·å–æç¤º"""
    prompt_templates = {
        "analyze_market": """
        è¯·åˆ†æå½“å‰Aè‚¡å¸‚åœºçŠ¶æ€ï¼ŒåŒ…æ‹¬ï¼š
        1. å¸‚åœºRegimeï¼ˆrisk_on/risk_off/neutralï¼‰
        2. æŒ‡æ•°è¶‹åŠ¿
        3. é£æ ¼è½®åŠ¨
        4. æŠ•èµ„å»ºè®®
        
        å¸‚åœºèŒƒå›´ï¼š{universe}
        """,
        "generate_strategy": """
        è¯·ç”Ÿæˆé‡åŒ–ç­–ç•¥ä»£ç ï¼Œè¦æ±‚ï¼š
        1. ä½¿ç”¨å› å­ï¼š{factors}
        2. ç›®æ ‡å¹³å°ï¼š{platform}
        3. ç­–ç•¥é£æ ¼ï¼š{style}
        4. é£é™©å‚æ•°ï¼šmax_position={max_position}, stop_loss={stop_loss}
        """
    }
    
    template = prompt_templates.get(name)
    if not template:
        return {
            "isError": True,
            "content": [{"type": "text", "text": f"æœªçŸ¥æç¤º: {name}"}]
        }
    
    # æ¸²æŸ“æ¨¡æ¿
    prompt = template.format(**arguments)
    
    return {
        "content": [{
            "type": "text",
            "text": prompt
        }]
    }
```

<h2 id="section-10-7-6">ğŸ”§ 10.7.6 é…ç½®ä¸éƒ¨ç½²</h2>

MCPæœåŠ¡å™¨éœ€è¦åœ¨Cursorä¸­é…ç½®æ‰èƒ½ä½¿ç”¨ã€‚

### Cursoré…ç½®

åœ¨ `.cursor/mcp.json` ä¸­æ·»åŠ æœåŠ¡å™¨é…ç½®ï¼š

```json
{
  "mcpServers": {
    "trquant-business": {
      "command": "python",
      "args": [
        "extension/python/mcp_server.py"
      ],
      "env": {
        "PYTHONPATH": "${workspaceFolder}/extension:${workspaceFolder}"
      },
      "cwd": "${workspaceFolder}"
    },
    "kb-server": {
      "command": "extension/venv/bin/python",
      "args": [
        "${workspaceFolder}/mcp_servers/kb_server.py"
      ],
      "env": {
        "PYTHONPATH": "${workspaceFolder}/extension:${workspaceFolder}"
      },
      "cwd": "${workspaceFolder}"
    },
    "data-collector": {
      "command": "extension/venv/bin/python",
      "args": [
        "${workspaceFolder}/mcp_servers/data_collector_server.py"
      ],
      "env": {
        "PYTHONPATH": "${workspaceFolder}/extension:${workspaceFolder}"
      },
      "cwd": "${workspaceFolder}"
    }
  }
}
```

### ç¯å¢ƒå˜é‡

```bash
# .env æˆ–ç¯å¢ƒå˜é‡
PYTHONPATH=/path/to/TRQuant/extension:/path/to/TRQuant
TRQUANT_DATA_DIR=/path/to/data
TRQUANT_KB_DIR=/path/to/kb
```

### ä¾èµ–ç®¡ç†

```bash
# å®‰è£…MCPç›¸å…³ä¾èµ–
pip install langchain langchain-community chromadb rank-bm25 sentence-transformers
```

### è°ƒè¯•æŠ€å·§

```python
# å¯ç”¨è¯¦ç»†æ—¥å¿—
import logging

logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s [%(levelname)s] %(name)s: %(message)s',
    handlers=[logging.StreamHandler(sys.stderr)]
)
logger = logging.getLogger('MCP')

# æµ‹è¯•å·¥å…·è°ƒç”¨
async def test_tool():
    server = MCPServer()
    result = await server.call_tool(
        "trquant_market_status",
        {"universe": "CN_EQ"}
    )
    print(json.dumps(result, indent=2, ensure_ascii=False))
```

### è¯·æ±‚å¤„ç†

```python
async def handle_request(request: dict, server: MCPServer) -> dict:
    """å¤„ç†MCPè¯·æ±‚"""
    method = request.get("method", "")
    params = request.get("params", {})
    req_id = request.get("id")
    
    if method == "initialize":
        return {
            "jsonrpc": "2.0",
            "id": req_id,
            "result": {
                "protocolVersion": "2024-11-05",
                "capabilities": {
                    "tools": {}
                },
                "serverInfo": {
                    "name": "trquant-mcp",
                    "version": "1.0.0"
                }
            }
        }
    
    elif method == "tools/list":
        return {
            "jsonrpc": "2.0",
            "id": req_id,
            "result": {
                "tools": server.list_tools()
            }
        }
    
    elif method == "tools/call":
        tool_name = params.get("name", "")
        arguments = params.get("arguments", {})
        result = await server.call_tool(tool_name, arguments)
        return {
            "jsonrpc": "2.0",
            "id": req_id,
            "result": result
        }
    
    else:
        return {
            "jsonrpc": "2.0",
            "id": req_id,
            "error": {
                "code": -32601,
                "message": f"æœªçŸ¥æ–¹æ³•: {method}"
            }
        }
```

### ä¸»å‡½æ•°

```python
async def main():
    """ä¸»å‡½æ•° - è¿è¡ŒMCP Server"""
    logger.info("TRQuant MCP Server å¯åŠ¨...")
    server = MCPServer()
    
    # ä½¿ç”¨stdioé€šä¿¡
    reader = asyncio.StreamReader()
    protocol = asyncio.StreamReaderProtocol(reader)
    await asyncio.get_event_loop().connect_read_pipe(lambda: protocol, sys.stdin)
    
    writer_transport, writer_protocol = await asyncio.get_event_loop().connect_write_pipe(
        asyncio.streams.FlowControlMixin, sys.stdout
    )
    writer = asyncio.StreamWriter(writer_transport, writer_protocol, reader, asyncio.get_event_loop())
    
    while True:
        try:
            line = await reader.readline()
            if not line:
                break
            
            request = json.loads(line.decode('utf-8'))
            response = await handle_request(request, server)
            
            if response:
                response_str = json.dumps(response, ensure_ascii=False) + '\n'
                writer.write(response_str.encode('utf-8'))
                await writer.drain()
                
        except json.JSONDecodeError as e:
            logger.error(f"JSONè§£æé”™è¯¯: {e}")
        except Exception as e:
            logger.error(f"å¤„ç†è¯·æ±‚é”™è¯¯: {e}")

if __name__ == "__main__":
    asyncio.run(main())
```

## ğŸ”— ç›¸å…³ç« èŠ‚

- **10.9 MCP Ã— Cursor Ã— å·¥å…·é“¾è”ç”¨è§„èŒƒ**ï¼šäº†è§£MCPä¸Cursorçš„é›†æˆæ–¹æ³•
- **10.10 RAGçŸ¥è¯†åº“å¼€å‘æŒ‡å—**ï¼šäº†è§£çŸ¥è¯†åº“æœåŠ¡å™¨çš„å®ç°ç»†èŠ‚
- **ç¬¬7ç« ï¼šç­–ç•¥å¼€å‘**ï¼šäº†è§£ç­–ç•¥ç”Ÿæˆå·¥å…·çš„ä½¿ç”¨åœºæ™¯

## ğŸ’¡ å…³é”®è¦ç‚¹

1. **åè®®åŸºç¡€**ï¼šMCPä½¿ç”¨JSON-RPC 2.0åè®®ï¼Œé€šè¿‡stdioè¿›è¡Œé€šä¿¡
2. **æœåŠ¡å™¨æ¶æ„**ï¼šæ¯ä¸ªæœåŠ¡å™¨è´Ÿè´£ç‰¹å®šåŠŸèƒ½é¢†åŸŸï¼Œé€šè¿‡å·¥å…·æš´éœ²åŠŸèƒ½
3. **å·¥å…·å¼€å‘**ï¼šéµå¾ªå•ä¸€èŒè´£ã€å‚æ•°éªŒè¯ã€é”™è¯¯å¤„ç†ç­‰åŸåˆ™
4. **èµ„æºç®¡ç†**ï¼šæ”¯æŒæ–‡ä»¶ã€URLã€æ•°æ®åº“ç­‰å¤šç§èµ„æºç±»å‹
5. **æç¤ºæ¨¡æ¿**ï¼šæä¾›é¢„å®šä¹‰æç¤ºï¼ŒæŒ‡å¯¼AIåŠ©æ‰‹æ‰§è¡Œä»»åŠ¡
6. **é…ç½®éƒ¨ç½²**ï¼šåœ¨Cursorä¸­é…ç½®MCPæœåŠ¡å™¨ï¼Œå¯ç”¨è¯¦ç»†æ—¥å¿—è¿›è¡Œè°ƒè¯•

## ğŸ”® æ€»ç»“ä¸å±•æœ›

<div class="summary-outlook">
  <h3>æœ¬èŠ‚å›é¡¾</h3>
  <p>æœ¬èŠ‚ç³»ç»Ÿä»‹ç»äº†MCPæœåŠ¡å™¨å¼€å‘ï¼ŒåŒ…æ‹¬MCPåè®®åŸºç¡€ã€æœåŠ¡å™¨æ¶æ„ã€å·¥å…·å¼€å‘ã€èµ„æºç®¡ç†ã€æç¤ºæ¨¡æ¿ã€é…ç½®ä¸éƒ¨ç½²ç­‰æ ¸å¿ƒæŠ€æœ¯ã€‚é€šè¿‡ç†è§£MCP Serverå¼€å‘çš„å®Œæ•´æ–¹æ³•ï¼Œå¸®åŠ©å¼€å‘è€…æŒæ¡MCPå·¥å…·çš„å¼€å‘æŠ€å·§ã€‚</p>
  
  <h3>ä¸‹èŠ‚é¢„å‘Š</h3>
  <p>æŒæ¡äº†MCPæœåŠ¡å™¨å¼€å‘åï¼Œä¸‹ä¸€èŠ‚å°†ä»‹ç»ç‰ˆæœ¬ä¸å‘å¸ƒæœºåˆ¶ï¼ŒåŒ…æ‹¬ç‰ˆæœ¬ç®¡ç†ã€å‘å¸ƒæµç¨‹ã€å˜æ›´æ—¥å¿—ã€ä¾èµ–ç®¡ç†ç­‰ã€‚é€šè¿‡ç†è§£ç‰ˆæœ¬ä¸å‘å¸ƒæœºåˆ¶ï¼Œå¸®åŠ©å¼€å‘è€…æŒæ¡é¡¹ç›®çš„ç‰ˆæœ¬ç®¡ç†å’Œå‘å¸ƒæµç¨‹ã€‚</p>
  
  <a href="/ashare-book6/010_Chapter10_Development_Guide/10.8_Version_Release_Mechanism_CN" class="next-section">
    ç»§ç»­å­¦ä¹ ï¼š10.8 ç‰ˆæœ¬ä¸å‘å¸ƒæœºåˆ¶ â†’
  </a>
</div>

> **é€‚ç”¨ç‰ˆæœ¬**: v1.0.0+  
> **æœ€åæ›´æ–°**: 2025-12-12
