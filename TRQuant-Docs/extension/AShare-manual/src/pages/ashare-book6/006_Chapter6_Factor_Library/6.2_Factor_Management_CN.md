---
title: "6.2 å› å­ç®¡ç†"
description: "æ·±å…¥è§£æå› å­ç®¡ç†æœºåˆ¶ï¼ŒåŒ…æ‹¬å› å­æ³¨å†Œã€å› å­ç‰ˆæœ¬ç®¡ç†ã€å› å­å…ƒæ•°æ®ç®¡ç†å’Œå› å­å­˜å‚¨"
lang: "zh-CN"
layout: "/src/layouts/HandbookLayout.astro"
currentBook: "ashare-book6"
updateDate: "2025-12-12"
---

# ğŸ“š 6.2 å› å­ç®¡ç†

> **æ ¸å¿ƒæ‘˜è¦ï¼š**
> 
> æœ¬èŠ‚ç³»ç»Ÿä»‹ç»TRQuantç³»ç»Ÿçš„å› å­ç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬å› å­æ³¨å†Œæœºåˆ¶ã€å› å­ç‰ˆæœ¬ç®¡ç†ã€å› å­å…ƒæ•°æ®ç®¡ç†å’Œå› å­å­˜å‚¨ï¼ˆMongoDB + æ–‡ä»¶å­˜å‚¨åŒæ¨¡å¼ï¼‰ã€‚é€šè¿‡ç†è§£å› å­ç®¡ç†å™¨çš„è®¾è®¡ã€å› å­ç±»æ˜ å°„ã€å› å­åˆ†ç±»ç®¡ç†ã€å› å­ç‰ˆæœ¬æ§åˆ¶ã€å› å­å…ƒæ•°æ®å®šä¹‰å’ŒæŸ¥è¯¢ï¼Œä»¥åŠå› å­å€¼çš„å­˜å‚¨å’Œæ£€ç´¢æœºåˆ¶ï¼Œå¸®åŠ©å¼€å‘è€…æŒæ¡å› å­ç®¡ç†çš„æ ¸å¿ƒå®ç°ï¼Œä¸ºæ„å»ºå¯è¿½æº¯ã€å¯å¤ç°çš„å› å­ç®¡ç†ç³»ç»Ÿå¥ å®šåŸºç¡€ã€‚

## ğŸ“‹ ç« èŠ‚æ¦‚è§ˆ

<script>
function scrollToSection(sectionId) {
  const element = document.getElementById(sectionId);
  if (element) {
    const headerOffset = 100;
    const elementPosition = element.getBoundingClientRect().top;
    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
    window.scrollTo({
      top: offsetPosition,
      behavior: 'smooth'
    });
  }
}
</script>

<div class="section-overview">
  <div class="section-item" onclick="scrollToSection('section-6-2-1')">
    <h4>ğŸ“ 6.2.1 å› å­æ³¨å†Œ</h4>
    <p>å› å­ç±»æ˜ å°„ã€å› å­åˆ†ç±»ç®¡ç†ã€å› å­å®ä¾‹åˆå§‹åŒ–</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-6-2-2')">
    <h4>ğŸ“¦ 6.2.2 å› å­ç‰ˆæœ¬ç®¡ç†</h4>
    <p>ç‰ˆæœ¬æ§åˆ¶ã€ç‰ˆæœ¬æ¯”è¾ƒã€ç‰ˆæœ¬å›æ»š</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-6-2-3')">
    <h4>ğŸ“Š 6.2.3 å› å­å…ƒæ•°æ®ç®¡ç†</h4>
    <p>å…ƒæ•°æ®å®šä¹‰ã€å…ƒæ•°æ®æŸ¥è¯¢ã€å…ƒæ•°æ®æ›´æ–°</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-6-2-4')">
    <h4>ğŸ’¾ 6.2.4 å› å­å­˜å‚¨</h4>
    <p>MongoDBå­˜å‚¨ã€æ–‡ä»¶å­˜å‚¨ã€åŒæ¨¡å¼å­˜å‚¨</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-6-2-5')">
    <h4>ğŸ” 6.2.5 å› å­æŸ¥è¯¢ä¸æ£€ç´¢</h4>
    <p>å› å­å€¼æŸ¥è¯¢ã€å› å­å†å²æŸ¥è¯¢ã€å› å­æ‰¹é‡æŸ¥è¯¢</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-6-2-6')">
    <h4>ğŸ› ï¸ 6.2.6 MCPå·¥å…·ä½¿ç”¨</h4>
    <p>ä½¿ç”¨MCPå·¥å…·æŸ¥è¯¢å› å­ç®¡ç†ç›¸å…³æ–‡æ¡£</p>
  </div>
</div>

## ğŸ¯ å­¦ä¹ ç›®æ ‡

é€šè¿‡æœ¬èŠ‚å­¦ä¹ ï¼Œæ‚¨å°†èƒ½å¤Ÿï¼š

- **æŒæ¡å› å­æ³¨å†Œ**ï¼šç†è§£å› å­ç±»æ˜ å°„ã€å› å­åˆ†ç±»ç®¡ç†å’Œå› å­å®ä¾‹åˆå§‹åŒ–
- **ç†è§£ç‰ˆæœ¬ç®¡ç†**ï¼šæŒæ¡å› å­ç‰ˆæœ¬æ§åˆ¶ã€ç‰ˆæœ¬æ¯”è¾ƒå’Œç‰ˆæœ¬å›æ»šæœºåˆ¶
- **ç†Ÿæ‚‰å…ƒæ•°æ®ç®¡ç†**ï¼šç†è§£å› å­å…ƒæ•°æ®çš„å®šä¹‰ã€æŸ¥è¯¢å’Œæ›´æ–°æ–¹æ³•
- **äº†è§£å› å­å­˜å‚¨**ï¼šæŒæ¡MongoDBå­˜å‚¨ã€æ–‡ä»¶å­˜å‚¨å’ŒåŒæ¨¡å¼å­˜å‚¨çš„å®ç°
- **å®ç°å› å­æŸ¥è¯¢**ï¼šç†è§£å› å­å€¼æŸ¥è¯¢ã€å†å²æŸ¥è¯¢å’Œæ‰¹é‡æŸ¥è¯¢çš„æ–¹æ³•
- **ä½¿ç”¨MCPå·¥å…·**ï¼šæŒæ¡ä½¿ç”¨MCPå·¥å…·è¿›è¡Œå› å­ç®¡ç†ç›¸å…³ç ”ç©¶

<h2 id="section-6-2-1">ğŸ“ 6.2.1 å› å­æ³¨å†Œ</h2>

å› å­æ³¨å†Œæ˜¯å› å­ç®¡ç†çš„åŸºç¡€ï¼Œé€šè¿‡å› å­ç±»æ˜ å°„å’Œåˆ†ç±»ç®¡ç†ï¼Œå®ç°å› å­çš„ç»Ÿä¸€ç®¡ç†ã€‚

### è®¾è®¡åŸåˆ™

<div class="key-points">
  <div class="key-point">
    <h4>ğŸ”Œ ç»Ÿä¸€ç®¡ç†</h4>
    <p>æ‰€æœ‰å› å­é€šè¿‡å› å­ç®¡ç†å™¨ç»Ÿä¸€ç®¡ç†ï¼Œä¾¿äºè°ƒç”¨å’Œç»´æŠ¤</p>
  </div>
  <div class="key-point">
    <h4>ğŸ“Š åˆ†ç±»ç®¡ç†</h4>
    <p>æŒ‰å› å­ç±»åˆ«ï¼ˆä»·å€¼ã€æˆé•¿ã€è´¨é‡ã€åŠ¨é‡ç­‰ï¼‰åˆ†ç±»ç®¡ç†</p>
  </div>
  <div class="key-point">
    <h4>ğŸ”§ æ˜“äºæ‰©å±•</h4>
    <p>é€šè¿‡å› å­ç±»æ˜ å°„ï¼Œæ˜“äºæ·»åŠ æ–°çš„å› å­å®ç°</p>
  </div>
  <div class="key-point">
    <h4>ğŸ’¾ å»¶è¿Ÿåˆå§‹åŒ–</h4>
    <p>å› å­å®ä¾‹æŒ‰éœ€åˆå§‹åŒ–ï¼ŒèŠ‚çœèµ„æº</p>
  </div>
</div>

### å› å­ç®¡ç†å™¨è®¾è®¡

<CodeFromFile 
  filePath="code_library/006_Chapter6_Factor_Library/6.2/code_6_2___init__.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
from typing import Dict, List, Optional, Type
from core.factors.base_factor import BaseFactor, FactorResult

class FactorManager:
    """
    å› å­ç®¡ç†å™¨
    
    æä¾›å› å­çš„ç»Ÿä¸€ç®¡ç†ã€è®¡ç®—å’Œç»„åˆåŠŸèƒ½ã€‚
    """
    
    # é¢„å®šä¹‰å› å­ç±»æ˜ å°„
    FACTOR_CLASSES: Dict[str, Type[BaseFactor]] = {
        # ä»·å€¼å› å­
        "EP": EPFactor,
        "BP": BPFactor,
        "SP": SPFactor,
        "DividendYield": DividendYieldFactor,
        "CompositeValue": CompositeValueFactor,
        # æˆé•¿å› å­
        "RevenueGrowth": RevenueGrowthFactor,
        "ProfitGrowth": ProfitGrowthFactor,
        "ROEChange": ROEChangeFactor,
        "CompositeGrowth": CompositeGrowthFactor,
        # è´¨é‡å› å­
        "ROE": ROEFactor,
        "GrossMargin": GrossMarginFactor,
        "AssetTurnover": AssetTurnoverFactor,
        "Leverage": LeverageFactor,
        "CompositeQuality": CompositeQualityFactor,
        # åŠ¨é‡å› å­
        "PriceMomentum": PriceMomentumFactor,
        "Reversal": ReversalFactor,
        "RelativeStrength": RelativeStrengthFactor,
        "CompositeMomentum": CompositeMomentumFactor,
        # èµ„é‡‘æµå› å­
        "NorthboundFlow": NorthboundFlowFactor,
        "MainForceFlow": MainForceFlowFactor,
        "MarginBalance": MarginBalanceFactor,
        "CompositeFlow": CompositeFlowFactor,
    }
    
    # å› å­åˆ†ç±»
    FACTOR_CATEGORIES = {
        "value": ["EP", "BP", "SP", "DividendYield", "CompositeValue"],
        "growth": ["RevenueGrowth", "ProfitGrowth", "ROEChange", "CompositeGrowth"],
        "quality": ["ROE", "GrossMargin", "AssetTurnover", "Leverage", "CompositeQuality"],
        "momentum": ["PriceMomentum", "Reversal", "RelativeStrength", "CompositeMomentum"],
        "flow": ["NorthboundFlow", "MainForceFlow", "MarginBalance", "CompositeFlow"],
    }
    
    def __init__(self, jq_client=None, cache_dir: Optional[Path] = None, use_cache: bool = True):
        """
        åˆå§‹åŒ–å› å­ç®¡ç†å™¨
        
        Args:
            jq_client: JQDataå®¢æˆ·ç«¯
            cache_dir: ç¼“å­˜ç›®å½•
            use_cache: æ˜¯å¦ä½¿ç”¨ç¼“å­˜
        """
        self.jq_client = jq_client
        self.cache_dir = cache_dir or Path(__file__).parent.parent.parent / "data" / "factors"
        self.cache_dir.mkdir(parents=True, exist_ok=True)
        self.use_cache = use_cache
        
        # åˆå§‹åŒ–å› å­å®ä¾‹
        self._factors: Dict[str, BaseFactor] = {}
        self._init_factors()
    
    def _init_factors(self):
        """åˆå§‹åŒ–æ‰€æœ‰å› å­å®ä¾‹"""
        for name, factor_class in self.FACTOR_CLASSES.items():
            self._factors[name] = factor_class(
                jq_client=self.jq_client, 
                cache_dir=self.cache_dir, 
                use_cache=self.use_cache
            )
    
    def get_factor(self, name: str) -> Optional[BaseFactor]:
        """
        è·å–å› å­å®ä¾‹
        
        Args:
            name: å› å­åç§°
        
        Returns:
            BaseFactor: å› å­å®ä¾‹
        """
        return self._factors.get(name)
    
    def list_factors(self, category: Optional[str] = None) -> List[str]:
        """
        åˆ—å‡ºæ‰€æœ‰å› å­
        
        Args:
            category: å› å­ç±»åˆ«ï¼ˆvalue, growth, quality, momentum, flowï¼‰
        
        Returns:
            å› å­åç§°åˆ—è¡¨
        """
        if category:
            return self.FACTOR_CATEGORIES.get(category, [])
        return list(self._factors.keys())
    
    def get_factor_info(self, name: str) -> Optional[Dict[str, Any]]:
        """
        è·å–å› å­ä¿¡æ¯
        
        Args:
            name: å› å­åç§°
        
        Returns:
            å› å­ä¿¡æ¯å­—å…¸
        """
        factor = self._factors.get(name)
        if factor:
            return {
                "name": factor.name,
                "category": <CodeFromFile 
  filePath="code_library/006_Chapter6_Factor_Library/6.2/code_6_2_register_custom_factor.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
def register_custom_factor(
    self,
    name: str,
    factor_class: Type[BaseFactor],
    category: str = "custom"
):
    """
    æ³¨å†Œè‡ªå®šä¹‰å› å­
    
    Args:
        name: å› å­åç§°
        factor_class: å› å­ç±»
        category: å› å­ç±»åˆ«
    """
    # åˆ›å»ºå› å­å®ä¾‹
    self._factors[name] = factor_class(
        jq_client=self.jq_client,
        cache_dir=self.cache_dir,
        use_cache=self.use_cache
    )
    
    # æ·»åŠ åˆ°åˆ†ç±»
    if category not in self.FACTOR_CATEGORIES:
        self.FACTOR_CATEGORIES[category] = []
    self.FACTO<CodeFromFile 
  filePath="code_library/006_Chapter6_Factor_Library/6.2/code_6_2_to_dict.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
from dataclasses import dataclass
from datetime import datetime
from typing import Dict, Any

@dataclass
class FactorVersion:
    """å› å­ç‰ˆæœ¬ä¿¡æ¯"""
    factor_name: str
    version: str
    created_at: datetime
    description: str
    code_hash: str  # ä»£ç å“ˆå¸Œå€¼
    parameters: Dict[str, Any]
    performance: Optional[Dict[str, Any]] = None  # ç‰ˆæœ¬æ€§èƒ½æŒ‡æ ‡
    
    def to_dict(self) -> Dict[str, Any]:
        return {
            "factor_name": self.factor_name,
            "version": self.version,
            "created_at": self.created_at.isoformat(),
            "description": self.de<CodeFromFile 
  filePath="code_library/006_Chapter6_Factor_Library/6.2/code_6_2___init__.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
class FactorVersionManager:
    """å› å­ç‰ˆæœ¬ç®¡ç†å™¨"""
    
    def __init__(self, storage: FactorStorage):
        """
        åˆå§‹åŒ–ç‰ˆæœ¬ç®¡ç†å™¨
        
        Args:
            storage: å› å­å­˜å‚¨å¯¹è±¡
        """
        self.storage = storage
        self.versions: Dict[str, List[FactorVersion]] = {}
    
    def create_version(
        self,
        factor_name: str,
        version: str,
        description: str,
        code_hash: str,
        parameters: Dict[str, Any]
    ) -> FactorVersion:
        """
        åˆ›å»ºå› å­ç‰ˆæœ¬
        
        Args:
            factor_name: å› å­åç§°
            version: ç‰ˆæœ¬å·
            description: ç‰ˆæœ¬æè¿°
            code_hash: ä»£ç å“ˆå¸Œå€¼
            parameters: å› å­å‚æ•°
        
        Returns:
            FactorVersion: ç‰ˆæœ¬ä¿¡æ¯
        """
        version_info = FactorVersion(
            factor_name=factor_name,
            version=version,
            created_at=datetime.now(),
            description=description,
            code_hash=code_hash,
            parameters=parameters
        )
        
        # ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯
        if factor_name not in self.versions:
            self.versions[factor_name] = []
        self.versions[factor_name].append(version_info)
        
        # ä¿å­˜åˆ°å­˜å‚¨
        self.storage.save_factor_version(version_info)
        
        logger.info(f"åˆ›å»ºå› å­ç‰ˆæœ¬: {factor_name} v{version}")
        return version_info
    
    def get_versions(self, factor_name: str) -> List[FactorVersion]:
        """
        è·å–å› å­æ‰€æœ‰ç‰ˆæœ¬
        
        Args:
            factor_name: å› å­åç§°
        
        Returns:
            ç‰ˆæœ¬åˆ—è¡¨ï¼ˆæŒ‰æ—¶é—´å€’åºï¼‰
        """
        if factor_name not in self.versions:
            # ä»å­˜å‚¨åŠ è½½
            self.versions[factor_name] = self.storage.load_factor_versions(factor_name)
        
        return sorted(
            self.versions[factor_name],
            key=lambda v: v.created_at,
            reverse=True
        )
    
    def compare_versions(
        self,
        factor_name: str,
        version1: str,
        version2: str
    ) -> Dict[str, Any]:
        """
        æ¯”è¾ƒä¸¤ä¸ªç‰ˆæœ¬
        
        Args:
            factor_name: å› å­åç§°
            version1: ç‰ˆæœ¬1
            version2: ç‰ˆæœ¬2
        
        Returns:
            æ¯”è¾ƒç»“æœ
        """
        versions = self.get_versions(factor_name)
        v1 = next((v for v in versions if v.version == version1), None)
        v2 = next((v for v in versions if v.version == version2), None)
        
        if not v1 or not v2:
            raise ValueError(f"ç‰ˆæœ¬ä¸å­˜åœ¨: {version1} æˆ– {version2}")
        
        return {
            "factor_name": factor_name,
            "version1": v1.to_dict(),
            "version2": v2.to_dict(),
            "code_changed": v1.code_hash != v2.code_hash,
            "parameters_changed": v1.parameters != v2.parameters,
         <CodeFromFile 
  filePath="code_library/006_Chapter6_Factor_Library/6.2/code_6_2_to_dict.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
@dataclass
class FactorMetadata:
    """å› å­å…ƒæ•°æ®"""
    factor_name: str
    category: str
    description: str
    definition: str  # å› å­å®šä¹‰
    formula: str  # è®¡ç®—å…¬å¼
    evidence: str  # å®è¯è¯æ®
    direction: int  # 1=è¶Šå¤§è¶Šå¥½, -1=è¶Šå°è¶Šå¥½
    parameters: Dict[str, Any]  # å‚æ•°å®šä¹‰
    dependencies: List[str]  # ä¾èµ–çš„å…¶ä»–å› å­æˆ–æ•°æ®
    status: str = "active"  # active, deprecated, experimental
    created_at: datetime = field(default_factory=datetime.now)
    updated_at: datetime = field(default_factory=datetime.now)
    
    def to_dict(self) -> Dict[str, Any]:
        return {
            "factor_name": self.factor_name,
            "category": self.category,
            "description": self.description,
            "definition": self.definition,
            "formula": self.formula,
            "evidence": self.evidence,
            "direction": self.direction,
            "parameters": self.parameters,
            "dependencies": self.dependencies,
      <CodeFromFile 
  filePath="code_library/006_Chapter6_Factor_Library/6.2/code_6_2___init__.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
class FactorMetadataManager:
    """å› å­å…ƒæ•°æ®ç®¡ç†å™¨"""
    
    def __init__(self, storage: FactorStorage):
        """
        åˆå§‹åŒ–å…ƒæ•°æ®ç®¡ç†å™¨
        
        Args:
            storage: å› å­å­˜å‚¨å¯¹è±¡
        """
        self.storage = storage
        self.metadata: Dict[str, FactorMetadata] = {}
    
    def save_metadata(self, metadata: FactorMetadata):
        """
        ä¿å­˜å› å­å…ƒæ•°æ®
        
        Args:
            metadata: å› å­å…ƒæ•°æ®
        """
        self.metadata[metadata.factor_name] = metadata
        self.storage.save_factor_metadata(metadata)
        logger.info(f"ä¿å­˜å› å­å…ƒæ•°æ®: {metadata.factor_name}")
    
    def get_metadata(self, factor_name: str) -> Optional[FactorMetadata]:
        """
        è·å–å› å­å…ƒæ•°æ®
        
        Args:
            factor_name: å› å­åç§°
        
        Returns:
            FactorMetadata: å› å­å…ƒæ•°æ®
        """
        if factor_name not in self.metadata:
            # ä»å­˜å‚¨åŠ è½½
            metadata_dict = self.storage.load_factor_metadata(factor_name)
            if metadata_dict:
                self.metadata[factor_name] = FactorMetadata(**metadata_dict)
        
        return self.metadata.get(factor_name)
    
    def update_metadata(
        self,
        factor_name: str,
        **updates
    ):
        """
        æ›´æ–°å› å­å…ƒæ•°æ®
        
        Args:
            factor_name: å› å­åç§°
            **updates: è¦æ›´æ–°çš„å­—æ®µ
        """
        metadata = self.get_metadata(factor_name)
        if not metadata:
            raise ValueError(f"å› å­å…ƒæ•°æ®ä¸å­˜åœ¨: {factor_name}")
        
        # æ›´æ–°å­—æ®µ
        for key, value in updates.items():
            if hasattr(metadata, key):
                setattr(metadata, key, value)
        
        metadata.updated_at = datetime.now()
        
        # ä¿å­˜
        self.save_metadata(metadata)
        logger.info(f"æ›´æ–°å› å­å…ƒæ•°æ®: {factor_name}")
```
-->orage.load_factor_me<CodeFromFile 
  filePath="code_library/006_Chapter6_Factor_Library/6.2/code_6_2___init__.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
class FactorStorage:
    """
    å› å­æ•°æ®å­˜å‚¨
    
    ä½¿ç”¨MongoDBå­˜å‚¨å› å­æ•°æ®ã€å…ƒä¿¡æ¯å’Œç»©æ•ˆè®°å½•
    """
    
    def __init__(
        self,
        mongo_uri: str = "mongodb://localhost:27017/",
        db_name: str = "trquant_factors",
        use_file_fallback: bool = True,
    ):
        """
        åˆå§‹åŒ–å­˜å‚¨
        
        Args:
            mongo_uri: MongoDBè¿æ¥URI
            db_name: æ•°æ®åº“åç§°
            use_file_fallback: å½“MongoDBä¸å¯ç”¨æ—¶ä½¿ç”¨æ–‡ä»¶å­˜å‚¨
        """
        self.mongo_uri = mongo_uri
        self.db_name = db_name
        self.use_file_fallback = use_file_fallback
        
        self.client = None
        self.db = None
        self._connected = False
        
        # æ–‡ä»¶å­˜å‚¨è·¯å¾„
        self.file_storage_dir = Path.home() / ".local/share/trquant/factors"
        self.file_storage_dir.mkdir(parents=True, exist_ok=True)
        
        # å°è¯•è¿æ¥MongoDB
        self._connect()
    
    def _connect(self):
        """è¿æ¥MongoDB"""
        try:
            from pymongo import MongoClient
            
            self.client = MongoClient(self.mongo_uri, serverSelectionTimeoutMS=3000)
            # æµ‹è¯•è¿æ¥
            self.client.admin.command("ping")
            self.db = self.client[self.db_name]
            self._connected = True
            
            # åˆ›å»ºç´¢å¼•
            self._create_indexes()
            
            logger.info(f"MongoDBè¿æ¥æˆåŠŸ: {self.db_name}")
        
        except Exception as e:
            logger.warning(f"MongoDBè¿æ¥å¤±è´¥: {e}ï¼Œä½¿ç”¨æ–‡ä»¶å­˜å‚¨")
            self._connected = False
    
    def _create_indexes(self):
        """åˆ›å»ºç´¢å¼•"""
        if not self._connected:
            return
        
        from pymongo import ASCENDING, DESCENDING
        
        try:
            # factor_dataç´¢å¼•
            self.db.factor_data.create_index(
                [("date", DESCENDING), ("factor_name", ASCENDING), ("stock_id", ASCENDING)]
            )
            
            # factor_infoç´¢å¼•
            self.db.factor_info.create_index([("factor_name", ASCENDING)], unique=True)
            
            # factor_performanceç´¢å¼•
            self.db.factor_performance.create_index(
                [("factor_name", ASCENDING), ("date", DESCENDING)]
            )
        
        except Exception as e:
            logger.warning(f"åˆ›å»ºç´¢å¼•å¤±è´¥: {e}")
    
    def save_factor_values(
        self,
        factor_name: str,
        date: Union[str, datetime],
        values: pd.Series,
        overwrite: bool = True,
    ) -> bool:
        """
        ä¿å­˜å› å­å€¼
        
        Args:
            factor_name: å› å­åç§°
            date: æ—¥æœŸ
            values: å› å­å€¼ï¼ˆindexä¸ºè‚¡ç¥¨ä»£ç ï¼‰
            overwrite: æ˜¯å¦è¦†ç›–å·²æœ‰æ•°æ®
        
        Returns:
            bool: æ˜¯å¦æˆåŠŸ
        """
        if isinstance(date, str):
            date = datetime.strptime(date, "%Y-%m-%d")
        
        date_str = date.strftime("%Y-%m-%d")
        
        if self._connected:
            # MongoDBå­˜å‚¨
            try:
                collection = self.db.factor_data
                
                # åˆ é™¤æ—§æ•°æ®ï¼ˆå¦‚æœè¦†ç›–ï¼‰
                if overwrite:
                    collection.delete_many({
                        "factor_name": factor_name,
                        "date": date_str
                    })
                
                # æ’å…¥æ–°æ•°æ®
                documents = [
                    {
                        "factor_name": factor_name,
                        "date": date_str,
                        "stock_id": stock,
                        "value": float(value) if not pd.isna(value) else None
                    }
                    for stock, value in values.items()
                ]
                
                if documents:
                    collection.insert_many(documents)
                
                logger.info(f"ä¿å­˜å› å­å€¼åˆ°MongoDB: {factor_name} @ {date_str}")
                return True
            
            except Exception as e:
                logger.error(f"MongoDBä¿å­˜å¤±è´¥: {e}")
                if not self.use_file_fallback:
                    raise
        
        # æ–‡ä»¶å­˜å‚¨ï¼ˆé™çº§ï¼‰
        if self.use_file_fallback:
            return self._save_to_file(factor_name, date_str, values)
        
        return False
    
    def _save_to_file(
        self,
        factor_name: str,
        date_str: str,
        values: pd.Series
    ) -> bool:
        """ä¿å­˜åˆ°æ–‡ä»¶"""
        try:
            factor_dir = self.file_storage_dir / factor_name
            factor_dir.mkdir(parents=True, exist_ok=True)
            
            file_path = factor_dir / f"{date_str}.parquet"
            values.to_frame("value").to_parquet(file_path)
            
            logger.info(f"ä¿å­˜å› å­å€¼åˆ°æ–‡ä»¶: {factor_name} @ {date_str}")
            return True
        
        except Except<CodeFromFile 
  filePath="code_library/006_Chapter6_Factor_Library/6.2/code_6_2_load_factor_values.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
def load_factor_values(
    self,
    factor_name: str,
    date: Union[str, datetime],
    stocks: Optional[List[str]] = None
) -> Optional[pd.Series]:
    """
    åŠ è½½å› å­å€¼
    
    Args:
        factor_name: å› å­åç§°
        date: æ—¥æœŸ
        stocks: è‚¡ç¥¨åˆ—è¡¨ï¼ˆå¯é€‰ï¼‰
    
    Returns:
        pd.Series: å› å­å€¼ï¼ˆindexä¸ºè‚¡ç¥¨ä»£ç ï¼‰
    """
    if isinstance(date, str):
        date = datetime.strptime(date, "%Y-%m-%d")
    
    date_str = date.strftime("%Y-%m-%d")
    
    if self._connected:
        # ä»MongoDBåŠ è½½
        try:
            collection = self.db.factor_data
            
            query = {
                "factor_name": factor_name,
                "date": date_str
            }
            
            if stocks:
                query["stock_id"] = {"$in": stocks}
            
            cursor = collection.find(query)
            data = {doc["stock_id"]: doc["value"] for doc in cursor}
            
            if data:
                result = pd.Series(data)
                if stocks:
                    result = result.reindex(stocks)
                return result
        
        except Exception as e:
            logger.error(f"MongoDBåŠ è½½å¤±è´¥: {e}")
    
    # ä»æ–‡ä»¶åŠ è½½ï¼ˆé™çº§ï¼‰
    if self.use_file_fallback:
        return self._load_from_file(factor_name, date_str, stocks)
    
    return None

def load_factor_history(
    self,
    factor_name: str,
    stock: str,
    start_date: Union[str, datetime],
    end_date: Union[str, datetime]
) -> Optional[pd.Series]:
    """
    åŠ è½½å› å­å†å²å€¼
    
    Args:
        factor_name: å› å­åç§°
        stock: è‚¡ç¥¨ä»£ç 
        start_date: å¼€å§‹æ—¥æœŸ
        end_date: ç»“æŸæ—¥æœŸ
    
    Returns:
        pd.Series: å› å­å†å²å€¼ï¼ˆindexä¸ºæ—¥æœŸï¼‰
    """
    if isinstance(start_date, str):
        start_date = datetime.strptime(start_date, "%Y-%m-%d")
    if isinstance(end_date, str):
        end_date = datetime.strptime(end_date, "%Y-%m-%d")
    
    if self._connected:
        try:
            collection = self.db.factor_data
            
            cursor = collection.find({
                "factor_name": factor_name,
                "stock_id": stock,
                "date": {
                    "$gte": start_date.strftime("%Y-%m-%d"),
                    "$lte": end_date.strftime("%Y-%m-%d")
                }
            }).sort("date", 1)
            
            data = {doc["date"]: doc["value"] for doc in cursor}
            
            if data:
                result = pd.Series(data)
                result.index = pd.to_datetime(result.index)
                return result
        
        except Exception as e:
            logger.error(f"MongoDBåŠ <CodeFromFile 
  filePath="code_library/006_Chapter6_Factor_Library/6.2/code_6_2_kb.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
# æŸ¥è¯¢å› å­ç®¡ç†ç›¸å…³çš„çŸ¥è¯†
results = mcp_client.call_tool(
    "kb.query",
    {
        "query": "å› å­ç®¡ç† å› å­æ³¨å†Œ <CodeFromFile 
  filePath="code_library/006_Chapter6_Factor_Library/6.2/code_6_2_data_collector.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
# çˆ¬å–å› å­ç®¡ç†ç›¸å…³ç½‘é¡µ
content = mcp_client.call_tool(
    "data_collector.crawl_web",
    {
        "url": "https://example.com/factor-management",
        "extract_text": True
    }
)
```
-->    if isinstance(start_date, str):
        start_date = datetime.strptime(start_date, "%Y-%m-%d")
    if isinstance(end_date, str):
        end_date = datetime.strptime(end_date, "%Y-%m-%d")
    
    if self._connected:
        try:
            collection = self.db.factor_data
            
            cursor = collection.find({
                "factor_name": factor_name,
                "stock_id": stock,
                "date": {
                    "$gte": start_date.strftime("%Y-%m-%d"),
                    "$lte": end_date.strftime("%Y-%m-%d")
                }
            }).sort("date", 1)
            
            data = {doc["date"]: doc["value"] for doc in cursor}
            
            if data:
                result = pd.Series(data)
                result.index = pd.to_datetime(result.index)
                return result
        
        except Exception as e:
            logger.error(f"MongoDBåŠ è½½å†å²å¤±è´¥: {e}")
    
    return None
```

<h2 id="section-6-2-6">ğŸ› ï¸ 6.2.6 MCPå·¥å…·ä½¿ç”¨</h2>

å› å­ç®¡ç†æ¨¡å—ä¸MCPå·¥å…·é›†æˆï¼Œæ”¯æŒçŸ¥è¯†åº“æŸ¥è¯¢ã€æ•°æ®æ”¶é›†ç­‰åŠŸèƒ½ã€‚

### KB MCP Serverå·¥å…·

#### kb.query

æŸ¥è¯¢çŸ¥è¯†åº“ï¼Œè·å–å› å­ç®¡ç†ç›¸å…³çš„æ–‡æ¡£å’Œä»£ç ï¼š

```python
# æŸ¥è¯¢å› å­ç®¡ç†ç›¸å…³çš„çŸ¥è¯†
results = mcp_client.call_tool(
    "kb.query",
    {
        "query": "å› å­ç®¡ç† å› å­æ³¨å†Œ å› å­ç‰ˆæœ¬ç®¡ç† å› å­å­˜å‚¨",
        "collection": "manual_kb",
        "top_k": 5
    }
)
```

### Data Collector MCPå·¥å…·

#### data_collector.crawl_web

çˆ¬å–ç½‘é¡µå†…å®¹ï¼Œæ”¶é›†å› å­ç®¡ç†ç›¸å…³çš„ç ”ç©¶èµ„æ–™ï¼š

```python
# çˆ¬å–å› å­ç®¡ç†ç›¸å…³ç½‘é¡µ
content = mcp_client.call_tool(
    "data_collector.crawl_web",
    {
        "url": "https://example.com/factor-management",
        "extract_text": True
    }
)
```

## ğŸ”— ç›¸å…³ç« èŠ‚

- **ç¬¬2ç« ï¼šæ•°æ®æºæ¨¡å—** - äº†è§£æ•°æ®è·å–æœºåˆ¶ï¼Œä¸ºå› å­ç®¡ç†æä¾›æ•°æ®æ”¯æ’‘
- **ç¬¬6ç« ï¼šå› å­åº“** - äº†è§£å› å­åº“æ¨¡å—çš„æ•´ä½“è®¾è®¡
- **ç¬¬6.1èŠ‚ï¼šå› å­è®¡ç®—** - å› å­è®¡ç®—ç»“æœç”¨äºå› å­ç®¡ç†
- **ç¬¬6.3èŠ‚ï¼šå› å­ä¼˜åŒ–** - å› å­ä¼˜åŒ–ç»“æœç”¨äºå› å­ç®¡ç†
- **ç¬¬7ç« ï¼šç­–ç•¥å¼€å‘** - å› å­ç®¡ç†ä¸ºç­–ç•¥ç”Ÿæˆæä¾›å› å­
- **ç¬¬10ç« ï¼šå¼€å‘æŒ‡å—** - äº†è§£å› å­ç®¡ç†æ¨¡å—çš„å¼€å‘è§„èŒƒ

## ğŸ”® æ€»ç»“ä¸å±•æœ›

<div class="summary-outlook">
  <h3>æœ¬èŠ‚å›é¡¾</h3>
  <p>æœ¬èŠ‚ç³»ç»Ÿä»‹ç»äº†å› å­ç®¡ç†åŠŸèƒ½ï¼ŒåŒ…æ‹¬å› å­æ³¨å†Œæœºåˆ¶ã€å› å­ç‰ˆæœ¬ç®¡ç†ã€å› å­å…ƒæ•°æ®ç®¡ç†å’Œå› å­å­˜å‚¨ï¼ˆMongoDB + æ–‡ä»¶å­˜å‚¨åŒæ¨¡å¼ï¼‰ã€‚é€šè¿‡ç†è§£å› å­ç®¡ç†å™¨çš„è®¾è®¡ã€å› å­ç±»æ˜ å°„ã€å› å­åˆ†ç±»ç®¡ç†ã€å› å­ç‰ˆæœ¬æ§åˆ¶ã€å› å­å…ƒæ•°æ®å®šä¹‰å’ŒæŸ¥è¯¢ï¼Œä»¥åŠå› å­å€¼çš„å­˜å‚¨å’Œæ£€ç´¢æœºåˆ¶ï¼Œå¸®åŠ©å¼€å‘è€…æŒæ¡å› å­ç®¡ç†çš„æ ¸å¿ƒå®ç°ï¼Œä¸ºæ„å»ºå¯è¿½æº¯ã€å¯å¤ç°çš„å› å­ç®¡ç†ç³»ç»Ÿå¥ å®šåŸºç¡€ã€‚</p>
  
  <h3>ä¸‹èŠ‚é¢„å‘Š</h3>
  <p>æŒæ¡äº†å› å­ç®¡ç†æœºåˆ¶åï¼Œä¸‹ä¸€èŠ‚å°†ä»‹ç»å› å­ä¼˜åŒ–æ–¹æ³•ï¼ŒåŒ…æ‹¬å› å­æœ‰æ•ˆæ€§è¯„ä¼°ï¼ˆICã€IRï¼‰ã€å› å­ä¸­æ€§åŒ–å¤„ç†ã€å› å­ç›¸å…³æ€§åˆ†æå’Œå› å­ç»„åˆä¼˜åŒ–ã€‚é€šè¿‡ç†è§£å› å­ä¼˜åŒ–çš„å®Œæ•´æµç¨‹ï¼Œå¸®åŠ©å¼€å‘è€…æŒæ¡å¦‚ä½•æå‡å› å­çš„æœ‰æ•ˆæ€§å’Œç¨³å®šæ€§ã€‚</p>
  
  <a href="/ashare-book6/006_Chapter6_Factor_Library/6.3_Factor_Optimization_CN" class="next-section">
    ç»§ç»­å­¦ä¹ ï¼š6.3 å› å­ä¼˜åŒ– â†’
  </a>
</div>

> **é€‚ç”¨ç‰ˆæœ¬**: v1.0.0+  
> **æœ€åæ›´æ–°**: 2025-12-12
