# Strategy KBï¼ˆé‡‘èçŸ¥è¯†åº“ï¼‰å®Œæˆæ€»ç»“

> **åˆ›å»ºæ—¶é—´**: 2025-12-10  
> **çŠ¶æ€**: âœ… P0åŸºç¡€å®Œæˆï¼Œå‘é‡æ£€ç´¢å·²å®ç°

---

## ğŸ“‹ å·²å®Œæˆå†…å®¹

### 1. ç›®å½•ç»“æ„ âœ…

```
docs/strategy_kb/
â”œâ”€â”€ rules/                    # ç»“æ„åŒ–è§„åˆ™å±‚ï¼ˆ5ä¸ªYAMLæ–‡ä»¶ï¼‰
â”œâ”€â”€ cards/                    # ç ”ç©¶å¡ç‰‡å±‚ï¼ˆ5ä¸ªåˆ†ç±»ç›®å½•ï¼‰
â”‚   â”œâ”€â”€ momentum/            # åŠ¨é‡ç­–ç•¥ï¼ˆ3å¼ ï¼‰
â”‚   â”œâ”€â”€ mean_reversion/      # å‡å€¼å›å½’ï¼ˆ1å¼ ï¼‰
â”‚   â”œâ”€â”€ quality_growth/      # è´¨é‡æˆé•¿ï¼ˆ1å¼ ï¼‰
â”‚   â”œâ”€â”€ event_driven/        # äº‹ä»¶é©±åŠ¨ï¼ˆ0å¼ ï¼‰
â”‚   â””â”€â”€ sector_rotation/     # è¡Œä¸šè½®åŠ¨ï¼ˆ1å¼ ï¼‰
â”œâ”€â”€ materials/               # åŸå§‹èµ„æ–™å±‚ï¼ˆå¾…å¡«å……ï¼‰
â””â”€â”€ evidence/                # è¯æ®ä¸ç‰ˆæœ¬ï¼ˆå¾…å¡«å……ï¼‰
```

### 2. è§„åˆ™æ–‡ä»¶ï¼ˆYAMLï¼‰âœ…

- âœ… `strategy_constraints.yml` - ç­–ç•¥çº¦æŸè§„åˆ™
- âœ… `data_rules.yml` - æ•°æ®è§„åˆ™
- âœ… `risk_model.yml` - é£é™©æ¨¡å‹
- âœ… `cost_model.yml` - æˆæœ¬æ¨¡å‹
- âœ… `universe_rules.yml` - å¯äº¤æ˜“æ± è§„åˆ™

### 3. ç ”ç©¶å¡ âœ…

å·²åˆ›å»º**6å¼ ç ”ç©¶å¡**ï¼ˆå«1å¼ ç¤ºä¾‹ï¼‰ï¼Œè¦†ç›–4ç±»ç­–ç•¥ï¼š

**åŠ¨é‡ç­–ç•¥ï¼ˆ3å¼ ï¼‰**:
- âœ… `card_001_small_cap.md` - å°å¸‚å€¼å› å­
- âœ… `card_002_trend_following.md` - è¶‹åŠ¿è·Ÿè¸ª
- âœ… `card_003_momentum_factor.md` - åŠ¨é‡å› å­ç»„åˆ

**å‡å€¼å›å½’ï¼ˆ1å¼ ï¼‰**:
- âœ… `card_005_mean_reversion.md` - å‡å€¼å›å½’

**è´¨é‡æˆé•¿ï¼ˆ1å¼ ï¼‰**:
- âœ… `card_007_quality_factor.md` - è´¨é‡å› å­

**è¡Œä¸šè½®åŠ¨ï¼ˆ1å¼ ï¼‰**:
- âœ… `card_011_sector_rotation.md` - è¡Œä¸šè½®åŠ¨

### 4. MCP Server âœ…

**strategy_kb_server.py** - 7ä¸ªP0å·¥å…·å…¨éƒ¨å®ç°ï¼š

- âœ… `strategy_kb.rule.get` - è·å–è§„åˆ™
- âœ… `strategy_kb.rule.validate` - æ ¡éªŒç­–ç•¥
- âœ… `strategy_kb.card.create` - åˆ›å»ºç ”ç©¶å¡
- âœ… `strategy_kb.card.read` - è¯»å–ç ”ç©¶å¡
- âœ… `strategy_kb.card.search` - æœç´¢ç ”ç©¶å¡
- âœ… `strategy_kb.query` - å‘é‡æ£€ç´¢ï¼ˆå·²å®ç°ï¼‰
- âœ… `strategy_kb.version.get` - è·å–ç‰ˆæœ¬

### 5. å‘é‡æ£€ç´¢åŠŸèƒ½ âœ…

- âœ… å‘é‡ç´¢å¼•æ„å»ºï¼ˆChroma + HuggingFaceEmbeddingsï¼‰
- âœ… BM25ç´¢å¼•æ„å»º
- âœ… è‡ªåŠ¨åŠ è½½/æ„å»ºç´¢å¼•æœºåˆ¶
- âœ… é™çº§åˆ°ç®€å•æœç´¢ï¼ˆå¦‚æœç´¢å¼•ä¸å¯ç”¨ï¼‰
- âœ… æŸ¥è¯¢ç»“æœå¸¦ç›¸ä¼¼åº¦åˆ†æ•°

**æµ‹è¯•ç»“æœ**:
- âœ… ç´¢å¼•æ„å»ºæˆåŠŸï¼ˆ6ä¸ªchunksï¼‰
- âœ… æŸ¥è¯¢åŠŸèƒ½æ­£å¸¸ï¼ˆè¿”å›3ä¸ªç»“æœï¼Œå¸¦åˆ†æ•°ï¼‰

### 6. å·¥å…·è„šæœ¬ âœ…

- âœ… `scripts/test_strategy_kb.py` - æµ‹è¯•è„šæœ¬
- âœ… `scripts/build_strategy_kb_index.py` - ç´¢å¼•æ„å»ºè„šæœ¬

### 7. æ–‡æ¡£ âœ…

- âœ… `docs/Strategy_KB_è®¾è®¡æ–‡æ¡£.md` - å®Œæ•´è®¾è®¡æ–‡æ¡£
- âœ… `docs/Strategy_KB_ä½¿ç”¨æ•™ç¨‹.md` - ä½¿ç”¨æ•™ç¨‹
- âœ… `docs/Strategy_KB_å®æ–½æ¸…å•.md` - å®æ–½æ¸…å•
- âœ… `docs/Strategy_KB_å®Œæˆæ€»ç»“.md` - æœ¬æ–‡ä»¶

---

## ğŸ§ª æµ‹è¯•ç»“æœ

### åŠŸèƒ½æµ‹è¯•

| åŠŸèƒ½ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| è§„åˆ™è·å– | âœ… | æ­£å¸¸åŠ è½½5ä¸ªè§„åˆ™æ–‡ä»¶ |
| è§„åˆ™æ ¡éªŒ | âœ… | èƒ½æ­£ç¡®è¯†åˆ«è¿è§„ï¼ˆæŒä»“æ•°ã€ä»“ä½é™åˆ¶ï¼‰ |
| ç ”ç©¶å¡è¯»å– | âœ… | æ­£å¸¸è¯»å–ç ”ç©¶å¡ |
| ç ”ç©¶å¡æœç´¢ | âœ… | å…³é”®è¯æœç´¢æ­£å¸¸ï¼ˆæ‰¾åˆ°1å¼ å¡ï¼‰ |
| å‘é‡æ£€ç´¢ | âœ… | å‘é‡æ£€ç´¢æ­£å¸¸ï¼ˆè¿”å›3ä¸ªç»“æœï¼Œå¸¦åˆ†æ•°ï¼‰ |
| ç‰ˆæœ¬è·å– | âœ… | æ­£å¸¸è·å–ç‰ˆæœ¬ä¿¡æ¯ |

### æ€§èƒ½æµ‹è¯•

- **ç´¢å¼•æ„å»ºæ—¶é—´**: ~30ç§’ï¼ˆé¦–æ¬¡ï¼ŒåŒ…å«æ¨¡å‹ä¸‹è½½ï¼‰
- **æŸ¥è¯¢å“åº”æ—¶é—´**: <1ç§’
- **ç´¢å¼•å¤§å°**: 6ä¸ªchunksï¼ˆ6å¼ ç ”ç©¶å¡ï¼‰

---

## ğŸ“Š ä¸‰åº“ç»“æ„æ€»è§ˆ

| KBç±»å‹ | çŠ¶æ€ | æ•°æ®æº | æ ¸å¿ƒåŠŸèƒ½ | å‘é‡æ£€ç´¢ |
|--------|------|--------|----------|----------|
| **Manual KB** | âœ… å·²å®ç° | dev-book/ + docs/ | å¼€å‘æ‰‹å†Œæ£€ç´¢ | âœ… |
| **Engineering KB** | âœ… å·²å®ç° | ä»£ç /API/é…ç½® | å·¥ç¨‹ä»£ç æ£€ç´¢ | âœ… |
| **Strategy KB** | âœ… P0å®Œæˆ | è§„åˆ™/ç ”ç©¶å¡/è¯æ® | ç­–ç•¥ç”Ÿæˆæ”¯æŒ | âœ… |

---

## ğŸ¯ å…³é”®ç‰¹æ€§

### 1. ç»“æ„åŒ–ä¼˜å…ˆ

- è§„åˆ™/çº¦æŸ/æ¨¡æ¿å…ˆç»“æ„åŒ–ï¼ˆYAMLï¼‰
- ç ”ç©¶å¡ä½¿ç”¨Markdown frontmatter
- ç¡¬çº¦æŸä¸èµ°å‘é‡æ£€ç´¢ï¼Œèµ°è§„åˆ™å¼•æ“

### 2. å¼•ç”¨å¼ºåˆ¶

- ç­–ç•¥å»ºè®®å¿…é¡»ç»™research card/è§„åˆ™å¼•ç”¨
- æŸ¥è¯¢ç»“æœåŒ…å«citationsï¼ˆå¸¦æ–‡ä»¶è·¯å¾„ã€ç‰ˆæœ¬ï¼‰

### 3. è¯æ®é—­ç¯

- ç ”ç©¶å¡åŒ…å«`backtest_report_ids`
- ç‰ˆæœ¬ç»‘å®šï¼ˆkb_version + factor_version + template_versionï¼‰

### 4. å‘é‡æ£€ç´¢

- ä½¿ç”¨LangChainç”Ÿæ€ï¼ˆChroma + HuggingFaceEmbeddingsï¼‰
- æ”¯æŒè‡ªåŠ¨åŠ è½½/æ„å»ºç´¢å¼•
- é™çº§æœºåˆ¶ï¼ˆç´¢å¼•ä¸å¯ç”¨æ—¶ä½¿ç”¨ç®€å•æœç´¢ï¼‰

---

## ğŸ“‹ ä¸‹ä¸€æ­¥ï¼ˆP0/P1ï¼‰

### P0 - å¿…é¡»å®Œæˆ

1. **ç»§ç»­åˆ›å»ºç ”ç©¶å¡**ï¼ˆç›®æ ‡20å¼ ï¼‰
   - åŠ¨é‡ç­–ç•¥ï¼šè¿˜éœ€1-2å¼ 
   - å‡å€¼å›å½’ï¼šè¿˜éœ€1-2å¼ 
   - è´¨é‡æˆé•¿ï¼šè¿˜éœ€1-2å¼ 
   - äº‹ä»¶é©±åŠ¨ï¼šè¿˜éœ€2-3å¼ 
   - è¡Œä¸šè½®åŠ¨ï¼šè¿˜éœ€1-2å¼ 

2. **å®Œå–„å‘é‡æ£€ç´¢**
   - å®ç°3-stageæ£€ç´¢ï¼ˆBM25 + å‘é‡ + rerankerï¼‰
   - æ”¯æŒåŸå§‹èµ„æ–™å±‚ï¼ˆç ”æŠ¥/è®ºæ–‡/ä¼šè®®çºªè¦ï¼‰

3. **é›†æˆåˆ°workflow**
   - `strategy.generate_candidate` - ç”Ÿæˆå€™é€‰ç­–ç•¥ï¼ˆå—è§„åˆ™çº¦æŸï¼‰
   - é›†æˆ`strategy_kb.rule.validate`
   - é›†æˆ`strategy_kb.query`ï¼ˆç ”ç©¶å¡æ£€ç´¢ï¼‰

### P1 - å¢å¼ºåŠŸèƒ½

1. **è¯æ®ä¸ç‰ˆæœ¬ç®¡ç†**
   - å›æµ‹æŠ¥å‘Šè‡ªåŠ¨å…³è”ç ”ç©¶å¡
   - ç‰ˆæœ¬å†å²è¿½è¸ª
   - è¯æ®é“¾å®Œæ•´æ€§æ£€æŸ¥

2. **å¢é‡æ›´æ–°æœºåˆ¶**
   - `strategy_kb.index.update` - å¢é‡æ›´æ–°ç´¢å¼•
   - ç ”ç©¶å¡å˜æ›´è§¦å‘ç´¢å¼•æ›´æ–°

3. **è´¨é‡ä¿éšœ**
   - ç ”ç©¶å¡è´¨é‡æ£€æŸ¥ï¼ˆå¿…å¡«å­—æ®µã€æ ¼å¼éªŒè¯ï¼‰
   - è§„åˆ™ä¸€è‡´æ€§æ£€æŸ¥

---

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### 1. æ„å»ºç´¢å¼•

```bash
python scripts/build_strategy_kb_index.py
```

### 2. æŸ¥è¯¢ç ”ç©¶å¡

```python
from mcp_servers.strategy_kb_server import _handle_query
import json

result = _handle_query({
    "query": "å°å¸‚å€¼ç­–ç•¥",
    "top_k": 3
}, "test_trace", "inline")

response = json.loads(result[0].text)
citations = response["data"]["citations"]
for citation in citations:
    print(f"{citation['title']} (åˆ†æ•°: {citation['score']:.3f})")
```

### 3. æ ¡éªŒç­–ç•¥

```python
from mcp_servers.strategy_kb_server import _handle_rule_validate

result = _handle_rule_validate({
    "strategy_draft": {
        "positions": [...],
        "use_future_data": False
    },
    "rule_set": "strategy_constraints"
}, "test_trace", "inline")
```

---

## ğŸ“ å…³é”®æ–‡ä»¶

- `mcp_servers/strategy_kb_server.py` - Strategy KBæœåŠ¡å™¨
- `docs/strategy_kb/rules/*.yml` - 5ä¸ªè§„åˆ™æ–‡ä»¶
- `docs/strategy_kb/cards/**/*.md` - 6å¼ ç ”ç©¶å¡
- `scripts/test_strategy_kb.py` - æµ‹è¯•è„šæœ¬
- `scripts/build_strategy_kb_index.py` - ç´¢å¼•æ„å»ºè„šæœ¬

---

## âœ… éªŒæ”¶æ ‡å‡†

- [x] ç›®å½•ç»“æ„å®Œæ•´
- [x] 5ä¸ªè§„åˆ™æ–‡ä»¶ï¼ˆYAMLæ ¼å¼ï¼‰
- [x] è‡³å°‘5å¼ ç ”ç©¶å¡ï¼ˆè¦†ç›–4ç±»ç­–ç•¥ï¼‰
- [x] 7ä¸ªP0å·¥å…·å…¨éƒ¨å®ç°
- [x] å‘é‡æ£€ç´¢åŠŸèƒ½å®ç°å¹¶æµ‹è¯•é€šè¿‡
- [x] MCPé…ç½®æ›´æ–°
- [x] æµ‹è¯•è„šæœ¬å’Œæ–‡æ¡£å®Œæ•´

---

*æœ€åæ›´æ–°: 2025-12-10*
