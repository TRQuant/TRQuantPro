---
title: "4.2 ä¸»çº¿ç­›é€‰"
description: "æ·±å…¥è§£æä¸»çº¿ç­›é€‰æœºåˆ¶ï¼ŒåŒ…æ‹¬è¯„åˆ†ç­›é€‰ã€è¡Œä¸šç­›é€‰ã€æ—¶é—´ç­›é€‰å’Œç»¼åˆç­›é€‰ç®—æ³•"
lang: "zh-CN"
layout: "/src/layouts/HandbookLayout.astro"
currentBook: "ashare-book6"
updateDate: "2025-12-12"
---

# ğŸ” 4.2 ä¸»çº¿ç­›é€‰

> **æ ¸å¿ƒæ‘˜è¦ï¼š**
> 
> æœ¬èŠ‚ç³»ç»Ÿä»‹ç»TRQuantç³»ç»Ÿçš„ä¸»çº¿ç­›é€‰æœºåˆ¶ï¼ŒåŒ…æ‹¬è¯„åˆ†ç­›é€‰ã€è¡Œä¸šç­›é€‰ã€æ—¶é—´ç­›é€‰å’Œç»¼åˆç­›é€‰ç®—æ³•ã€‚é€šè¿‡ç†è§£æœ€ä½è¯„åˆ†é˜ˆå€¼ã€è¯„åˆ†æ’åã€è¯„åˆ†åŒºé—´ç­›é€‰æ–¹æ³•ï¼Œè¡Œä¸šåˆ†ç±»ã€è¡Œä¸šæƒé‡ã€è¡Œä¸šè½®åŠ¨ç­›é€‰é€»è¾‘ï¼Œæ—¶é—´çª—å£ã€æ—¶é—´æŒç»­æ€§ã€æ—¶é—´è¶‹åŠ¿ç­›é€‰æœºåˆ¶ï¼Œä»¥åŠå¤šæ¡ä»¶ç»„åˆç­›é€‰å’Œæ™ºèƒ½ç­›é€‰è§„åˆ™ï¼Œå¸®åŠ©å¼€å‘è€…æŒæ¡ä¸»çº¿ç­›é€‰çš„æ ¸å¿ƒå®ç°ï¼Œä¸ºæ„å»ºé«˜æ•ˆçš„ä¸»çº¿ç­›é€‰ç³»ç»Ÿå¥ å®šåŸºç¡€ã€‚

## ğŸ“‹ ç« èŠ‚æ¦‚è§ˆ

<script>
function scrollToSection(sectionId) {
  const element = document.getElementById(sectionId);
  if (element) {
    const headerOffset = 100;
    const elementPosition = element.getBoundingClientRect().top;
    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
    window.scrollTo({
      top: offsetPosition,
      behavior: 'smooth'
    });
  }
}
</script>

<div class="section-overview">
  <div class="section-item" onclick="scrollToSection('section-4-2-1')">
    <h4>ğŸ“Š 4.2.1 è¯„åˆ†ç­›é€‰</h4>
    <p>æœ€ä½è¯„åˆ†é˜ˆå€¼ã€è¯„åˆ†æ’åã€è¯„åˆ†åŒºé—´ç­›é€‰</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-4-2-2')">
    <h4>ğŸ­ 4.2.2 è¡Œä¸šç­›é€‰</h4>
    <p>è¡Œä¸šåˆ†ç±»ã€è¡Œä¸šæƒé‡ã€è¡Œä¸šè½®åŠ¨ç­›é€‰</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-4-2-3')">
    <h4>â° 4.2.3 æ—¶é—´ç­›é€‰</h4>
    <p>æ—¶é—´çª—å£ã€æ—¶é—´æŒç»­æ€§ã€æ—¶é—´è¶‹åŠ¿ç­›é€‰</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-4-2-4')">
    <h4>ğŸ”€ 4.2.4 ç»¼åˆç­›é€‰</h4>
    <p>å¤šæ¡ä»¶ç»„åˆç­›é€‰ã€æ™ºèƒ½ç­›é€‰è§„åˆ™ã€ç­›é€‰ç»“æœæ’åº</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-4-2-5')">
    <h4>ğŸ”„ 4.2.5 è‡ªåŠ¨åŒ–å®ç°</h4>
    <p>è‡ªåŠ¨ç­›é€‰æ›´æ–°ã€è‡ªåŠ¨ç­›é€‰è§„åˆ™è°ƒæ•´ã€è‡ªåŠ¨ç­›é€‰æŠ¥å‘Š</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-4-2-6')">
    <h4>ğŸ› ï¸ 4.2.6 MCPå·¥å…·ä½¿ç”¨</h4>
    <p>ä½¿ç”¨MCPå·¥å…·æŸ¥è¯¢ç­›é€‰ç›¸å…³æ–‡æ¡£ã€æ”¶é›†ç ”ç©¶èµ„æ–™</p>
  </div>
</div>

## ğŸ¯ å­¦ä¹ ç›®æ ‡

é€šè¿‡æœ¬èŠ‚å­¦ä¹ ï¼Œæ‚¨å°†èƒ½å¤Ÿï¼š

- **æŒæ¡è¯„åˆ†ç­›é€‰**ï¼šç†è§£æœ€ä½è¯„åˆ†é˜ˆå€¼ã€è¯„åˆ†æ’åã€è¯„åˆ†åŒºé—´ç­›é€‰çš„å®ç°æ–¹æ³•
- **ç†è§£è¡Œä¸šç­›é€‰**ï¼šæŒæ¡è¡Œä¸šåˆ†ç±»ã€è¡Œä¸šæƒé‡ã€è¡Œä¸šè½®åŠ¨ç­›é€‰çš„é€»è¾‘å’Œç®—æ³•
- **ç†Ÿæ‚‰æ—¶é—´ç­›é€‰**ï¼šç†è§£æ—¶é—´çª—å£ã€æ—¶é—´æŒç»­æ€§ã€æ—¶é—´è¶‹åŠ¿ç­›é€‰çš„æœºåˆ¶
- **äº†è§£ç»¼åˆç­›é€‰**ï¼šæŒæ¡å¤šæ¡ä»¶ç»„åˆç­›é€‰ã€æ™ºèƒ½ç­›é€‰è§„åˆ™å’Œç­›é€‰ç»“æœæ’åº
- **å®ç°è‡ªåŠ¨åŒ–**ï¼šç†è§£è‡ªåŠ¨ç­›é€‰æ›´æ–°ã€è‡ªåŠ¨ç­›é€‰è§„åˆ™è°ƒæ•´å’Œè‡ªåŠ¨ç­›é€‰æŠ¥å‘Š
- **ä½¿ç”¨MCPå·¥å…·**ï¼šæŒæ¡ä½¿ç”¨MCPå·¥å…·è¿›è¡Œç­›é€‰ç›¸å…³ç ”ç©¶

<h2 id="section-4-2-1">ğŸ“Š 4.2.1 è¯„åˆ†ç­›é€‰</h2>

è¯„åˆ†ç­›é€‰æ ¹æ®ä¸»çº¿çš„ç»¼åˆè¯„åˆ†è¿›è¡Œç­›é€‰ï¼Œç¡®ä¿ç­›é€‰å‡ºçš„ä¸»çº¿å…·æœ‰è¶³å¤Ÿçš„æŠ•èµ„ä»·å€¼ã€‚

### è®¾è®¡åŸåˆ™

<div class="key-points">
  <div class="key-point">
    <h4>ğŸ¯ é˜ˆå€¼å¯é…ç½®</h4>
    <p>æœ€ä½è¯„åˆ†é˜ˆå€¼å¯é…ç½®ï¼Œé€‚åº”ä¸åŒæŠ•èµ„ç­–ç•¥</p>
  </div>
  <div class="key-point">
    <h4>ğŸ“Š æ’åç­›é€‰</h4>
    <p>æ”¯æŒé€‰æ‹©æ’åå‰Nçš„ä¸»çº¿ï¼Œæ§åˆ¶ä¸»çº¿æ•°é‡</p>
  </div>
  <div class="key-point">
    <h4>ğŸ“ˆ åŒºé—´ç­›é€‰</h4>
    <p>æ”¯æŒé€‰æ‹©è¯„åˆ†åœ¨æŒ‡å®šåŒºé—´çš„ä¸»çº¿</p>
  </div>
  <div class="key-point">
    <h4>ğŸ”„ åŠ¨æ€è°ƒæ•´</h4>
    <p>æ ¹æ®å¸‚åœºç¯å¢ƒåŠ¨æ€è°ƒæ•´ç­›é€‰é˜ˆå€¼</p>
  </div>
</div>

### æœ€ä½è¯„åˆ†é˜ˆå€¼ç­›é€‰

è®¾ç½®æœ€ä½è¯„åˆ†é˜ˆå€¼ï¼Œç­›é€‰å‡ºè¯„åˆ†é«˜äºé˜ˆå€¼çš„ä¸»çº¿ï¼š

<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.2/code_4_2_filter_by_min_score.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
from typing import List
from core.base_mainline import Mainline

def filter_by_min_score(
    mainlines: List[Mainline],
    min_score: float = 60.0
) -> List[Mainline]:
    """
    æ ¹æ®æœ€ä½è¯„åˆ†ç­›é€‰ä¸»çº¿
    
    Args:
        mainlines: ä¸»çº¿åˆ—è¡¨
        min_score: æœ€ä½è¯„åˆ†é˜ˆå€¼ï¼ˆé»˜è®¤60åˆ†ï¼‰
    
    Returns:
        ç­›é€‰åçš„ä¸»çº¿åˆ—è¡¨
    """
    filtered = [
        mainline for mainline in mainlines
        if mainline.score.total_score >= min_score
    ]
    return filtered
<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.2/code_4_2_filter_by_top_n.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
def filter_by_top_n(
    mainlines: List[Mainline],
    top_n: int = 10
) -> List[Mainline]:
    """
    æ ¹æ®è¯„åˆ†æ’åç­›é€‰ä¸»çº¿
    
    Args:
        mainlines: ä¸»çº¿åˆ—è¡¨
        top_n: æ’åå‰Nï¼ˆé»˜è®¤10ï¼‰
    
    Returns:
        ç­›é€‰åçš„ä¸»çº¿åˆ—è¡¨ï¼ˆæŒ‰è¯„åˆ†é™åºæ’åˆ—ï¼‰
    """
    # æŒ‰è¯„åˆ†æ’åº
    sorted_mainlines = sorted(
        mainlines,
        key=lambda m: m.score.total_score,
        reverse=True
    )
    
    # å–å‰Næ¡
    return sorted_mainlines[:top_n]

# ä½¿ç”¨ç¤ºä¾‹
mainlines = get_all_mainlines()
top_10_mainlines = filter_<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.2/code_4_2_filter_by_score_range.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
def filter_by_score_range(
    mainlines: List[Mainline],
    min_score: float = None,
    max_score: float = None
) -> List[Mainline]:
    """
    æ ¹æ®è¯„åˆ†åŒºé—´ç­›é€‰ä¸»çº¿
    
    Args:
        mainlines: ä¸»çº¿åˆ—è¡¨
        min_score: æœ€ä½è¯„åˆ†ï¼ˆå¯é€‰ï¼‰
        max_score: æœ€é«˜è¯„åˆ†ï¼ˆå¯é€‰ï¼‰
    
    Returns:
        ç­›é€‰åçš„ä¸»çº¿åˆ—è¡¨
    """
    filtered = mainlines
    
    if min_score is not None:
        filtered = [
            m for m in filtered
            if m.score.total_score >= min_score
        ]
    
    if max_score is not None:
        filtered = [
            m for m in filtered
            if m.score.total_score <= max_score
        ]
    
    return filtered

# ä½¿ç”¨ç¤ºä¾‹
mainlines = get_all_mainlines()
# ç­›é€‰è¯„åˆ†åœ¨70-90ä¹‹é—´çš„ä¸»çº¿
filtered_mainlines = <CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.2/code_4_2_filter_by_industries.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
def filter_by_industries(
    mainlines: List[Mainline],
    industries: List[str],
    match_all: bool = False
) -> List[Mainline]:
    """
    æ ¹æ®è¡Œä¸šç­›é€‰ä¸»çº¿
    
    Args:
        mainlines: ä¸»çº¿åˆ—è¡¨
        industries: è¡Œä¸šåˆ—è¡¨
        match_all: æ˜¯å¦è¦æ±‚åŒ¹é…æ‰€æœ‰è¡Œä¸šï¼ˆé»˜è®¤Falseï¼ŒåŒ¹é…ä»»ä¸€å³å¯ï¼‰
    
    Returns:
        ç­›é€‰åçš„ä¸»çº¿åˆ—è¡¨
    """
    # è®¾è®¡åŸç†ï¼šè¡Œä¸šç­›é€‰æ”¯æŒä¸¤ç§æ¨¡å¼
    # åŸå› ï¼šä¸åŒåœºæ™¯éœ€è¦ä¸åŒçš„ç­›é€‰é€»è¾‘
    # match_all=Trueï¼šè¦æ±‚åŒ¹é…æ‰€æœ‰è¡Œä¸šï¼ˆäº¤é›†ï¼‰ï¼Œé€‚ç”¨äºç²¾ç¡®ç­›é€‰
    # match_all=Falseï¼šåŒ¹é…ä»»ä¸€è¡Œä¸šå³å¯ï¼ˆå¹¶é›†ï¼‰ï¼Œé€‚ç”¨äºå®½æ³›ç­›é€‰
    # ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼šæä¾›çµæ´»æ€§ï¼Œé€‚åº”ä¸åŒçš„ç­›é€‰éœ€æ±‚
    if match_all:
        # è®¾è®¡åŸç†ï¼šäº¤é›†ç­›é€‰ï¼ˆANDé€»è¾‘ï¼‰
        # åŸå› ï¼šè¦æ±‚ä¸»çº¿åŒæ—¶åŒ…å«æ‰€æœ‰æŒ‡å®šè¡Œä¸šï¼Œç­›é€‰æ›´ä¸¥æ ¼
        # ä½¿ç”¨åœºæ™¯ï¼šéœ€è¦ä¸»çº¿åŒæ—¶æ¶‰åŠå¤šä¸ªç›¸å…³è¡Œä¸šæ—¶
        filtered = [
            mainline for mainline in mainlines
            if all(ind in mainline.sectors for ind in industries)
        ]
    else:
        # è®¾è®¡åŸç†ï¼šå¹¶é›†ç­›é€‰ï¼ˆORé€»è¾‘ï¼‰
        # åŸå› ï¼šä¸»çº¿åŒ…å«ä»»ä¸€æŒ‡å®šè¡Œä¸šå³å¯ï¼Œç­›é€‰æ›´å®½æ¾
        # ä½¿ç”¨åœºæ™¯ï¼šéœ€è¦ä¸»çº¿æ¶‰åŠä»»ä¸€ç›¸å…³è¡Œä¸šæ—¶
        filtered = [
            mainline for mainline in mainlines
            if any(ind in mainline.sectors for ind in industries)
        ]
    
    return filtered

# ä½¿ç”¨ç¤ºä¾‹
mainlines = get_all_<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.2/code_4_2_filter_by_industry_weights.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
def filter_by_industry_weights(
    mainlines: List[Mainline],
    industry_weights: Dict[str, float],
    min_weight: float = 0.1
) -> List[Mainline]:
    """
    æ ¹æ®è¡Œä¸šæƒé‡ç­›é€‰ä¸»çº¿
    
    Args:
        mainlines: ä¸»çº¿åˆ—è¡¨
        industry_weights: è¡Œä¸šæƒé‡å­—å…¸ {è¡Œä¸šå: æƒé‡}
        min_weight: æœ€å°æƒé‡é˜ˆå€¼
    
    Returns:
        ç­›é€‰åçš„ä¸»çº¿åˆ—è¡¨ï¼ˆæŒ‰è¡Œä¸šæƒé‡æ’åºï¼‰
    """
    filtered = []
    
    # è®¾è®¡åŸç†ï¼šè¡Œä¸šæƒé‡ç­›é€‰
    # åŸå› ï¼šä¸åŒè¡Œä¸šçš„é‡è¦æ€§ä¸åŒï¼Œéœ€è¦æ ¹æ®æƒé‡ç­›é€‰
    # å®ç°æ–¹å¼ï¼šè®¡ç®—ä¸»çº¿çš„è¡Œä¸šæƒé‡å¾—åˆ†ï¼ŒæŒ‰å¾—åˆ†ç­›é€‰å’Œæ’åº
    # ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼šä¼˜å…ˆé€‰æ‹©æƒé‡é«˜çš„è¡Œä¸šï¼Œæé«˜ç­›é€‰çš„é’ˆå¯¹æ€§
    for mainline in mainlines:
        # è®¾è®¡åŸç†ï¼šç´¯åŠ è¡Œä¸šæƒé‡å¾—åˆ†
        # åŸå› ï¼šä¸»çº¿å¯èƒ½æ¶‰åŠå¤šä¸ªè¡Œä¸šï¼Œéœ€è¦ç´¯åŠ æƒé‡
        # å®ç°æ–¹å¼ï¼šéå†ä¸»çº¿çš„æ‰€æœ‰è¡Œä¸šï¼Œç´¯åŠ å¯¹åº”çš„æƒé‡
        industry_score = 0.0
        for sector in mainline.sectors:
            weight = industry_weights.get(sector, 0.0)
            industry_score += weight
        
        # è®¾è®¡åŸç†ï¼šé˜ˆå€¼ç­›é€‰
        # åŸå› ï¼šåªä¿ç•™è¡Œä¸šæƒé‡å¾—åˆ†è¾¾åˆ°é˜ˆå€¼çš„ä¸»çº¿
        # ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼šè¿‡æ»¤æ‰è¡Œä¸šæƒé‡è¿‡ä½çš„ä¸»çº¿ï¼Œæé«˜ç­›é€‰è´¨é‡
        if industry_score >= min_weight:
            # è®¾è®¡åŸç†ï¼šä¸´æ—¶å±æ€§å­˜å‚¨å¾—åˆ†
            # åŸå› ï¼šä¾¿äºåç»­æ’åºï¼Œä¸ä¿®æ”¹ä¸»çº¿åŸå§‹æ•°æ®
            mainline.industry_score = industry_score
            filtered.append(mainline)
    
    # è®¾è®¡åŸç†ï¼šæŒ‰å¾—åˆ†æ’åº
    # åŸå› ï¼šä¼˜å…ˆå±•ç¤ºæƒé‡é«˜çš„ä¸»çº¿ï¼Œä¾¿äºç”¨æˆ·é€‰æ‹©
    # å®ç°æ–¹å¼ï¼šä½¿ç”¨sortæŒ‰industry_scoreé™åºæ’åº
    filtered.sort(key=lambda m: m.industry_score, reverse=True)
    
    return filtered

# ä½¿ç”¨ç¤ºä¾‹
mainlines = get_all_mainlines()
industry_weights = {
    "æ–°èƒ½æº": 0.3,
    "äººå·¥æ™ºèƒ½": 0.25,
  <CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.2/code_4_2_filter_by_industry_rotation.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
def filter_by_industry_rotation(
    mainlines: List[Mainline],
    rotation_signal: Dict[str, str]
) -> List[Mainline]:
    """
    æ ¹æ®è¡Œä¸šè½®åŠ¨ä¿¡å·ç­›é€‰ä¸»çº¿
    
    Args:
        mainlines: ä¸»çº¿åˆ—è¡¨
        rotation_signal: è¡Œä¸šè½®åŠ¨ä¿¡å·å­—å…¸ {è¡Œä¸šå: "up"/"down"/"neutral"}
    
    Returns:
        ç­›é€‰åçš„ä¸»çº¿åˆ—è¡¨ï¼ˆä¼˜å…ˆé€‰æ‹©è½®åŠ¨ä¸Šå‡çš„è¡Œä¸šï¼‰
    """
    filtered = []
    
    for mainline in mainlines:
        # æ£€æŸ¥ä¸»çº¿çš„è¡Œä¸šè½®åŠ¨ä¿¡å·
        rotation_scores = []
        for sector in mainline.sectors:
            signal = rotation_signal.get(sector, "neutral")
            if signal == "up":
                rotation_scores.append(1.0)
            elif signal == "neutral":
                rotation_scores.append(0.5)
            else:  # down
                rotation_scores.append(0.0)
        
        # å¦‚æœå¹³å‡è½®åŠ¨å¾—åˆ†>0.5ï¼Œåˆ™ä¿ç•™
        avg_rotation_score = sum(rotation_scores) / len(rotation_scores) if rotation_scores else 0.0
        if avg_rotation_score > 0.5:
            mainline.rotation_score = avg_rotation_score
            filtered.append(mainline)
    
    # æŒ‰è½®åŠ¨å¾—åˆ†æ’åº
    filtered.sort(key=lambda m: m.rotation_score, reverse=True)
    
    return filtered

# ä½¿ç”¨ç¤ºä¾‹
mainlines = get_all_mainlines()
rotation_signal = {
    "æ–°èƒ½æº": "up",
    "äººå·¥æ™ºèƒ½": "up",
    "åŠå¯¼ä½“": "neutral",
    "åŒ»è¯": "down",
    "æ¶ˆè´¹": "neutr<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.2/code_4_2_filter_by_time_window.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
from datetime import datetime, timedelta

def filter_by_time_window(
    mainlines: List[Mainline],
    days: int = 30
) -> List[Mainline]:
    """
    æ ¹æ®æ—¶é—´çª—å£ç­›é€‰ä¸»çº¿
    
    Args:
        mainlines: ä¸»çº¿åˆ—è¡¨
        days: æ—¶é—´çª—å£ï¼ˆå¤©æ•°ï¼Œé»˜è®¤30å¤©ï¼‰
    
    Returns:
        ç­›é€‰åçš„ä¸»çº¿åˆ—è¡¨ï¼ˆåœ¨æ—¶é—´çª—å£å†…å¯åŠ¨æˆ–æ›´æ–°çš„ä¸»çº¿ï¼‰
    """
    cutoff_date = datetime.now() - timedelta(days=days)
    
    filtered = []
    for mainline in mainlines:
        # æ£€æŸ¥ä¸»çº¿å¯åŠ¨æ—¥æœŸæˆ–æ›´æ–°æ—¥æœŸ
        start_date = datetime.strptime(mainline.start_date, "%Y-%m-%d") if mainline.start_date else None
        updated_date = datetime.strptime(mainline.updated_at, "%Y-%m-%d") if mainline.updated_at else None
        
        # å¦‚æœå¯åŠ¨æ—¥æœŸæˆ–æ›´æ–°æ—¥æœŸåœ¨æ—¶é—´çª—å£å†…ï¼Œåˆ™ä¿ç•™
        if (start_date and start_date >= cutoff_date) or \
           (updated_date and updated_date >= cutoff_date):
            filtered.append<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.2/code_4_2_filter_by_persistence.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
def filter_by_persistence(
    mainlines: List[Mainline],
    min_days: int = 5
) -> List[Mainline]:
    """
    æ ¹æ®æ—¶é—´æŒç»­æ€§ç­›é€‰ä¸»çº¿
    
    Args:
        mainlines: ä¸»çº¿åˆ—è¡¨
        min_days: æœ€å°æŒç»­å¤©æ•°ï¼ˆé»˜è®¤5å¤©ï¼‰
    
    Returns:
        ç­›é€‰åçš„ä¸»çº¿åˆ—è¡¨ï¼ˆæŒç»­å¤©æ•°â‰¥min_daysçš„ä¸»çº¿ï¼‰
    """
    filtered = []
    
    for mainline in mainlines:
        if mainline.start_date:
            start_date = datetime.strptime(mainline.start_date, "%Y-%m-%d")
            duration = (datetime.now() - start_date).days
            
            if duration >= min_days:
                mainline.duration = duration
                filtered.append(mainline)
    
    # æŒ‰æŒç»­å¤©æ•°æ’åº
    filtered.sort(key=lambda m: m.duration, reverse<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.2/code_4_2_filter_by_trend.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
def filter_by_trend(
    mainlines: List[Mainline],
    min_trend_days: int = 3
) -> List[Mainline]:
    """
    æ ¹æ®æ—¶é—´è¶‹åŠ¿ç­›é€‰ä¸»çº¿
    
    Args:
        mainlines: ä¸»çº¿åˆ—è¡¨
        min_trend_days: æœ€å°è¶‹åŠ¿å¤©æ•°ï¼ˆé»˜è®¤3å¤©ï¼‰
    
    Returns:
        ç­›é€‰åçš„ä¸»çº¿åˆ—è¡¨ï¼ˆè¯„åˆ†æŒç»­ä¸Šå‡çš„ä¸»çº¿ï¼‰
    """
    filtered = []
    
    for mainline in mainlines:
        # è·å–å†å²è¯„åˆ†æ•°æ®ï¼ˆéœ€è¦ä»æ•°æ®åº“æˆ–ç¼“å­˜è·å–ï¼‰
        historical_scores = get_historical_scores(mainline.id, days=min_trend_days)
        
        if len(historical_scores) >= min_trend_days:
            # æ£€æŸ¥è¯„åˆ†æ˜¯å¦æŒç»­ä¸Šå‡
            is_rising = all(
                historical_scores[i] < historical_scores[i+1]
                for i in range(len(historical_scores) - 1)
            )
            
            if is_rising:
                mainline.trend_score = historical_scores[-1] - historical_scores[0]
                filtered.append(mainline)
    
    # æŒ‰è¶‹åŠ¿å¾—åˆ†æ’åº
    filtered.sort(key=lambda m: m.trend_score, reverse=True)
    
    return filtered

# ä½¿ç”¨ç¤ºä¾‹
mainlines = get<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.2/code_4_2___init__.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
@dataclass
class FilterCriteria:
    """ç­›é€‰æ¡ä»¶"""
    min_score: float = None              # æœ€ä½è¯„åˆ†
    max_score: float = None              # æœ€é«˜è¯„åˆ†
    top_n: int = None                    # æ’åå‰N
    industries: List[str] = None         # è¡Œä¸šåˆ—è¡¨
    match_all_industries: bool = False   # æ˜¯å¦åŒ¹é…æ‰€æœ‰è¡Œä¸š
    industry_weights: Dict[str, float] = None  # è¡Œä¸šæƒé‡
    min_industry_weight: float = None     # æœ€å°è¡Œä¸šæƒé‡
    time_window_days: int = None         # æ—¶é—´çª—å£ï¼ˆå¤©æ•°ï¼‰
    min_persistence_days: int = None     # æœ€å°æŒç»­å¤©æ•°
    require_trend_up: bool = False       # æ˜¯å¦è¦æ±‚è¶‹åŠ¿å‘ä¸Š
    min_trend_days: int = None           # æœ€å°è¶‹åŠ¿å¤©æ•°

class MainlineFilter:
    """ä¸»çº¿ç­›é€‰å™¨"""
    
    def __init__(self):
        self.criteria = FilterCriteria()
    
    def filter(
        self,
        mainlines: List[Mainline],
        criteria: FilterCriteria = None
    ) -> List[Mainline]:
        """
        ç»¼åˆç­›é€‰ä¸»çº¿
        
        Args:
            mainlines: ä¸»çº¿åˆ—è¡¨
            criteria: ç­›é€‰æ¡ä»¶
        
        Returns:
            ç­›é€‰åçš„ä¸»çº¿åˆ—è¡¨
        """
        if criteria is None:
            criteria = self.criteria
        
        filtered = mainlines
        
        # 1. è¯„åˆ†ç­›é€‰
        if criteria.min_score is not None or criteria.max_score is not None:
            filtered = filter_by_score_range(
                filtered,
                min_score=criteria.min_score,
                max_score=criteria.max_score
            )
        
        # 2. æ’åç­›é€‰
        if criteria.top_n is not None:
            filtered = filter_by_top_n(filtered, top_n=criteria.top_n)
        
        # 3. è¡Œä¸šç­›é€‰
        if criteria.industries:
            filtered = filter_by_industries(
                filtered,
                industries=criteria.industries,
                match_all=criteria.match_all_industries
            )
        
        # 4. è¡Œä¸šæƒé‡ç­›é€‰
        if criteria.industry_weights and criteria.min_industry_weight:
            filtered = filter_by_industry_weights(
                filtered,
                industry_weights=criteria.industry_weights,
                min_weight=criteria.min_industry_weight
            )
        
        # 5. æ—¶é—´çª—å£ç­›é€‰
        if criteria.time_window_days:
            filtered = filter_by_time_window(
                filtered,
                days=criteria.time_window_days
            )
        
        # 6. æŒç»­æ€§ç­›é€‰
        if criteria.min_persistence_days:
            filtered = filter_by_persistence(
                filtered,
                min_days=criteria.min_persistence_days
            )
        
        # 7. è¶‹åŠ¿ç­›é€‰
        if criteria.require_trend_up and criteria.min_trend_days:
            filtered = filter_by_trend(
                filtered,
                min_trend_days=criteria.min_trend_days
            )
        
        return filtered
    
    def sort(
        self,
        mainlines: List[Mainline],
        sort_by: str = "score",
        order: str = "desc"
    ) -> List[Mainline]:
        """
        æ’åºç­›é€‰ç»“æœ
        
        Args:
            mainlines: ä¸»çº¿åˆ—è¡¨
            sort_by: æ’åºå­—æ®µï¼ˆscore/duration/industry_score/rotation_scoreï¼‰
            order: æ’åºé¡ºåºï¼ˆasc/descï¼‰
        
        Returns:
            æ’åºåçš„ä¸»çº¿åˆ—è¡¨
        """
        reverse = (order == "desc")
        
        if sort_by == "score":
            sorted_mainlines = sorted(
                mainlines,
                key=lambda m: m.score.total_score,
                reverse=reverse
            )
        elif sort_by == "duration":
            sorted_mainlines = sorted(
                mainlines,
                key=lambda m: getattr(m, 'duration', 0),
                reverse=reverse
            )
        elif sort_by == "industry_score":
            sorted_mainlines = sorted(
                mainlines,
                key=lambda m: getattr(m, 'industry_score', 0),
                reverse=reverse
            )
        elif sort_by == "rotation_score":
            sorted_mainlines = sorted(
                mainlines,
                key=lambda m: getattr(m, 'rotation_score', 0),
                reverse=reverse
            )
        else:
            sorted_mainlines = mainlines
        
        return sorted_mainlines

# ä½¿ç”¨ç¤ºä¾‹
filter = MainlineFilter()

# è®¾ç½®ç­›é€‰æ¡ä»¶
criteria = FilterCriteria(
    min_score=70.0,              # æœ€ä½è¯„åˆ†70åˆ†
    top_n=10,                    # æ’åå‰10
    industries=["æ–°èƒ½æº", "äººå·¥æ™ºèƒ½"],  # è¡Œä¸šç­›é€‰
    time_window_days=30,         # æœ€è¿‘30å¤©
    min_persistence_days=5,      # æŒç»­è‡³å°‘5å¤©
    require_trend_up=True,       # è¦æ±‚è¶‹åŠ¿å‘ä¸Š
    min_trend_days=3            # è¶‹åŠ¿è‡³å°‘3å¤©
)

# æ‰§è¡Œç­›é€‰
mainlines = get_all_mainlines()
filtered_mainlines = filter.filter(mainlines, criteria)

# æ’åº
sorted_mainlines = filter.sort(
    filtered_mainlines,
    sort_by=<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.2/code_4_2___init__.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
import schedule
import time
from datetime import datetime

class MainlineFilterMonitor:
    """ä¸»çº¿ç­›é€‰ç›‘æ§å™¨"""
    
    def __init__(self):
        self.filter = MainlineFilter()
        self.current_filtered = []
        self.last_update_time = None
    
    def auto_filter(self):
        """è‡ªåŠ¨ç­›é€‰ä¸»çº¿"""
        # è·å–æ‰€æœ‰ä¸»çº¿
        mainlines = get_all_mainlines()
        
        # è®¾ç½®ç­›é€‰æ¡ä»¶ï¼ˆå¯æ ¹æ®å¸‚åœºç¯å¢ƒåŠ¨æ€è°ƒæ•´ï¼‰
        criteria = self._get_auto_criteria()
        
        # æ‰§è¡Œç­›é€‰
        filtered = self.filter.filter(mainlines, criteria)
        
        # æ’åº
        sorted_mainlines = self.filter.sort(
            filtered,
            sort_by="score",
            order="desc"
        )
        
        # æ›´æ–°ç»“æœ
        self.current_filtered = sorted_mainlines
        self.last_update_time = datetime.now()
        
        logger.info(f"è‡ªåŠ¨ç­›é€‰å®Œæˆï¼Œç­›é€‰å‡º{len(sorted_mainlines)}æ¡ä¸»çº¿")
        
        return sorted_mainlines
    
    def _get_auto_criteria(self) -> FilterCriteria:
        """è·å–è‡ªåŠ¨ç­›é€‰æ¡ä»¶ï¼ˆå¯æ ¹æ®å¸‚åœºç¯å¢ƒåŠ¨æ€è°ƒæ•´ï¼‰"""
        # è·å–å¸‚åœºçŠ¶æ€
        market_status = get_market_status()
        
        if market_status['regime'] == 'risk_on':
            # ç‰›å¸‚ï¼šæé«˜è¯„åˆ†é˜ˆå€¼ï¼Œå…³æ³¨æŠ€æœ¯å½¢æ€
            return FilterCriteria(
                min_score=75.0,
                top_n=10,
                require_trend_up=True
            )
        elif market_status['regime'] == 'risk_off':
            # ç†Šå¸‚ï¼šé™ä½è¯„åˆ†é˜ˆå€¼ï¼Œå…³æ³¨ä¼°å€¼
            return FilterCriteria(
                min_score=60.0,
                top_n=5
            )
        else:
            # éœ‡è¡å¸‚ï¼šä¸­ç­‰é˜ˆå€¼
            return FilterCriteria(
                min_score=70.0,
                top_n=8
            )
    
    def start_auto_filter(self, interval_minutes: int = 60):
        """
        å¯åŠ¨è‡ªåŠ¨ç­›é€‰
        
        Args:
            interval_minutes: ç­›é€‰é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
        """
        schedule.every(interval_minutes).minutes.do(self.auto_filter)
        
        # ç«‹å³æ‰§è¡Œä¸€æ¬¡
        self.auto_filter()
        
        # æŒç»­è¿è¡Œ
        while True:
            schedule.run_pend<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.2/code_4_2_kb.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
# æŸ¥è¯¢ä¸»çº¿ç­›é€‰ç›¸å…³çš„çŸ¥è¯†
results = mcp_client.call_tool(
    "kb.query",
    {
        "query": <CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.2/code_4_2_data_collector.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
# çˆ¬å–ç­›é€‰ç®—æ³•ç›¸å…³ç½‘é¡µ
content = mcp_client.call_tool(
    "data_collector.crawl_web",
    {
        "url": "https://example.com/filtering-algorithm",
        "extract_text": True
    }
)
```
-->es()
        
        # è®¾ç½®ç­›é€‰æ¡ä»¶ï¼ˆå¯æ ¹æ®å¸‚åœºç¯å¢ƒåŠ¨æ€è°ƒæ•´ï¼‰
        criteria = self._get_auto_criteria()
        
        # æ‰§è¡Œç­›é€‰
        filtered = self.filter.filter(mainlines, criteria)
        
        # æ’åº
        sorted_mainlines = self.filter.sort(
            filtered,
            sort_by="score",
            order="desc"
        )
        
        # æ›´æ–°ç»“æœ
        self.current_filtered = sorted_mainlines
        self.last_update_time = datetime.now()
        
        logger.info(f"è‡ªåŠ¨ç­›é€‰å®Œæˆï¼Œç­›é€‰å‡º{len(sorted_mainlines)}æ¡ä¸»çº¿")
        
        return sorted_mainlines
    
    def _get_auto_criteria(self) -> FilterCriteria:
        """è·å–è‡ªåŠ¨ç­›é€‰æ¡ä»¶ï¼ˆå¯æ ¹æ®å¸‚åœºç¯å¢ƒåŠ¨æ€è°ƒæ•´ï¼‰"""
        # è·å–å¸‚åœºçŠ¶æ€
        market_status = get_market_status()
        
        if market_status['regime'] == 'risk_on':
            # ç‰›å¸‚ï¼šæé«˜è¯„åˆ†é˜ˆå€¼ï¼Œå…³æ³¨æŠ€æœ¯å½¢æ€
            return FilterCriteria(
                min_score=75.0,
                top_n=10,
                require_trend_up=True
            )
        elif market_status['regime'] == 'risk_off':
            # ç†Šå¸‚ï¼šé™ä½è¯„åˆ†é˜ˆå€¼ï¼Œå…³æ³¨ä¼°å€¼
            return FilterCriteria(
                min_score=60.0,
                top_n=5
            )
        else:
            # éœ‡è¡å¸‚ï¼šä¸­ç­‰é˜ˆå€¼
            return FilterCriteria(
                min_score=70.0,
                top_n=8
            )
    
    def start_auto_filter(self, interval_minutes: int = 60):
        """
        å¯åŠ¨è‡ªåŠ¨ç­›é€‰
        
        Args:
            interval_minutes: ç­›é€‰é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
        """
        schedule.every(interval_minutes).minutes.do(self.auto_filter)
        
        # ç«‹å³æ‰§è¡Œä¸€æ¬¡
        self.auto_filter()
        
        # æŒç»­è¿è¡Œ
        while True:
            schedule.run_pending()
            time.sleep(60)
```

<h2 id="section-4-2-6">ğŸ› ï¸ 4.2.6 MCPå·¥å…·ä½¿ç”¨</h2>

ä¸»çº¿ç­›é€‰æ¨¡å—ä¸MCPå·¥å…·é›†æˆï¼Œæ”¯æŒçŸ¥è¯†åº“æŸ¥è¯¢ã€æ•°æ®æ”¶é›†ç­‰åŠŸèƒ½ã€‚

### KB MCP Serverå·¥å…·

#### kb.query

æŸ¥è¯¢çŸ¥è¯†åº“ï¼Œè·å–ä¸»çº¿ç­›é€‰ç›¸å…³çš„æ–‡æ¡£å’Œä»£ç ï¼š

```python
# æŸ¥è¯¢ä¸»çº¿ç­›é€‰ç›¸å…³çš„çŸ¥è¯†
results = mcp_client.call_tool(
    "kb.query",
    {
        "query": "ä¸»çº¿ç­›é€‰ è¯„åˆ†ç­›é€‰ è¡Œä¸šç­›é€‰ æ—¶é—´ç­›é€‰",
        "collection": "manual_kb",
        "top_k": 5
    }
)
```

### Data Collector MCPå·¥å…·

#### data_collector.crawl_web

çˆ¬å–ç½‘é¡µå†…å®¹ï¼Œæ”¶é›†ä¸»çº¿ç­›é€‰ç›¸å…³çš„ç ”ç©¶èµ„æ–™ï¼š

```python
# çˆ¬å–ç­›é€‰ç®—æ³•ç›¸å…³ç½‘é¡µ
content = mcp_client.call_tool(
    "data_collector.crawl_web",
    {
        "url": "https://example.com/filtering-algorithm",
        "extract_text": True
    }
)
```

## ğŸ”— ç›¸å…³ç« èŠ‚

- **ç¬¬2ç« ï¼šæ•°æ®æºæ¨¡å—** - äº†è§£æ•°æ®è·å–æœºåˆ¶ï¼Œä¸ºä¸»çº¿ç­›é€‰æä¾›æ•°æ®æ”¯æ’‘
- **ç¬¬3ç« ï¼šå¸‚åœºåˆ†ææ¨¡å—** - å¸‚åœºåˆ†æç»“æœç”¨äºç­›é€‰æ¡ä»¶è°ƒæ•´
- **ç¬¬4ç« ï¼šæŠ•èµ„ä¸»çº¿è¯†åˆ«** - äº†è§£ä¸»çº¿è¯†åˆ«æ¨¡å—çš„æ•´ä½“è®¾è®¡
- **ç¬¬4.1èŠ‚ï¼šä¸»çº¿è¯„åˆ†** - ä¸»çº¿è¯„åˆ†ç»“æœç”¨äºç­›é€‰
- **ç¬¬5ç« ï¼šå€™é€‰æ± æ„å»º** - ç­›é€‰åçš„ä¸»çº¿ç”¨äºå€™é€‰æ± æ„å»º
- **ç¬¬6ç« ï¼šå› å­åº“** - ç­›é€‰åçš„ä¸»çº¿ç”¨äºå› å­æ¨è
- **ç¬¬10ç« ï¼šå¼€å‘æŒ‡å—** - äº†è§£ä¸»çº¿ç­›é€‰æ¨¡å—çš„å¼€å‘è§„èŒƒ

## ğŸ”® æ€»ç»“ä¸å±•æœ›

<div class="summary-outlook">
  <h3>æœ¬èŠ‚å›é¡¾</h3>
  <p>æœ¬èŠ‚ç³»ç»Ÿä»‹ç»äº†ä¸»çº¿ç­›é€‰åŠŸèƒ½ï¼ŒåŒ…æ‹¬è¯„åˆ†ç­›é€‰ã€è¡Œä¸šç­›é€‰ã€æ—¶é—´ç­›é€‰çš„ç®—æ³•å’Œå®ç°ã€‚é€šè¿‡ç†è§£ä¸»çº¿ç­›é€‰çš„æ ¸å¿ƒæŠ€æœ¯ï¼Œå¸®åŠ©å¼€å‘è€…æŒæ¡å¦‚ä½•ä»ä¼—å¤šä¸»çº¿ä¸­ç­›é€‰å‡ºæœ€æœ‰ä»·å€¼çš„æŠ•èµ„ä¸»çº¿ï¼Œä¸ºå€™é€‰æ± æ„å»ºæä¾›æ–¹å‘æŒ‡å¼•ã€‚</p>
  
  <h3>ä¸‹èŠ‚é¢„å‘Š</h3>
  <p>æŒæ¡äº†ä¸»çº¿ç­›é€‰åï¼Œä¸‹ä¸€èŠ‚å°†ä»‹ç»ä¸»çº¿è¯†åˆ«å¼•æ“ï¼ŒåŒ…æ‹¬ä¸‰å±‚åˆ†ææ¡†æ¶ã€ä¸»çº¿å‘ç°æµç¨‹å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚é€šè¿‡ç†è§£ä¸»çº¿è¯†åˆ«å¼•æ“çš„è®¾è®¡åŸç†ï¼Œå¸®åŠ©å¼€å‘è€…æŒæ¡å¦‚ä½•æ„å»ºæ™ºèƒ½åŒ–çš„æŠ•èµ„ä¸»çº¿è¯†åˆ«ç³»ç»Ÿã€‚</p>
  
  <a href="/ashare-book6/004_Chapter4_Mainline_Identification/4.3_Mainline_Engine_CN" class="next-section">
    ç»§ç»­å­¦ä¹ ï¼š4.3 ä¸»çº¿è¯†åˆ«å¼•æ“ â†’
  </a>
</div>

> **é€‚ç”¨ç‰ˆæœ¬**: v1.0.0+  
> **æœ€åæ›´æ–°**: 2025-12-12
