---
title: "4.4 MCPå·¥å…·é›†æˆ"
description: "æ·±å…¥è§£ææŠ•èµ„ä¸»çº¿è¯†åˆ«æ¨¡å—çš„MCPå·¥å…·é›†æˆï¼ŒåŒ…æ‹¬trquant_mainlineså·¥å…·ã€çŸ¥è¯†åº“æŸ¥è¯¢ç­‰å·¥å…·çš„ä½¿ç”¨"
lang: "zh-CN"
layout: "/src/layouts/HandbookLayout.astro"
currentBook: "ashare-book6"
updateDate: "2025-12-12"
---

# ğŸ› ï¸ 4.4 MCPå·¥å…·é›†æˆ

> **æ ¸å¿ƒæ‘˜è¦ï¼š**
> 
> æœ¬èŠ‚ç³»ç»Ÿä»‹ç»æŠ•èµ„ä¸»çº¿è¯†åˆ«æ¨¡å—ä¸MCPå·¥å…·çš„æ·±åº¦é›†æˆï¼Œæ”¯æŒé€šè¿‡MCPå·¥å…·è¿›è¡ŒæŠ•èµ„ä¸»çº¿æŸ¥è¯¢ã€çŸ¥è¯†åº“æŸ¥è¯¢å’Œæ•°æ®æ”¶é›†ã€‚é€šè¿‡ç†è§£TRQuant MCPå·¥å…·ã€KB MCP Serverå·¥å…·å’ŒData Collectorå·¥å…·çš„ä½¿ç”¨æ–¹æ³•ã€å‚æ•°è¯´æ˜ã€è¿”å›ç»“æœå’Œåº”ç”¨åœºæ™¯ï¼Œå¸®åŠ©å¼€å‘è€…æŒæ¡å¦‚ä½•ä½¿ç”¨MCPå·¥å…·æå‡æŠ•èµ„ä¸»çº¿è¯†åˆ«æ•ˆç‡ï¼Œå®ç°AIå¢å¼ºçš„ä¸»çº¿è¯†åˆ«èƒ½åŠ›ã€‚

æŠ•èµ„ä¸»çº¿è¯†åˆ«æ¨¡å—ä¸MCPå·¥å…·æ·±åº¦é›†æˆï¼Œæä¾›æŠ•èµ„ä¸»çº¿æŸ¥è¯¢ã€çŸ¥è¯†åº“æŸ¥è¯¢ç­‰åŠŸèƒ½ã€‚

## ğŸ“‹ ç« èŠ‚æ¦‚è§ˆ

<script>
function scrollToSection(sectionId) {
  const element = document.getElementById(sectionId);
  if (element) {
    const headerOffset = 100;
    const elementPosition = element.getBoundingClientRect().top;
    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
    window.scrollTo({
      top: offsetPosition,
      behavior: 'smooth'
    });
  }
}
</script>

<div class="section-overview">
  <div class="section-item" onclick="scrollToSection('section-4-4-1')">
    <h4>ğŸ“Š 4.4.1 trquant_mainlineså·¥å…·</h4>
    <p>è·å–æŠ•èµ„ä¸»çº¿çš„å®Œæ•´ä½¿ç”¨æ–¹æ³•ã€å‚æ•°è¯´æ˜ã€è¿”å›ç»“æœå’Œåº”ç”¨åœºæ™¯</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-4-4-2')">
    <h4>ğŸ” 4.4.2 KB MCP Serverå·¥å…·</h4>
    <p>kb.queryçŸ¥è¯†åº“æŸ¥è¯¢å·¥å…·çš„ä½¿ç”¨æ–¹æ³•å’ŒæŸ¥è¯¢æŠ€å·§</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-4-4-3')">
    <h4>ğŸ“¥ 4.4.3 Data Collectorå·¥å…·</h4>
    <p>data_collector.crawl_webç½‘é¡µçˆ¬å–å·¥å…·çš„ä½¿ç”¨æ–¹æ³•å’Œæ•°æ®æ”¶é›†</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-4-4-4')">
    <h4>ğŸ”„ 4.4.4 å·¥å…·é›†æˆå·¥ä½œæµ</h4>
    <p>MCPå·¥å…·åœ¨æŠ•èµ„ä¸»çº¿è¯†åˆ«ä¸­çš„å®Œæ•´å·¥ä½œæµå’Œæœ€ä½³å®è·µ</p>
  </div>
</div>

## ğŸ¯ å­¦ä¹ ç›®æ ‡

é€šè¿‡æœ¬èŠ‚å­¦ä¹ ï¼Œæ‚¨å°†èƒ½å¤Ÿï¼š

- **ä½¿ç”¨trquant_mainlineså·¥å…·**ï¼šæŒæ¡æŠ•èµ„ä¸»çº¿æŸ¥è¯¢çš„å®Œæ•´æ–¹æ³•å’Œåº”ç”¨åœºæ™¯
- **ä½¿ç”¨KB MCPå·¥å…·**ï¼šæŒæ¡çŸ¥è¯†åº“æŸ¥è¯¢æ–¹æ³•å’ŒæŸ¥è¯¢æŠ€å·§
- **ä½¿ç”¨Data Collectorå·¥å…·**ï¼šæŒæ¡æ•°æ®æ”¶é›†æ–¹æ³•å’Œæ•°æ®å¤„ç†
- **æ„å»ºå·¥å…·é›†æˆå·¥ä½œæµ**ï¼šç†è§£MCPå·¥å…·åœ¨æŠ•èµ„ä¸»çº¿è¯†åˆ«ä¸­çš„å®Œæ•´åº”ç”¨æµç¨‹

## ğŸ“š æ ¸å¿ƒæ¦‚å¿µ

### MCPå·¥å…·é›†æˆæ¶æ„

æŠ•èµ„ä¸»çº¿è¯†åˆ«æ¨¡å—é€šè¿‡MCPï¼ˆModel Context Protocolï¼‰åè®®ä¸AIå·¥å…·é“¾æ·±åº¦é›†æˆï¼š

1. **TRQuant MCP Server**ï¼šæä¾›æŠ•èµ„ä¸»çº¿è¯†åˆ«ç›¸å…³çš„ä¸“ä¸šå·¥å…·
2. **KB MCP Server**ï¼šæä¾›çŸ¥è¯†åº“æŸ¥è¯¢èƒ½åŠ›
3. **Data Collector MCP Server**ï¼šæä¾›æ•°æ®æ”¶é›†èƒ½åŠ›

### å·¥å…·è°ƒç”¨æ–¹å¼

åœ¨Cursorä¸­ï¼ŒMCPå·¥å…·å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è°ƒç”¨ï¼š

1. **ç›´æ¥è°ƒç”¨**ï¼šåœ¨AIå¯¹è¯ä¸­ç›´æ¥è¯·æ±‚ä½¿ç”¨å·¥å…·
2. **å‘½ä»¤è°ƒç”¨**ï¼šé€šè¿‡å‘½ä»¤é¢æ¿æ‰§è¡Œç›¸å…³å‘½ä»¤
3. **ä»£ç è°ƒç”¨**ï¼šåœ¨Pythonä»£ç ä¸­é€šè¿‡MCPå®¢æˆ·ç«¯è°ƒç”¨

<h2 id="section-4-4-1">ğŸ“Š 4.4.1 trquant_mainlineså·¥å…·</h2>

`trquant_mainlines`æ˜¯TRQuant MCP Serveræä¾›çš„æ ¸å¿ƒå·¥å…·ï¼Œç”¨äºè·å–å½“å‰Aè‚¡å¸‚åœºçš„æŠ•èµ„ä¸»çº¿ã€‚

### å·¥å…·å®šä¹‰

<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.4/code_4_4_tool_definition.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
MCPTool(
    name="trquant_mainlines",
    description="è·å–å½“å‰Aè‚¡å¸‚åœºçš„æŠ•èµ„ä¸»çº¿ï¼ŒåŒ…æ‹¬ä¸»çº¿åç§°ã€è¯„åˆ†ã€ç›¸å…³è¡Œä¸šå’ŒæŠ•èµ„é€»è¾‘",
    input_schema={
        "type": "object",
        "properties": {
            "top_n": {
                "type": "integer",
                "description": "è¿”å›å‰Næ¡ä¸»çº¿ï¼Œé»˜è®¤10",
                "default": 10
            },
            "time_horizon": {
                "type": "string",
                "enum": ["short", "medium", "long"],
                "description": "æŠ•èµ„å‘¨æœŸï¼šshort(1-5å¤©)ã€medium(1-4å‘¨)ã€long(1æœˆ+)",
                "default": "short"
            }
        },
        "required": []
    }
)
```
-->

### å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | å¿…å¡« | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|------|--------|------|
| top_n | integer | å¦ | 10 | è¿”å›å‰Næ¡ä¸»çº¿ï¼ŒèŒƒå›´1-50 |
| time_horizon | string | å¦ | "short" | æŠ•èµ„å‘¨æœŸï¼šshort(1-5å¤©)/medium(1-4å‘¨)/long(1æœˆ+) |

**time_horizonå‚æ•°è¯¦è§£**ï¼š

- `short`ï¼š1-5å¤©ï¼Œé€‚åˆçŸ­çº¿äº¤æ˜“ç­–ç•¥<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.4/code_4_4_use_in_python.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
from mcp import MCPClient

# åˆå§‹åŒ–MCPå®¢æˆ·ç«¯
client = MCPClient(server_url="http://localhost:8000")

# è·å–çŸ­æœŸæŠ•èµ„ä¸»çº¿
short_mainlines = client.call_tool(
    "trquant_mainlines",
    {
        "time_horizon": "short",
        "top_n": 10
    }
)

# è·å–ä¸­æœŸæŠ•èµ„ä¸»çº¿
medium_mainlines = client.call_tool(
    "trquant_mainlines",
    {
        "time_horizon": "medium",
        "top_n": 20
    }
)

# è·å–é•¿æœŸæŠ•èµ„ä¸»çº¿
long_mainlines = client.call_tool(
    "trquant_mainlines",
    {
        "time_horizon": "long",
        "top_n": 15
    }
)

# å¤„ç†ç»“æœ
for mainline in short_mainlines:
    if mainline['score'] >= 80:
        print(f"é«˜è¯„åˆ†ä¸»çº¿: {mainline['name']}")
        print(f"è¯„åˆ†: {mainline['score']}")
        print(f"ç›¸å…³è¡Œä¸š: {mainline['industries']}")
        print(f"æŠ•èµ„é€»è¾‘: {mainline['logic']}")
        print(f"ç”Ÿå‘½å‘¨æœŸ: {mainline['stage']}")
        print<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.4/code_4_4_return_result.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
[
    {
        "name": "AIç®—åŠ›åŸºç¡€è®¾æ–½",
        "score": 85,
        "industries": ["åŠå¯¼ä½“è®¾å¤‡", "æœåŠ¡å™¨", "å…‰æ¨¡å—"],
        "logic": "AIåº”ç”¨çˆ†å‘å¸¦åŠ¨ç®—åŠ›éœ€æ±‚ï¼Œæ”¿ç­–æ”¯æŒç®—åŠ›åŸºç¡€è®¾æ–½å»ºè®¾ï¼Œç›¸å…³å…¬å¸ä¸šç»©å¢é•¿ç¡®å®šæ€§å¼º",
        "stage": "growing",        # ç”Ÿå‘½å‘¨æœŸé˜¶æ®µï¼šemerging/growing/mature/declining
        "type": "industry",        # ä¸»çº¿ç±»å‹ï¼špolicy/industry/event/cycle/theme
        "recommendation": "strong_buy",  # æ¨èç­‰çº§ï¼šstrong_buy/buy/hold/sell
        "position_suggestion": 0.3,      # å»ºè®®ä»“ä½ï¼ˆ0-1ï¼‰
        "score_details": {
            "policy": 18,      # æ”¿ç­–æ”¯æŒåº¦è¯„åˆ†
            "capital": 20,      # èµ„é‡‘è®¤å¯åº¦è¯„åˆ†
            "industry": 17,    # äº§ä¸šæ™¯æ°”åº¦è¯„åˆ†
            "technical": 15,   # æŠ€æœ¯å½¢æ€åº¦è¯„åˆ†
            "valuation": 10,   # ä¼°å€¼åˆç†åº¦è¯„åˆ†
            "foresight": 5     # å‰ç»é¢†å…ˆåº¦è¯„åˆ†
        },
        "key_stocks": [
            {
                "symbol": "000001.SZ",
                "name": "è‚¡ç¥¨åç§°",
                "role": "é¢†æ¶¨",
                "return": 0.15
            }
        ],
        "catalysts": [
            {
                "date": "2025-12-20",
                "event": "æ”¿ç­–å‘å¸ƒ",
                "impact": "high"
            }
        ]
    },
    # ... æ›´å¤šä¸»çº¿
]
```
-->         {
                "symbol": "000001.SZ",
                "name": "è‚¡ç¥¨åç§°",
                "role": "é¢†æ¶¨",
                "return": 0.15
            }
        ],
        "catalysts": [
            {
                "date": "2025-12-20",
                "event": "æ”¿ç­–å‘å¸ƒ",
                "impact": "high"
            }
        ]
    },
    # ... æ›´å¤šä¸»çº¿
]
```

### ç»“æœè§£è¯»

#### ä¸»çº¿è¯„åˆ†

<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.4/code_4_4_1.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
# è·å–é«˜è¯„åˆ†ä¸»çº¿
mainlines = client.call_tool(
    "trquant_mainlines",
    {"time_horizon": "medium", "top_n": 10}
)

# æ ¹æ®ä¸»çº¿æ„å»ºå€™é€‰æ± 
for mainline in mainlines:
    if mainline['score'] >= 80:
        # é«˜è¯„åˆ†ä¸»çº¿ï¼Œç”¨äºå€™é€‰æ± æ„å»º
        candidate_pool = build_candidat<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.4/code_4_4_2.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
# æ ¹æ®ä¸»çº¿ç±»å‹æ¨èå› å­
for mainline in mainlines:
    if mainline['type'] == 'policy':
        # æ”¿ç­–é©±åŠ¨å‹ï¼Œæ¨èæ”¿ç­–ç›¸å…³å› å­
        factors = recomm<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.4/code_4_4_3.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
# æ ¹æ®ä¸»çº¿ç”Ÿæˆç­–ç•¥
for mainline in mainlines:
    if mainline['score'] >= 80 and mainline['stage'] == 'growing':
        # é«˜è¯„åˆ†æˆé•¿æœŸä¸»çº¿ï¼Œç”Ÿæˆç­–ç•¥
        strategy = generate_strategy(
            mainline=mainline,
            position=mainline['position_suggestion'],
            stop_loss=0.08,
            take_p<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.4/code_4_4_tool_definition.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
MCPTool(
    name="kb.query",
    description="æŸ¥è¯¢çŸ¥è¯†åº“ï¼Œè·å–ç›¸å…³æ–‡æ¡£å’Œä»£ç ",
    input_schema={
        "type": "object",
        "properties": {
            "query": {
                "type": "string",
                "description": "æŸ¥è¯¢å…³é”®è¯æˆ–é—®é¢˜"
            },
            "collection": {
                "type": "string",
                "enum": ["manual_kb", "engineering_kb", "both"],
                "description": "æŸ¥è¯¢èŒƒå›´ï¼šmanual_kbï¼ˆæ‰‹å†Œï¼‰/engineering_kbï¼ˆä»£ç åº“ï¼‰/bothï¼ˆä¸¤è€…ï¼‰",
                "default": "both"
            },
            "top_k": {
                "type": "integer",
                "description": "è¿”å›å‰Kä¸ªç»“æœï¼Œé»˜è®¤5",
                "default": 5
            }
        },
        "required": ["query"]
    }
)
```
-->ç•¥
        strategy = generate_strategy(
            mainline=mainline,
            positio<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.4/code_4_4_query_mainline_docs.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
# æŸ¥è¯¢ä¸»çº¿è¯†åˆ«ç›¸å…³çš„å¼€å‘æ–‡æ¡£
results = client.call_tool(
    "kb.query",
    {
        "query": "æŠ•èµ„ä¸»çº¿è¯†åˆ« å¤šç»´åº¦è¯„åˆ† ä¸»çº¿ç­›é€‰ç®—æ³•",
        "collection": "manual_kb",
        "top_k": 5
    }
)

# å¤„ç†ç»“æœ
for result in results:
    print(f"æ–‡æ¡£: {result<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.4/code_4_4_query_mainline_code.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
# æŸ¥è¯¢ä¸»çº¿è¯†åˆ«ç›¸å…³çš„ä»£ç å®ç°
results = client.call_tool(
    "kb.query",
    {
        "query": "ä¸»çº¿è¯†åˆ«å¼•æ“ ä¸‰å±‚åˆ†ææ¡†æ¶ ä¸»çº¿å‘ç°æµç¨‹",
        "collection": "engineering_kb",
        "top_k": 10
    }
)

# å¤„ç†ç»“æœ
for result in results:
    print(f"æ–‡ä»¶: {result['file_path']}")<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.4/code_4_4_discover_mainlines.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
[
    {
        "title": "4.3 ä¸»çº¿è¯†åˆ«å¼•æ“",
        "file_path": "/ashare-book6/004_Chapter4_Mainline_Identification/4.3_Mainline_Engine_CN.md",
        "snippet": "ä¸»çº¿è¯†åˆ«å¼•æ“æ˜¯æŠ•èµ„ä¸»çº¿è¯†åˆ«æ¨¡å—çš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£é€šè¿‡ä¸‰å±‚åˆ†ææ¡†æ¶å‘ç°å’Œè¯†åˆ«æŠ•èµ„ä¸»çº¿...",
        "score": 0.95,
        "type": "document"
    },
    {
        "file_path": "markets/ashare/mainline/engine.py",
        "function_name": "discover_mainlines",
        "code_snippet": "def discover_mainlines(self, include_emerging: bool = True, min_score: float = 60) -> List[Mainline]:\n    # ä¸»çº¿å‘ç°æµç¨‹å®ç°...",
        "score": 0.88,
        "type": "code"
    },
    # ... æ›´å¤šç»“æœ
]
```
--> collection | string | å¦ | "both" | æŸ¥è¯¢èŒƒå›´ï¼šmanual_kb/engineering_kb/both |
| top_k | integer | å¦ | 5 | è¿”å›å‰Kä¸ªç»“æœï¼ŒèŒƒå›´1-20 |

#### ä½¿ç”¨ç¤ºä¾‹

**æŸ¥è¯¢ä¸»çº¿è¯†åˆ«ç›¸å…³æ–‡æ¡£**ï¼š

```python
# æŸ¥è¯¢ä¸»çº¿è¯†åˆ«ç›¸å…³çš„å¼€å‘æ–‡æ¡£
results = client.call_tool(
    "kb.query",
    {
        "query": "æŠ•èµ„ä¸»çº¿è¯†åˆ« å¤šç»´åº¦è¯„åˆ† ä¸»çº¿ç­›é€‰ç®—æ³•",
        "collection": "manual_kb",
        "top_k": 5
    }
)

# å¤„ç†ç»“æœ
for result in results:
    print(f"æ–‡æ¡£: {result['title']}")
    print(f"æ–‡ä»¶è·¯å¾„: {result['file_path']}")
    print(f"ç›¸å…³æ€§: {result['<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.4/code_4_4_tool_definition.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
MCPTool(
    name="data_collector.crawl_web",
    description="çˆ¬å–ç½‘é¡µå†…å®¹ï¼Œæå–æ–‡æœ¬å’Œé“¾æ¥",
    input_schema={
        "type": "object",
        "properties": {
            "url": {
                "type": "string",
                "description": "ç›®æ ‡ç½‘é¡µURL"
            },
            "extract_text": {
                "type": "boolean",
                "description": "æ˜¯å¦æå–æ–‡æœ¬å†…å®¹ï¼Œé»˜è®¤true",
                "default": true
            },
            "max_depth": {
                "type": "integer",
                "description": "æœ€å¤§çˆ¬å–æ·±åº¦ï¼Œé»˜è®¤1",
                "default": 1
            },
            "output_dir": {
                "type": "string",
                "description": "è¾“å‡ºç›®å½•ï¼Œé»˜è®¤data/collected",
                "default": "data/collected"
            }
        },
        "required": ["url"]
    }
)
```
-->        "file_path": "markets/ashare/mainline/engine.py",
        "function_name": "discover_mainlines",
        "code_s<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.4/code_4_4_crawl_mainline_web.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
# çˆ¬å–ä¸»çº¿åˆ†æç›¸å…³ç½‘é¡µ
result = client.call_tool(
    "data_collector.crawl_web",
    {
        "url": "https://example.com/mainline-analysis",
        "extract_text": True,
        "max_depth": 2,
        "output_dir": "data/collected/mainline_analysis"
    }
)

# å¤„ç†<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.4/code_4_4_return_result.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
{
    "pages_crawled": 5,
    "text_length": 50000,
    "output_path": "data/collected/mainline_analysis",
    "files": [
        "page_1.html",
        "page_2.html",
        "page_3.html"
    ],
    "timestamp": "2025-12-12T10:00:00"
}
```
-->
   - å¿«é€ŸæŸ¥è¯¢ï¼š`top_k=3`
   - è¯¦ç»†æŸ¥è¯¢ï¼š`top_k=10`

#### åº”ç”¨åœº<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.4/code_4_4_complete_workflow_example.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
# 1. è·å–å¸‚åœºçŠ¶æ€ï¼ˆä½¿ç”¨trquant_market_statusï¼‰
market_status = client.call_tool(
    "trquant_market_status",
    {"universe": "CN_EQ"}
)

# 2. æ ¹æ®å¸‚åœºçŠ¶æ€é€‰æ‹©æŠ•èµ„å‘¨æœŸ
if market_status["regime"] == "risk_on":
    time_horizon = "short"  # é£é™©åå¥½ä¸Šå‡ï¼Œé€‰æ‹©çŸ­æœŸä¸»çº¿
elif market_status["regime"] == "risk_off":
    time_horizon = "long"  # é£é™©åå¥½ä¸‹é™ï¼Œé€‰æ‹©é•¿æœŸä¸»çº¿
else:
    time_horizon = "medium"  # éœ‡è¡å¸‚åœºï¼Œé€‰æ‹©ä¸­æœŸä¸»çº¿

# 3. è·å–æŠ•èµ„ä¸»çº¿
mainlines = client.call_tool(
    "trquant_mainlines",
    {
        "time_horizon": time_horizon,
        "top_n": 10
    }
)

# 4. æŸ¥è¯¢ç›¸å…³çŸ¥è¯†åº“
knowledge = client.call_tool(
    "kb.query",
    {
        "query": f"æŠ•èµ„ä¸»çº¿è¯†åˆ« {time_horizon} ç­–ç•¥",
        "collection": "both",
        "top_k": 5
    }
)

# 5. æ”¶é›†å¤–éƒ¨èµ„æ–™ï¼ˆå¦‚éœ€è¦ï¼‰
if len(mainlines) < 5:
    external_data = client.call_tool(
        "data_collector.crawl_web",
        {
            "url": "https://example.com/mainline-analysis",
            "extract_text": True
        }
    )

# 6. ç»¼åˆåˆ†æå¹¶ç”ŸæˆæŠ•èµ„å»ºè®®
investment_advice = generate_advice(
    market_status=market_status,
    mainlines=mainlines,
    knowledge=knowledge
)
```
-->     "required": ["url<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.4/code_4_4_safe_call_tool.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
def safe_call_tool(tool_name: str, params: dict, max_retries: int = 3):
    """å®‰å…¨è°ƒç”¨MCPå·¥å…·ï¼Œå¸¦é‡è¯•æœºåˆ¶"""
    for attempt in range(max_retries):
        try:
            result = client.call_tool(tool_name, params)
            return result
        except Exception as e:
            log<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.4/code_4_4_get_cached_mainlines.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
from functools import lru_cache
from datetime import datetime, timedelta

@lru_cache(maxsize=100)
def get_cached_mainlines(time_horizon: str, top_n: int, cache_key: str):
    <CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.4/code_4_4_validate_mainlines.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
def validate_mainlines(mainlines: List[Dict]) -> List[Dict]:
    """éªŒè¯ä¸»çº¿ç»“æœ"""
    validated = []
    for mainline in mainlines:
        # éªŒè¯å¿…è¦å­—æ®µ
        required_fields = ['name', 'score', 'industries', 'logic']
        if all(field in mainline for field i<CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.4/code_4_4_market_analysis.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
# è·å–å¸‚åœºçŠ¶æ€
market_status = client.call_tool("trquant_market_status", {"universe": "CN_EQ"})

# æ ¹æ®å¸‚åœºçŠ¶æ€é€‰æ‹©æŠ•èµ„å‘¨æœŸ
if market_status["regime"] == "risk_on":
    time_horizon = "short"  # çŸ­æœŸä¸»çº¿
elif market_status["regime"] == "risk_off":
    time_horizon = "long"  # é•¿æœŸä¸»çº¿
else:
   <CodeFromFile 
  filePath="code_library/004_Chapter4_Mainline_Identification/4.4/code_4_4_knowledge_base_query.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- åŸå§‹ä»£ç ï¼ˆä¿ç•™ä½œä¸ºå¤‡ä»½ï¼‰ï¼š
```python
# æŸ¥è¯¢ç›¸å…³çŸ¥è¯†
knowledge = client.call_tool(
    "kb.query",
    {"query": "æŠ•èµ„ä¸»çº¿è¯†åˆ« å¤šç»´åº¦è¯„åˆ†", "collection": "both"}
)

# å¦‚æœçŸ¥è¯†åº“ç»“æœä¸è¶³ï¼Œæ”¶é›†å¤–éƒ¨èµ„æ–™
if len(knowledge) < 3:
    external_data = client.call_tool(
        "data_collector.crawl_web",
        {"url": "https://example.com/mainline-analysis"}
    )
```
-->all_tool(
    "trquant_market_status",
    {"universe": "CN_EQ"}
)

# 2. æ ¹æ®å¸‚åœºçŠ¶æ€é€‰æ‹©æŠ•èµ„å‘¨æœŸ
if market_status["regime"] == "risk_on":
    time_horizon = "short"  # é£é™©åå¥½ä¸Šå‡ï¼Œé€‰æ‹©çŸ­æœŸä¸»çº¿
elif market_status["regime"] == "risk_off":
    time_horizon = "long"  # é£é™©åå¥½ä¸‹é™ï¼Œé€‰æ‹©é•¿æœŸä¸»çº¿
else:
    time_horizon = "medium"  # éœ‡è¡å¸‚åœºï¼Œé€‰æ‹©ä¸­æœŸä¸»çº¿

# 3. è·å–æŠ•èµ„ä¸»çº¿
mainlines = client.call_tool(
    "trquant_mainlines",
    {
        "time_horizon": time_horizon,
        "top_n": 10
    }
)

# 4. æŸ¥è¯¢ç›¸å…³çŸ¥è¯†åº“
knowledge = client.call_tool(
    "kb.query",
    {
        "query": f"æŠ•èµ„ä¸»çº¿è¯†åˆ« {time_horizon} ç­–ç•¥",
        "collection": "both",
        "top_k": 5
    }
)

# 5. æ”¶é›†å¤–éƒ¨èµ„æ–™ï¼ˆå¦‚éœ€è¦ï¼‰
if len(mainlines) < 5:
    external_data = client.call_tool(
        "data_collector.crawl_web",
        {
            "url": "https://example.com/mainline-analysis",
            "extract_text": True
        }
    )

# 6. ç»¼åˆåˆ†æå¹¶ç”ŸæˆæŠ•èµ„å»ºè®®
investment_advice = generate_advice(
    market_status=market_status,
    mainlines=mainlines,
    knowledge=knowledge
)
```

### æœ€ä½³å®è·µ

#### 1. å·¥å…·è°ƒç”¨é¡ºåº

**æ¨èé¡ºåº**ï¼š
1. å…ˆè·å–å¸‚åœºçŠ¶æ€ï¼ˆ`trquant_market_status`ï¼‰
2. æ ¹æ®å¸‚åœºçŠ¶æ€é€‰æ‹©æŠ•èµ„å‘¨æœŸ
3. è·å–æŠ•èµ„ä¸»çº¿ï¼ˆ`trquant_mainlines`ï¼‰
4. æŸ¥è¯¢ç›¸å…³çŸ¥è¯†åº“ï¼ˆ`kb.query`ï¼‰
5. æ”¶é›†å¤–éƒ¨èµ„æ–™ï¼ˆå¦‚éœ€è¦ï¼Œ`data_collector.crawl_web`ï¼‰

#### 2. é”™è¯¯å¤„ç†

```python
def safe_call_tool(tool_name: str, params: dict, max_retries: int = 3):
    """å®‰å…¨è°ƒç”¨MCPå·¥å…·ï¼Œå¸¦é‡è¯•æœºåˆ¶"""
    for attempt in range(max_retries):
        try:
            result = client.call_tool(tool_name, params)
            return result
        except Exception as e:
            logger.warning(f"å·¥å…·è°ƒç”¨å¤±è´¥ (å°è¯• {attempt + 1}/{max_retries}): {e}")
            if attempt == max_retries - 1:
                raise
            time.sleep(1)  # ç­‰å¾…1ç§’åé‡è¯•
```

#### 3. ç»“æœç¼“å­˜

```python
from functools import lru_cache
from datetime import datetime, timedelta

@lru_cache(maxsize=100)
def get_cached_mainlines(time_horizon: str, top_n: int, cache_key: str):
    """ç¼“å­˜ä¸»çº¿æŸ¥è¯¢ç»“æœï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆæœŸï¼‰"""
    # cache_keyåŒ…å«æ—¥æœŸï¼Œç¡®ä¿æ¯å¤©æ›´æ–°
    return client.call_tool(
        "trquant_mainlines",
        {"time_horizon": time_horizon, "top_n": top_n}
    )
```

#### 4. ç»“æœéªŒè¯

```python
def validate_mainlines(mainlines: List[Dict]) -> List[Dict]:
    """éªŒè¯ä¸»çº¿ç»“æœ"""
    validated = []
    for mainline in mainlines:
        # éªŒè¯å¿…è¦å­—æ®µ
        required_fields = ['name', 'score', 'industries', 'logic']
        if all(field in mainline for field in required_fields):
            # éªŒè¯è¯„åˆ†èŒƒå›´
            if 0 <= mainline['score'] <= 100:
                validated.append(mainline)
    return validated
```

### å·¥å…·ç»„åˆä½¿ç”¨

#### å¸‚åœºåˆ†æ + ä¸»çº¿è¯†åˆ«

```python
# è·å–å¸‚åœºçŠ¶æ€
market_status = client.call_tool("trquant_market_status", {"universe": "CN_EQ"})

# æ ¹æ®å¸‚åœºçŠ¶æ€é€‰æ‹©æŠ•èµ„å‘¨æœŸ
if market_status["regime"] == "risk_on":
    time_horizon = "short"  # çŸ­æœŸä¸»çº¿
elif market_status["regime"] == "risk_off":
    time_horizon = "long"  # é•¿æœŸä¸»çº¿
else:
    time_horizon = "medium"  # ä¸­æœŸä¸»çº¿

# è·å–æŠ•èµ„ä¸»çº¿
mainlines = client.call_tool(
    "trquant_mainlines",
    {"time_horizon": time_horizon, "top_n": 10}
)
```

#### çŸ¥è¯†åº“æŸ¥è¯¢ + æ•°æ®æ”¶é›†

```python
# æŸ¥è¯¢ç›¸å…³çŸ¥è¯†
knowledge = client.call_tool(
    "kb.query",
    {"query": "æŠ•èµ„ä¸»çº¿è¯†åˆ« å¤šç»´åº¦è¯„åˆ†", "collection": "both"}
)

# å¦‚æœçŸ¥è¯†åº“ç»“æœä¸è¶³ï¼Œæ”¶é›†å¤–éƒ¨èµ„æ–™
if len(knowledge) < 3:
    external_data = client.call_tool(
        "data_collector.crawl_web",
        {"url": "https://example.com/mainline-analysis"}
    )
```

## ğŸ”— ç›¸å…³ç« èŠ‚

- **4.1 ä¸»çº¿è¯„åˆ†**ï¼šäº†è§£ä¸»çº¿è¯„åˆ†æ–¹æ³•ï¼Œç†è§£`trquant_mainlines`å·¥å…·è¿”å›çš„è¯„åˆ†
- **4.2 ä¸»çº¿ç­›é€‰**ï¼šäº†è§£ä¸»çº¿ç­›é€‰æœºåˆ¶ï¼Œç†è§£å¦‚ä½•ä½¿ç”¨ç­›é€‰åçš„ä¸»çº¿
- **4.3 ä¸»çº¿è¯†åˆ«å¼•æ“**ï¼šäº†è§£ä¸»çº¿è¯†åˆ«å¼•æ“ï¼Œç†è§£ä¸»çº¿å‘ç°æµç¨‹
- **ç¬¬5ç« ï¼šå€™é€‰æ± æ„å»º**ï¼šäº†è§£å¦‚ä½•ä½¿ç”¨`trquant_mainlines`å·¥å…·è·å–çš„ä¸»çº¿æ„å»ºå€™é€‰æ± 
- **ç¬¬10ç« ï¼šå¼€å‘æŒ‡å—**ï¼šäº†è§£MCPå·¥å…·çš„å¼€å‘å’Œä½¿ç”¨æ–¹æ³•

## ğŸ’¡ å…³é”®è¦ç‚¹

1. **trquant_mainlineså·¥å…·**ï¼šæä¾›æŠ•èµ„ä¸»çº¿æŸ¥è¯¢åŠŸèƒ½ï¼Œæ”¯æŒä¸åŒæŠ•èµ„å‘¨æœŸçš„ä¸»çº¿è·å–
2. **KB MCPå·¥å…·**ï¼šæä¾›çŸ¥è¯†åº“æŸ¥è¯¢åŠŸèƒ½ï¼Œæ”¯æŒä¸»çº¿è¯†åˆ«ç›¸å…³ç ”ç©¶å’Œé—®é¢˜è§£å†³
3. **Data Collectorå·¥å…·**ï¼šæä¾›æ•°æ®æ”¶é›†åŠŸèƒ½ï¼Œæ”¯æŒå¤–éƒ¨èµ„æ–™è·å–å’Œç ”ç©¶
4. **å·¥å…·é›†æˆå·¥ä½œæµ**ï¼šé€šè¿‡å·¥å…·ç»„åˆä½¿ç”¨ï¼Œæ„å»ºå®Œæ•´çš„æŠ•èµ„ä¸»çº¿è¯†åˆ«å·¥ä½œæµ

## ğŸ”® æ€»ç»“ä¸å±•æœ›

<div class="summary-outlook">
  <h3>æœ¬èŠ‚å›é¡¾</h3>
  <p>æœ¬èŠ‚ç³»ç»Ÿä»‹ç»äº†æŠ•èµ„ä¸»çº¿è¯†åˆ«æ¨¡å—ä¸MCPå·¥å…·çš„æ·±åº¦é›†æˆï¼ŒåŒ…æ‹¬TRQuant MCPå·¥å…·ã€KB MCP Serverå·¥å…·å’ŒData Collectorå·¥å…·çš„ä½¿ç”¨æ–¹æ³•ã€å‚æ•°è¯´æ˜ã€è¿”å›ç»“æœå’Œåº”ç”¨åœºæ™¯ã€‚é€šè¿‡ç†è§£MCPå·¥å…·åœ¨æŠ•èµ„ä¸»çº¿è¯†åˆ«ä¸­çš„åº”ç”¨ï¼Œå¸®åŠ©å¼€å‘è€…æŒæ¡å¦‚ä½•ä½¿ç”¨MCPå·¥å…·æå‡ä¸»çº¿è¯†åˆ«æ•ˆç‡ï¼Œå®ç°AIå¢å¼ºçš„ä¸»çº¿è¯†åˆ«èƒ½åŠ›ã€‚</p>
  
  <h3>ä¸‹èŠ‚é¢„å‘Š</h3>
  <p>æŒæ¡äº†æŠ•èµ„ä¸»çº¿è¯†åˆ«æ¨¡å—åï¼Œä¸‹ä¸€ç« å°†ä»‹ç»å€™é€‰æ± æ„å»ºæ¨¡å—ï¼ŒåŒ…æ‹¬è‚¡ç¥¨æ± ç®¡ç†ã€ç­›é€‰è§„åˆ™å¼•æ“ã€è‚¡ç¥¨è¯„åˆ†ç³»ç»Ÿå’Œå€™é€‰æ± æ„å»ºå™¨ã€‚é€šè¿‡ç†è§£å€™é€‰æ± æ„å»ºçš„æ ¸å¿ƒå®ç°ï¼Œå¸®åŠ©å¼€å‘è€…æŒæ¡å¦‚ä½•æ„å»ºå¯äº¤æ˜“çš„è‚¡ç¥¨å€™é€‰æ± ã€‚</p>
  
  <a href="/ashare-book6/005_Chapter5_Candidate_Pool/005_Chapter5_Candidate_Pool_CN" class="next-section">
    ç»§ç»­å­¦ä¹ ï¼šç¬¬5ç« ï¼šå€™é€‰æ± æ„å»º â†’
  </a>
</div>

> **é€‚ç”¨ç‰ˆæœ¬**: v1.0.0+  
> **æœ€åæ›´æ–°**: 2025-12-12
<!-- Code updated: 2025-12-14T02:17:27.796Z -->
