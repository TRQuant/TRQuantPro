---
title: "9.2 QMTé›†æˆ"
description: "æ·±å…¥è§£æQMTå¹³å°é›†æˆï¼ŒåŒ…æ‹¬APIå°è£…ã€äº¤æ˜“æ¥å£ã€æ•°æ®æ¥å£ã€é£é™©æ§åˆ¶å’Œç­–ç•¥éƒ¨ç½²ï¼Œå®ç°ä¸å›½é‡‘è¯åˆ¸QMTå¹³å°çš„å®Œæ•´é›†æˆ"
lang: "zh-CN"
layout: "/src/layouts/HandbookLayout.astro"
currentBook: "ashare-book6"
updateDate: "2025-12-12"
---

# ğŸ”Œ 9.2 QMTé›†æˆ

> **æ ¸å¿ƒæ‘˜è¦ï¼š**
> 
> æœ¬èŠ‚ç³»ç»Ÿä»‹ç»TRQuantç³»ç»Ÿä¸å›½é‡‘è¯åˆ¸QMTå¹³å°çš„é›†æˆï¼ŒåŒ…æ‹¬QMT APIå°è£…ã€äº¤æ˜“æ¥å£ã€æ•°æ®æ¥å£ã€é£é™©æ§åˆ¶å’Œç­–ç•¥éƒ¨ç½²ã€‚é€šè¿‡ç†è§£QMTé›†æˆçš„æ ¸å¿ƒæŠ€æœ¯ï¼Œå¸®åŠ©å¼€å‘è€…æŒæ¡å¦‚ä½•å°†ç»è¿‡BulletTradeå›æµ‹éªŒè¯çš„ç­–ç•¥éƒ¨ç½²åˆ°QMTå¹³å°ï¼Œå®ç°å®ç›˜äº¤æ˜“å’Œåˆ¸å•†ç¯å¢ƒå›æµ‹ã€‚

QMTé›†æˆæ˜¯TRQuantç³»ç»Ÿå®ç°å®ç›˜äº¤æ˜“çš„å¦ä¸€ä¸ªå…³é”®ç¯èŠ‚ï¼Œè´Ÿè´£å°†ç­–ç•¥ä»å†…éƒ¨å›æµ‹ç¯å¢ƒéƒ¨ç½²åˆ°å›½é‡‘è¯åˆ¸çš„QMTäº¤æ˜“å¹³å°ã€‚

## ğŸ“‹ ç« èŠ‚æ¦‚è§ˆ

<script>
function scrollToSection(sectionId) {
  const element = document.getElementById(sectionId);
  if (element) {
    const headerOffset = 100;
    const elementPosition = element.getBoundingClientRect().top;
    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
    window.scrollTo({
      top: offsetPosition,
      behavior: 'smooth'
    });
  }
}
</script>

<div class="section-overview">
  <div class="section-item" onclick="scrollToSection('section-9-2-1')">
    <h4>ğŸ”Œ 9.2.1 QMTè¿æ¥</h4>
    <p>è¿æ¥é…ç½®ã€è¿æ¥å»ºç«‹ã€è¿æ¥ç®¡ç†ã€å›½é‡‘è¯åˆ¸é…ç½®</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-9-2-2')">
    <h4>ğŸ’¹ 9.2.2 äº¤æ˜“æ¥å£</h4>
    <p>ä¸‹å•ã€æ’¤å•ã€æŸ¥è¯¢ã€è®¢å•ç®¡ç†</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-9-2-3')">
    <h4>ğŸ“Š 9.2.3 æ•°æ®æ¥å£</h4>
    <p>è¡Œæƒ…æ•°æ®ã€è´¦æˆ·æ•°æ®ã€æŒä»“æ•°æ®</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-9-2-4')">
    <h4>ğŸ›¡ï¸ 9.2.4 é£é™©æ§åˆ¶</h4>
    <p>äº¤æ˜“é£æ§ã€æŒä»“é£æ§ã€å®æ—¶ç›‘æ§</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-9-2-5')">
    <h4>ğŸš€ 9.2.5 ç­–ç•¥éƒ¨ç½²</h4>
    <p>ä»£ç è½¬æ¢ã€ç­–ç•¥ä¸Šä¼ ã€éƒ¨ç½²éªŒè¯ã€ä¸ç¬¬8ç« çš„è¡”æ¥</p>
  </div>
</div>

## ğŸ¯ å­¦ä¹ ç›®æ ‡

é€šè¿‡æœ¬èŠ‚å­¦ä¹ ï¼Œæ‚¨å°†èƒ½å¤Ÿï¼š

- **é…ç½®QMTè¿æ¥**ï¼šæŒæ¡å›½é‡‘è¯åˆ¸QMTå¹³å°çš„è¿æ¥é…ç½®æ–¹æ³•
- **ä½¿ç”¨äº¤æ˜“æ¥å£**ï¼šç†è§£ä¸‹å•ã€æ’¤å•ã€æŸ¥è¯¢ç­‰äº¤æ˜“æ¥å£çš„ä½¿ç”¨
- **è·å–æ•°æ®æ¥å£**ï¼šæŒæ¡è¡Œæƒ…æ•°æ®ã€è´¦æˆ·æ•°æ®ã€æŒä»“æ•°æ®çš„è·å–æ–¹æ³•
- **å®ç°é£é™©æ§åˆ¶**ï¼šç†è§£äº¤æ˜“é£æ§å’ŒæŒä»“é£æ§çš„å®ç°æœºåˆ¶
- **éƒ¨ç½²ç­–ç•¥**ï¼šæŒæ¡ä»BulletTradeå›æµ‹åˆ°QMTéƒ¨ç½²çš„å®Œæ•´æµç¨‹

## ğŸ“š æ ¸å¿ƒæ¦‚å¿µ

### æ¨¡å—å®šä½

- **å·¥ä½œæµä½ç½®**ï¼šæ­¥éª¤8 - ğŸš€ å®ç›˜äº¤æ˜“ï¼ˆåˆ¸å•†å¹³å°éƒ¨ç½²ï¼‰
- **æ ¸å¿ƒèŒè´£**ï¼šQMTå¹³å°é›†æˆã€ç­–ç•¥éƒ¨ç½²ã€å®ç›˜äº¤æ˜“æ‰§è¡Œ
- **æœåŠ¡å¯¹è±¡**ï¼šç»è¿‡BulletTradeå›æµ‹éªŒè¯çš„ç­–ç•¥

### æŠ€æœ¯æ ˆ

- **äº¤æ˜“å¹³å°**ï¼šå›½é‡‘è¯åˆ¸QMTï¼ˆè¿…æŠ•é‡åŒ–ç»ˆç«¯ï¼‰
- **è¿æ¥æ–¹å¼**ï¼šQMT APIï¼ˆæœ¬åœ°è¿›ç¨‹é€šä¿¡ï¼‰
- **ç­–ç•¥æ ¼å¼**ï¼šèšå®½é£æ ¼ â†’ QMTæ ¼å¼è½¬æ¢
- **æ•°æ®æº**ï¼šQMTå®æ—¶è¡Œæƒ…ã€è´¦æˆ·æ•°æ®

### ä¸ç¬¬8ç« çš„è¡”æ¥

QMTé›†æˆæ˜¯ç¬¬8ç« å›æµ‹éªŒè¯çš„åç»­ç¯èŠ‚ï¼š

1. **ç¬¬8ç« **ï¼šåœ¨éŸ¬ç¿ç³»ç»Ÿå†…éƒ¨ä½¿ç”¨BulletTrade+èšå®½æ•°æ®æºè¿›è¡Œå›æµ‹éªŒè¯
2. **ç¬¬9ç« **ï¼šå°†éªŒè¯é€šè¿‡çš„ç­–ç•¥éƒ¨ç½²åˆ°QMTå¹³å°è¿›è¡Œåˆ¸å•†ç¯å¢ƒå›æµ‹å’Œå®ç›˜äº¤æ˜“

> **è¯¦ç»†æµç¨‹**ï¼šè¯·å‚è€ƒ[ç¬¬8ç« ï¼šå›æµ‹éªŒè¯](/ashare-book6/008_Chapter8_Backtest/8.1_Backtest_Framework_CN)ä¸­çš„"PTrade/QMTå¹³å°éƒ¨ç½²"éƒ¨åˆ†ã€‚

<h2 id="section-9-2-1">ğŸ”Œ 9.2.1 QMTè¿æ¥</h2>

QMTè¿æ¥æ˜¯å¹³å°é›†æˆçš„åŸºç¡€ï¼Œè´Ÿè´£å»ºç«‹ä¸å›½é‡‘è¯åˆ¸QMTå¹³å°çš„è¿æ¥ã€‚

### è¿æ¥é…ç½®

```python
from dataclasses import dataclass
from typing import Optional

@dataclass
class QMTConfig:
    """QMTè¿æ¥é…ç½®ï¼ˆå›½é‡‘è¯åˆ¸ï¼‰"""
    
    qmt_path: str              # QMTå®‰è£…è·¯å¾„ï¼ˆå¦‚ï¼šC:/QMTï¼‰
    account_id: str            # è´¦æˆ·ID
    password: Optional[str] = None  # å¯†ç ï¼ˆå¯é€‰ï¼‰
    session_id: Optional[int] = None  # ä¼šè¯IDï¼ˆå¯é€‰ï¼‰
    timeout: int = 30          # è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰
    
    def validate(self) -> Tuple[bool, List[str]]:
        """éªŒè¯é…ç½®"""
        errors = []
        
        if not self.qmt_path:
            errors.append("QMTå®‰è£…è·¯å¾„ä¸èƒ½ä¸ºç©º")
        
        if not Path(self.qmt_path).exists():
            errors.append(f"QMTå®‰è£…è·¯å¾„ä¸å­˜åœ¨: {self.qmt_path}")
        
        if not self.account_id:
            errors.append("è´¦æˆ·IDä¸èƒ½ä¸ºç©º")
        
        return len(errors) == 0, errors
```

### QMTè¿æ¥å®ç°

```python
import os
import sys
from pathlib import Path
from typing import Dict, Any, Optional

class QMTConnection:
    """QMTè¿æ¥ç®¡ç†å™¨ï¼ˆå›½é‡‘è¯åˆ¸ï¼‰"""
    
    def __init__(self, config: QMTConfig):
        """
        åˆå§‹åŒ–QMTè¿æ¥
        
        Args:
            config: QMTé…ç½®
        """
        self.config = config
        self.connected = False
        self.session_id: Optional[int] = None
        self.qmt_api = None
    
    def connect(self) -> bool:
        """
        å»ºç«‹QMTè¿æ¥
        
        Returns:
            bool: è¿æ¥æ˜¯å¦æˆåŠŸ
        """
        try:
            # éªŒè¯é…ç½®
            valid, errors = self.config.validate()
            if not valid:
                raise ValueError(f"é…ç½®é”™è¯¯: {errors}")
            
            # æ·»åŠ QMTè·¯å¾„åˆ°ç³»ç»Ÿè·¯å¾„
            qmt_lib_path = Path(self.config.qmt_path) / "userdata_mini" / "python"
            if qmt_lib_path.exists():
                sys.path.insert(0, str(qmt_lib_path))
            
            # å¯¼å…¥QMT API
            try:
                import xtquant.xtdata as xtdata
                import xtquant.xttrader as xttrader
                self.xtdata = xtdata
                self.xttrader = xttrader
            except ImportError as e:
                raise ImportError(f"æ— æ³•å¯¼å…¥QMT APIï¼Œè¯·æ£€æŸ¥QMTå®‰è£…è·¯å¾„: {e}")
            
            # è¿æ¥QMT
            if self._login():
                self.connected = True
                return True
            else:
                return False
                
        except Exception as e:
            logger.error(f"QMTè¿æ¥å¤±è´¥: {e}")
            return False
    
    def _login(self) -> bool:
        """ç™»å½•QMT"""
        try:
            # ä½¿ç”¨QMT APIç™»å½•
            # æ³¨æ„ï¼šQMTçš„ç™»å½•æ–¹å¼å¯èƒ½å› ç‰ˆæœ¬è€Œå¼‚
            # è¿™é‡Œä½¿ç”¨ç¤ºä¾‹ä»£ç ï¼Œå®é™…å®ç°éœ€è¦æ ¹æ®QMT APIæ–‡æ¡£
            
            # æ–¹å¼1ï¼šä½¿ç”¨è´¦æˆ·IDå’Œå¯†ç ç™»å½•
            if self.config.password:
                result = self.xttrader.connect(
                    account_id=self.config.account_id,
                    password=self.config.password
                )
            else:
                # æ–¹å¼2ï¼šä½¿ç”¨å·²æœ‰ä¼šè¯
                if self.config.session_id:
                    result = self.xttrader.connect(
                        session_id=self.config.session_id
                    )
                else:
                    # æ–¹å¼3ï¼šä½¿ç”¨é»˜è®¤è¿æ¥
                    result = self.xttrader.connect()
            
            if result:
                self.session_id = result.get('session_id') or self.config.session_id
                return True
            else:
                logger.error("QMTç™»å½•å¤±è´¥")
                return False
                
        except Exception as e:
            logger.error(f"ç™»å½•å¼‚å¸¸: {e}")
            return False
    
    def disconnect(self):
        """æ–­å¼€QMTè¿æ¥"""
        try:
            if self.connected and self.xttrader:
                # æ–­å¼€è¿æ¥
                self.xttrader.disconnect()
        except Exception as e:
            logger.warning(f"æ–­å¼€è¿æ¥å¤±è´¥: {e}")
        finally:
            self.connected = False
            self.session_id = None
            self.xttrader = None
            self.xtdata = None
    
    def is_connected(self) -> bool:
        """æ£€æŸ¥è¿æ¥çŠ¶æ€"""
        return self.connected and self.xttrader is not None
```

### è¿æ¥ç®¡ç†

```python
class QMTConnectionManager:
    """QMTè¿æ¥ç®¡ç†å™¨"""
    
    def __init__(self):
        self.connections: Dict[str, QMTConnection] = {}
    
    def get_connection(
        self,
        config: QMTConfig
    ) -> QMTConnection:
        """
        è·å–QMTè¿æ¥ï¼ˆå¤ç”¨æˆ–åˆ›å»ºï¼‰
        
        Args:
            config: QMTé…ç½®
        
        Returns:
            QMTConnection: QMTè¿æ¥å¯¹è±¡
        """
        connection_key = f"{config.qmt_path}:{config.account_id}"
        
        if connection_key in self.connections:
            connection = self.connections[connection_key]
            if connection.is_connected():
                return connection
            else:
                # è¿æ¥å·²æ–­å¼€ï¼Œé‡æ–°è¿æ¥
                del self.connections[connection_key]
        
        # åˆ›å»ºæ–°è¿æ¥
        connection = QMTConnection(config)
        if connection.connect():
            self.connections[connection_key] = connection
            return connection
        else:
            raise ConnectionError("æ— æ³•å»ºç«‹QMTè¿æ¥")
    
    def close_all(self):
        """å…³é—­æ‰€æœ‰è¿æ¥"""
        for connection in self.connections.values():
            connection.disconnect()
        self.connections.clear()
```

<h2 id="section-9-2-2">ğŸ’¹ 9.2.2 äº¤æ˜“æ¥å£</h2>

äº¤æ˜“æ¥å£æä¾›ä¸‹å•ã€æ’¤å•ã€æŸ¥è¯¢ç­‰äº¤æ˜“åŠŸèƒ½ã€‚

### ä¸‹å•æ¥å£

```python
class QMTTrader:
    """QMTäº¤æ˜“æ¥å£"""
    
    def __init__(self, connection: QMTConnection):
        """
        åˆå§‹åŒ–äº¤æ˜“æ¥å£
        
        Args:
            connection: QMTè¿æ¥
        """
        self.connection = connection
        self.xttrader = connection.xttrader
    
    def submit_order(
        self,
        order_request: OrderRequest
    ) -> Dict[str, Any]:
        """
        æäº¤è®¢å•
        
        Args:
            order_request: è®¢å•è¯·æ±‚
        
        Returns:
            Dict: è®¢å•ç»“æœï¼ˆåŒ…å«order_id, statusç­‰ï¼‰
        """
        if not self.connection.is_connected():
            raise ConnectionError("æœªè¿æ¥åˆ°QMTæœåŠ¡å™¨")
        
        try:
            # æ„å»ºè®¢å•å‚æ•°
            order_params = {
                'stock_code': order_request.symbol,
                'order_type': self._convert_order_type(order_request.order_type),
                'order_volume': order_request.quantity,
                'price_type': self._convert_price_type(order_request.order_type),
                'price': order_request.price or 0,
                'strategy_name': 'TRQuant',
                'order_remark': 'TRQuantç­–ç•¥è®¢å•'
            }
            
            # æäº¤è®¢å•
            if order_request.side == OrderSide.BUY:
                result = self.xttrader.order_stock(
                    account_id=self.connection.config.account_id,
                    **order_params
                )
            else:
                result = self.xttrader.order_stock(
                    account_id=self.connection.config.account_id,
                    **order_params
                )
            
            if result.get('error_id') == 0:
                return {
                    'order_id': result.get('order_id'),
                    'status': 'submitted',
                    'message': 'è®¢å•æäº¤æˆåŠŸ'
                }
            else:
                raise ValueError(f"è®¢å•æäº¤å¤±è´¥: {result.get('error_msg')}")
                
        except Exception as e:
            logger.error(f"ä¸‹å•å¼‚å¸¸: {e}")
            raise
    
    def _convert_order_type(self, order_type: OrderType) -> int:
        """è½¬æ¢è®¢å•ç±»å‹"""
        # QMTè®¢å•ç±»å‹ï¼š23-ä¹°å…¥ï¼Œ24-å–å‡º
        # å®é™…å®ç°éœ€è¦æ ¹æ®QMT APIæ–‡æ¡£
        if order_type == OrderType.MARKET:
            return 23  # å¸‚ä»·ä¹°å…¥
        elif order_type == OrderType.LIMIT:
            return 23  # é™ä»·ä¹°å…¥
        else:
            return 23
    
    def _convert_price_type(self, order_type: OrderType) -> int:
        """è½¬æ¢ä»·æ ¼ç±»å‹"""
        # QMTä»·æ ¼ç±»å‹ï¼š1-é™ä»·ï¼Œ2-å¸‚ä»·
        if order_type == OrderType.MARKET:
            return 2  # å¸‚ä»·
        else:
            return 1  # é™ä»·
    
    def cancel_order(
        self,
        order_id: str
    ) -> Dict[str, Any]:
        """
        æ’¤é”€è®¢å•
        
        Args:
            order_id: è®¢å•ID
        
        Returns:
            Dict: æ’¤å•ç»“æœ
        """
        if not self.connection.is_connected():
            raise ConnectionError("æœªè¿æ¥åˆ°QMTæœåŠ¡å™¨")
        
        try:
            # æ’¤é”€è®¢å•
            result = self.xttrader.cancel_order_stock(
                account_id=self.connection.config.account_id,
                order_id=order_id
            )
            
            if result.get('error_id') == 0:
                return {
                    'order_id': order_id,
                    'status': 'cancelled',
                    'message': 'è®¢å•æ’¤é”€æˆåŠŸ'
                }
            else:
                raise ValueError(f"è®¢å•æ’¤é”€å¤±è´¥: {result.get('error_msg')}")
                
        except Exception as e:
            logger.error(f"æ’¤å•å¼‚å¸¸: {e}")
            raise
    
    def query_order(
        self,
        order_id: Optional[str] = None
    ) -> List[Dict[str, Any]]:
        """
        æŸ¥è¯¢è®¢å•
        
        Args:
            order_id: è®¢å•IDï¼ˆå¯é€‰ï¼Œä¸æä¾›åˆ™æŸ¥è¯¢æ‰€æœ‰è®¢å•ï¼‰
        
        Returns:
            List[Dict]: è®¢å•åˆ—è¡¨
        """
        if not self.connection.is_connected():
            raise ConnectionError("æœªè¿æ¥åˆ°QMTæœåŠ¡å™¨")
        
        try:
            # æŸ¥è¯¢è®¢å•
            result = self.xttrader.query_stock_orders(
                account_id=self.connection.config.account_id,
                order_id=order_id
            )
            
            if result.get('error_id') == 0:
                return result.get('data', [])
            else:
                raise ValueError(f"è®¢å•æŸ¥è¯¢å¤±è´¥: {result.get('error_msg')}")
                
        except Exception as e:
            logger.error(f"æŸ¥è¯¢è®¢å•å¼‚å¸¸: {e}")
            raise
```

<h2 id="section-9-2-3">ğŸ“Š 9.2.3 æ•°æ®æ¥å£</h2>

æ•°æ®æ¥å£æä¾›è¡Œæƒ…æ•°æ®ã€è´¦æˆ·æ•°æ®ã€æŒä»“æ•°æ®çš„è·å–åŠŸèƒ½ã€‚

### è¡Œæƒ…æ•°æ®æ¥å£

```python
class QMTDataProvider:
    """QMTæ•°æ®æä¾›è€…"""
    
    def __init__(self, connection: QMTConnection):
        """
        åˆå§‹åŒ–æ•°æ®æä¾›è€…
        
        Args:
            connection: QMTè¿æ¥
        """
        self.connection = connection
        self.xtdata = connection.xtdata
    
    def get_market_data(
        self,
        symbols: List[str],
        fields: List[str] = None
    ) -> pd.DataFrame:
        """
        è·å–è¡Œæƒ…æ•°æ®
        
        Args:
            symbols: è‚¡ç¥¨ä»£ç åˆ—è¡¨
            fields: å­—æ®µåˆ—è¡¨ï¼ˆå¯é€‰ï¼Œé»˜è®¤æ‰€æœ‰å­—æ®µï¼‰
        
        Returns:
            pd.DataFrame: è¡Œæƒ…æ•°æ®
        """
        if not self.connection.is_connected():
            raise ConnectionError("æœªè¿æ¥åˆ°QMTæœåŠ¡å™¨")
        
        try:
            # è·å–è¡Œæƒ…æ•°æ®
            data = self.xtdata.get_market_data(
                stock_list=symbols,
                period='1d',  # æ—¥çº¿
                count=1
            )
            
            # è½¬æ¢ä¸ºDataFrame
            df = pd.DataFrame(data)
            return df
            
        except Exception as e:
            logger.error(f"è·å–è¡Œæƒ…æ•°æ®å¼‚å¸¸: {e}")
            raise
    
    def get_account_info(self) -> Dict[str, Any]:
        """
        è·å–è´¦æˆ·ä¿¡æ¯
        
        Returns:
            Dict: è´¦æˆ·ä¿¡æ¯
        """
        if not self.connection.is_connected():
            raise ConnectionError("æœªè¿æ¥åˆ°QMTæœåŠ¡å™¨")
        
        try:
            # è·å–è´¦æˆ·ä¿¡æ¯
            result = self.connection.xttrader.query_stock_asset(
                account_id=self.connection.config.account_id
            )
            
            if result.get('error_id') == 0:
                return result.get('data', {})
            else:
                raise ValueError(f"è´¦æˆ·ä¿¡æ¯è·å–å¤±è´¥: {result.get('error_msg')}")
                
        except Exception as e:
            logger.error(f"è·å–è´¦æˆ·ä¿¡æ¯å¼‚å¸¸: {e}")
            raise
    
    def get_positions(self) -> pd.DataFrame:
        """
        è·å–æŒä»“ä¿¡æ¯
        
        Returns:
            pd.DataFrame: æŒä»“æ•°æ®
        """
        if not self.connection.is_connected():
            raise ConnectionError("æœªè¿æ¥åˆ°QMTæœåŠ¡å™¨")
        
        try:
            # è·å–æŒä»“ä¿¡æ¯
            result = self.connection.xttrader.query_stock_positions(
                account_id=self.connection.config.account_id
            )
            
            if result.get('error_id') == 0:
                data = result.get('data', [])
                return pd.DataFrame(data)
            else:
                raise ValueError(f"æŒä»“ä¿¡æ¯è·å–å¤±è´¥: {result.get('error_msg')}")
                
        except Exception as e:
            logger.error(f"è·å–æŒä»“ä¿¡æ¯å¼‚å¸¸: {e}")
            raise
```

<h2 id="section-9-2-4">ğŸ›¡ï¸ 9.2.4 é£é™©æ§åˆ¶</h2>

é£é™©æ§åˆ¶ç¡®ä¿äº¤æ˜“å®‰å…¨ï¼ŒåŒ…æ‹¬äº¤æ˜“é£æ§å’ŒæŒä»“é£æ§ã€‚

### äº¤æ˜“é£æ§

```python
class QMTRiskController:
    """QMTé£é™©æ§åˆ¶å™¨"""
    
    def __init__(
        self,
        connection: QMTConnection,
        config: RiskControlConfig
    ):
        """
        åˆå§‹åŒ–é£é™©æ§åˆ¶å™¨
        
        Args:
            connection: QMTè¿æ¥
            config: é£é™©æ§åˆ¶é…ç½®
        """
        self.connection = connection
        self.config = config
        self.data_provider = QMTDataProvider(connection)
    
    def check_order_risk(
        self,
        order_request: OrderRequest
    ) -> Tuple[bool, str]:
        """
        æ£€æŸ¥è®¢å•é£é™©
        
        Args:
            order_request: è®¢å•è¯·æ±‚
        
        Returns:
            Tuple[bool, str]: (æ˜¯å¦é€šè¿‡, é”™è¯¯ä¿¡æ¯)
        """
        # 1. æ£€æŸ¥ä»·æ ¼èŒƒå›´
        if order_request.price:
            if order_request.price < self.config.min_price:
                return False, f"ä»·æ ¼ä½äºæœ€å°å€¼: {order_request.price}"
            if order_request.price > self.config.max_price:
                return False, f"ä»·æ ¼é«˜äºæœ€å¤§å€¼: {order_request.price}"
        
        # 2. è·å–è´¦æˆ·ä¿¡æ¯
        account_info = self.data_provider.get_account_info()
        total_value = account_info.get('total_asset', 0)
        available_cash = account_info.get('cash', 0)
        
        # 3. æ£€æŸ¥å•ç¥¨ä»“ä½
        if order_request.side == OrderSide.BUY:
            order_value = order_request.quantity * (order_request.price or 0)
            position_ratio = order_value / total_value if total_value > 0 else 0
            
            if position_ratio > self.config.max_position_ratio:
                return False, f"å•ç¥¨ä»“ä½è¶…è¿‡é™åˆ¶: {position_ratio:.2%}"
            
            if order_value > available_cash:
                return False, f"å¯ç”¨èµ„é‡‘ä¸è¶³: {available_cash:.2f}"
        
        # 4. æ£€æŸ¥æ€»ä»“ä½
        positions = self.data_provider.get_positions()
        total_position_value = positions['market_value'].sum() if not positions.empty else 0
        total_position_ratio = total_position_value / total_value if total_value > 0 else 0
        
        if total_position_ratio > self.config.max_total_position:
            return False, f"æ€»ä»“ä½è¶…è¿‡é™åˆ¶: {total_position_ratio:.2%}"
        
        return True, "é£é™©æ£€æŸ¥é€šè¿‡"
```

<h2 id="section-9-2-5">ğŸš€ 9.2.5 ç­–ç•¥éƒ¨ç½²</h2>

ç­–ç•¥éƒ¨ç½²æ˜¯å°†ç»è¿‡BulletTradeå›æµ‹éªŒè¯çš„ç­–ç•¥éƒ¨ç½²åˆ°QMTå¹³å°çš„è¿‡ç¨‹ã€‚

### ä¸ç¬¬8ç« çš„è¡”æ¥

ç­–ç•¥éƒ¨ç½²æ˜¯ç¬¬8ç« å›æµ‹éªŒè¯çš„åç»­ç¯èŠ‚ï¼š

1. **ç¬¬8ç« æµç¨‹**ï¼š
   - åœ¨éŸ¬ç¿ç³»ç»Ÿå†…éƒ¨ä½¿ç”¨BulletTrade+èšå®½æ•°æ®æºè¿›è¡Œå›æµ‹
   - éªŒè¯ç­–ç•¥æ€§èƒ½æŒ‡æ ‡ï¼ˆå¤æ™®æ¯”ç‡ã€æœ€å¤§å›æ’¤ç­‰ï¼‰
   - ç”Ÿæˆå›æµ‹æŠ¥å‘Š

2. **ç¬¬9ç« æµç¨‹**ï¼š
   - å°†èšå®½é£æ ¼ç­–ç•¥ä»£ç è½¬æ¢ä¸ºQMTæ ¼å¼
   - ä¸Šä¼ åˆ°QMTå¹³å°
   - è¿›è¡Œåˆ¸å•†ç¯å¢ƒå›æµ‹éªŒè¯
   - å¯åŠ¨å®ç›˜äº¤æ˜“

### ç­–ç•¥ä»£ç è½¬æ¢

```python
from core.strategy_converter import StrategyCodeConverter

class QMTStrategyDeployer:
    """QMTç­–ç•¥éƒ¨ç½²å™¨"""
    
    def __init__(self, connection: QMTConnection):
        """
        åˆå§‹åŒ–ç­–ç•¥éƒ¨ç½²å™¨
        
        Args:
            connection: QMTè¿æ¥
        """
        self.connection = connection
        self.converter = StrategyCodeConverter()
    
    def deploy_strategy(
        self,
        jq_strategy_path: str,
        strategy_name: str
    ) -> Dict[str, Any]:
        """
        éƒ¨ç½²ç­–ç•¥åˆ°QMTå¹³å°
        
        Args:
            jq_strategy_path: èšå®½é£æ ¼ç­–ç•¥ä»£ç è·¯å¾„
            strategy_name: ç­–ç•¥åç§°
        
        Returns:
            Dict: éƒ¨ç½²ç»“æœ
        """
        # 1. è¯»å–èšå®½é£æ ¼ç­–ç•¥ä»£ç 
        with open(jq_strategy_path, 'r', encoding='utf-8') as f:
            jq_code = f.read()
        
        # 2. è½¬æ¢ä¸ºQMTæ ¼å¼
        qmt_code = self.converter.convert_to_qmt(jq_code)
        
        # 3. ä¿å­˜QMTæ ¼å¼ä»£ç 
        qmt_strategy_path = jq_strategy_path.replace('.py', '_qmt.py')
        with open(qmt_strategy_path, 'w', encoding='utf-8') as f:
            f.write(qmt_code)
        
        # 4. ä¸Šä¼ åˆ°QMTå¹³å°
        upload_result = self._upload_to_qmt(
            qmt_strategy_path,
            strategy_name
        )
        
        return {
            'strategy_name': strategy_name,
            'qmt_code_path': qmt_strategy_path,
            'upload_result': upload_result
        }
    
    def _upload_to_qmt(
        self,
        strategy_path: str,
        strategy_name: str
    ) -> Dict[str, Any]:
        """ä¸Šä¼ ç­–ç•¥åˆ°QMTå¹³å°"""
        # QMTç­–ç•¥æ–‡ä»¶éœ€è¦æ”¾åœ¨QMTçš„ç­–ç•¥ç›®å½•
        qmt_strategies_dir = Path(self.connection.config.qmt_path) / "userdata_mini" / "strategies"
        qmt_strategies_dir.mkdir(parents=True, exist_ok=True)
        
        # å¤åˆ¶ç­–ç•¥æ–‡ä»¶åˆ°QMTç­–ç•¥ç›®å½•
        target_path = qmt_strategies_dir / f"{strategy_name}.py"
        shutil.copy2(strategy_path, target_path)
        
        return {
            'success': True,
            'strategy_path': str(target_path),
            'message': 'ç­–ç•¥ä¸Šä¼ æˆåŠŸ'
        }
```

### å®Œæ•´éƒ¨ç½²å·¥ä½œæµ

```python
def qmt_deployment_workflow(
    jq_strategy_path: str,
    strategy_name: str,
    qmt_config: QMTConfig
) -> Dict[str, Any]:
    """
    QMTéƒ¨ç½²å®Œæ•´å·¥ä½œæµ
    
    1. å»ºç«‹QMTè¿æ¥
    2. è½¬æ¢ç­–ç•¥ä»£ç ï¼ˆèšå®½é£æ ¼ â†’ QMTæ ¼å¼ï¼‰
    3. ä¸Šä¼ ç­–ç•¥åˆ°QMTå¹³å°
    4. éªŒè¯éƒ¨ç½²ç»“æœ
    
    Args:
        jq_strategy_path: èšå®½é£æ ¼ç­–ç•¥ä»£ç è·¯å¾„
        strategy_name: ç­–ç•¥åç§°
        qmt_config: QMTé…ç½®
    
    Returns:
        Dict: éƒ¨ç½²ç»“æœ
    """
    # 1. å»ºç«‹QMTè¿æ¥
    connection = QMTConnection(qmt_config)
    if not connection.connect():
        raise ConnectionError("æ— æ³•è¿æ¥åˆ°QMTå¹³å°")
    
    try:
        # 2. åˆ›å»ºç­–ç•¥éƒ¨ç½²å™¨
        deployer = QMTStrategyDeployer(connection)
        
        # 3. éƒ¨ç½²ç­–ç•¥
        deployment_result = deployer.deploy_strategy(
            jq_strategy_path,
            strategy_name
        )
        
        return {
            'success': True,
            'deployment_result': deployment_result
        }
    finally:
        # 4. æ–­å¼€è¿æ¥
        connection.disconnect()
```

## ğŸ”— ç›¸å…³ç« èŠ‚

- **ç¬¬7ç« ï¼šç­–ç•¥å¼€å‘**ï¼šäº†è§£ç­–ç•¥å¼€å‘å’Œæµ‹è¯•æµç¨‹
- **ç¬¬8ç« ï¼šå›æµ‹éªŒè¯**ï¼šäº†è§£BulletTradeå›æµ‹å’ŒPTrade/QMTéƒ¨ç½²æµç¨‹
- **9.1 PTradeé›†æˆ**ï¼šäº†è§£PTradeå¹³å°é›†æˆ

## ğŸ’¡ å…³é”®è¦ç‚¹

1. **è¿æ¥ç®¡ç†**ï¼šæ­£ç¡®é…ç½®å’Œå»ºç«‹QMTè¿æ¥æ˜¯é›†æˆçš„åŸºç¡€
2. **äº¤æ˜“æ¥å£**ï¼šæŒæ¡ä¸‹å•ã€æ’¤å•ã€æŸ¥è¯¢ç­‰äº¤æ˜“æ¥å£çš„ä½¿ç”¨
3. **æ•°æ®æ¥å£**ï¼šç†è§£è¡Œæƒ…æ•°æ®ã€è´¦æˆ·æ•°æ®ã€æŒä»“æ•°æ®çš„è·å–æ–¹æ³•
4. **é£é™©æ§åˆ¶**ï¼šå®ç°äº¤æ˜“é£æ§å’ŒæŒä»“é£æ§ï¼Œç¡®ä¿äº¤æ˜“å®‰å…¨
5. **ç­–ç•¥éƒ¨ç½²**ï¼šæŒæ¡ä»BulletTradeå›æµ‹åˆ°QMTéƒ¨ç½²çš„å®Œæ•´æµç¨‹

## ğŸ”® æ€»ç»“ä¸å±•æœ›

<div class="summary-outlook">
  <h3>æœ¬èŠ‚å›é¡¾</h3>
  <p>æœ¬èŠ‚ç³»ç»Ÿä»‹ç»äº†QMTå¹³å°é›†æˆï¼ŒåŒ…æ‹¬QMTè¿æ¥ã€äº¤æ˜“æ¥å£ã€æ•°æ®æ¥å£ã€é£é™©æ§åˆ¶å’Œç­–ç•¥éƒ¨ç½²ã€‚é€šè¿‡ç†è§£QMTé›†æˆçš„æ ¸å¿ƒæŠ€æœ¯ï¼Œå¸®åŠ©å¼€å‘è€…æŒæ¡å¦‚ä½•å°†ç»è¿‡BulletTradeå›æµ‹éªŒè¯çš„ç­–ç•¥éƒ¨ç½²åˆ°å›½é‡‘è¯åˆ¸QMTå¹³å°ï¼Œå®ç°å®ç›˜äº¤æ˜“å’Œåˆ¸å•†ç¯å¢ƒå›æµ‹ã€‚</p>
  
  <h3>ä¸‹èŠ‚é¢„å‘Š</h3>
  <p>æŒæ¡äº†PTradeå’ŒQMTé›†æˆåï¼Œä¸‹ä¸€èŠ‚å°†ä»‹ç»å®ç›˜åé¦ˆä¸åœ¨çº¿å†ä¼˜åŒ–ï¼ŒåŒ…æ‹¬å®ç›˜åé¦ˆæœºåˆ¶ã€åœ¨çº¿å†ä¼˜åŒ–æµç¨‹å’Œåé¦ˆé—­ç¯è®¾è®¡ã€‚é€šè¿‡ç†è§£å®ç›˜åé¦ˆçš„å®Œæ•´æœºåˆ¶ï¼Œå¸®åŠ©å¼€å‘è€…æŒæ¡å¦‚ä½•å®ç°ç­–ç•¥çš„æŒç»­ä¼˜åŒ–ã€‚</p>
  
  <a href="/ashare-book6/009_Chapter9_Platform_Integration/9.6_Live_Trading_Management_CN" class="next-section">
    ç»§ç»­å­¦ä¹ ï¼š9.6 å®ç›˜äº¤æ˜“ç®¡ç† â†’
  </a>
</div>

> **é€‚ç”¨ç‰ˆæœ¬**: v1.0.0+  
> **æœ€åæ›´æ–°**: 2025-12-12
