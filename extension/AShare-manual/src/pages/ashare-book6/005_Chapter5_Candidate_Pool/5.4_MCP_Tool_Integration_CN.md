---
title: "5.4 MCP工具集成"
description: "深入解析候选池构建模块的MCP工具集成，包括知识库查询、数据收集工具等工具的使用"
lang: "zh-CN"
layout: "/src/layouts/HandbookLayout.astro"
currentBook: "ashare-book6"
updateDate: "2025-12-12"
---

# 🛠️ 5.4 MCP工具集成

> **核心摘要：**
> 
> 本节系统介绍候选池构建模块与MCP工具的深度集成，支持通过MCP工具进行知识库查询和数据收集。通过理解KB MCP Server工具和Data Collector工具的使用方法、参数说明、返回结果和应用场景，帮助开发者掌握如何使用MCP工具提升候选池构建效率，实现AI增强的候选池构建能力。

候选池构建模块与MCP工具深度集成，提供知识库查询、数据收集等功能。

## 📋 章节概览

<script>
function scrollToSection(sectionId) {
  const element = document.getElementById(sectionId);
  if (element) {
    const headerOffset = 100;
    const elementPosition = element.getBoundingClientRect().top;
    const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
    window.scrollTo({
      top: offsetPosition,
      behavior: 'smooth'
    });
  }
}
</script>

<div class="section-overview">
  <div class="section-item" onclick="scrollToSection('section-5-4-1')">
    <h4>🔍 5.4.1 KB MCP Server工具</h4>
    <p>kb.query知识库查询工具的使用方法和查询技巧</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-5-4-2')">
    <h4>📥 5.4.2 Data Collector工具</h4>
    <p>data_collector.crawl_web网页爬取工具的使用方法和数据收集</p>
  </div>
  <div class="section-item" onclick="scrollToSection('section-5-4-3')">
    <h4>🔄 5.4.3 工具集成工作流</h4>
    <p>MCP工具在候选池构建中的完整工作流和最佳实践</p>
  </div>
</div>

## 🎯 学习目标

通过本节学习，您将能够：

- **使用KB MCP工具**：掌握知识库查询方法和查询技巧
- **使用Data Collector工具**：掌握数据收集方法和数据处理
- **构建工具集成工作流**：理解MCP工具在候选池构建中的完整应用流程

## 📚 核心概念

### MCP工具集成架构

候选池构建模块通过MCP（Model Context Protocol）协议与AI工具链深度集成：

1. **KB MCP Server**：提供知识库查询能力
2. **Data Collector MCP Server**：提供数据收集能力

### 工具调用方式

在Cursor中，MCP工具可以通过以下方式调用：

1. **直接调用**：在AI对话中直接请求使用工具
2. **命令调用**：通过命令面板执行相关命令
3. **代码调用**：在Python代码中通过MCP客户端调用

<h2 id="section-5-4-1">🔍 5.4.1 KB MCP Server工具</h2>

KB MCP Server提供知识库查询能力，支持查询开发手册和工程代码库。

### kb.query

查询知识库，获取候选池构建相关的文档和代码。

#### 工具定义

<CodeFromFile 
  filePath="code_library/005_Chapter5_Candidate_Pool/5.4/code_5_4_工具定义.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- 原始代码（保留作为备份）：
```python
MCPTool(
    name="kb.query",
    description="查询知识库，获取相关文档和代码",
    input_schema={
        "type": "object",
        "properties": {
            "query": {
                "type": "string",
                "description": "查询关键词或问题"
            },
            "collection": {
                "type": "string",
                "enum": ["manual_kb", "engineering_kb", "both"],
                "description": "查询范围：manual_kb（手册）/engineering_kb（代码库）/both（两者）",
                "default": "both"
            },
            "top_k": {
                "type": "integer",
                "description": "返回前K个结果，默认5",
                "default": 5
            }
        },
        "required": ["query"]
    }
)
```
-->

#### 参数说明

| 参数 | 类型 | 必填 | 默认值 | 说明 |
|------|------|------|--------|------|
| query | string | 是<CodeFromFile 
  filePath="code_library/005_Chapter5_Candidate_Pool/5.4/code_5_4_查询候选池构建相关文档.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- 原始代码（保留作为备份）：
```python
from mcp import MCPClient

# 初始化MCP客户端
client = MCPClient(server_url="http://localhost:8000")

# 查询候选池构建相关的开发文档
results = client.call_tool(
    "kb.query",
    {
        "query": "候选池构建 股票池管理 筛选规则",
        "collection": "manual_kb",
        "top_k": 5
    }
)

# 处理结果
for result in results:
    print(f"文档: {result['title']<CodeFromFile 
  filePath="code_library/005_Chapter5_Candidate_Pool/5.4/code_5_4_查询候选池构建相关代码.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- 原始代码（保留作为备份）：
```python
# 查询候选池构建相关的代码实现
results = client.call_tool(
    "kb.query",
    {
        "query": "候选池构建器 CandidatePoolBuilder 股票评分",
        "collection": "engineering_kb",
        "top_k": 10
    }
)

# 处理结果
for result in results:
    print(f"文件: {result['file_path']}")
    pri<CodeFromFile 
  filePath="code_library/005_Chapter5_Candidate_Pool/5.4/code_5_4_build_from_mainline.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- 原始代码（保留作为备份）：
```python
[
    {
        "title": "5.1 股票池管理",
        "file_path": "/ashare-book6/005_Chapter5_Candidate_Pool/5.1_Stock_Pool_Management_CN.md",
        "snippet": "股票池管理是候选池构建模块的核心功能，负责管理多个股票池...",
        "score": 0.95,
        "type": "document"
    },
    {
        "file_path": "core/candidate_pool_builder.py",
        "function_name": "build_from_mainline",
        "code_snippet": "def build_from_mainline(self, mainline_name: str, ...):\n    # 候选池构建实现...",
        "score": 0.88,
        "type": "code"
    },
    # ... 更多结果
]
```
--> "title": "5.1 股票池管理",
        "file_path": "/ashare-book6/005_Chapter5_Candidate_Pool/5.1_Stock_Pool_Management_CN.md",
        "snippet": "股票池管理是候选池构建模块的核心功能，负责管理多个股票池...",
        "score": 0.95,
        "type": "document"
    },
    {
        "file_path": "core/candidate_pool_builder.py",
        "function_name": "build_from_mainline",
        "code_snippet": "def build_from_mainline(self, mainline_name: str, ...):\n    # 候选池构建实现...",
        "score": 0.88,
        "<CodeFromFile 
  filePath="code_library/005_Chapter5_Candidate_Pool/5.4/code_5_4_工具定义.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- 原始代码（保留作为备份）：
```python
MCPTool(
    name="data_collector.crawl_web",
    description="爬取网页内容，提取文本和链接",
    input_schema={
        "type": "object",
        "properties": {
            "url": {
                "type": "string",
                "description<CodeFromFile 
  filePath="code_library/005_Chapter5_Candidate_Pool/5.4/code_5_4_爬取候选池构建相关网页.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- 原始代码（保留作为备份）：
```python
# 爬取候选池构建相关网页
result = client.call_tool(
    "data_collector.crawl_web",
    {
        "url": "https://example.com/candidate-pool-construction",
        "extract_text": True,
        "max_depth": 2,
        "output_dir": "data/collected/candidate_pool"
    }
)

# 处理结果
print(f"爬取页面数: {result['pages_crawled']}")
print(f"提取文本长度: {result['text_length']}")
print(f"保存路径: {result['output_path']}")
print(f"文件列表: {result['files']}")
```
-->认data/collected",
                "default": "data/collected"
            }
        },
        "required": ["url"]
    }
)
```
-->     "type": "object",
        "properties": {
            "url": {
                "type": "string",
                "description": "目标网页URL"
            },
            "extract_text": {
                "type": "boolean",
                "description": "是否提取文本内容，默认true",
                "default": true
            },
            "max_depth": {
                "type": "integer",
                "description<CodeFromFile 
  filePath="code_library/005_Chapter5_Candidate_Pool/5.4/code_5_4_返回结果.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- 原始代码（保留作为备份）：
```python
{
    "pages_crawled": 5,
    "text_length": 50000,
    "output_path": "data/collected/candidate_pool",
    "files": [
        "page_1.html",
        "page_2.html",
        "page_3.html"
    ],
    "timestamp": "2025-12-12T10:00:00"
}
```
-->        "required": ["url"]
    }
)
```

#### 参数说明

| 参数 | <CodeFromFile 
  filePath="code_library/005_Chapter5_Candidate_Pool/5.4/code_5_4_完整工作流示例.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- 原始代码（保留作为备份）：
```python
# 1. 查询相关知识库
knowledge = client.call_tool(
    "kb.query",
    {
        "query": "候选池构建 股票池管理 筛选规则 股票评分",
        "collection": "both",
        "top_k": 5
    }
)

# 2. 如果知识库结果不足，收集外部资料
if len(knowledge) < 3:
    external_data = client.call_tool(
        "data_collector.crawl_web",
        {
            "url": "https://example.com/candidate-pool-construction",
            "extract_text": True
        }
    )

# 3. 基于知识库结果构建候选池
from core.candidate_pool_builder import CandidatePoolBuilder

builder = CandidatePoolBuilder()

# 从主线构建候选池
mainline_name = "AI算力基础设施"
pool = builder.build_from_mainline(
    mainline_name=mainline_name,
    mainline_type="concept"
)

# 4. 对候选股票进行评分
from core.stock_scorer import StockScorer

scorer = StockScorer()
for stock in pool.stocks:
    score_result = scorer.score_stock(
        stock_code=stock.code,
        # ... 其他参数
    )
    stock.composite_score = score_res<CodeFromFile 
  filePath="code_library/005_Chapter5_Candidate_Pool/5.4/code_5_4_safe_call_tool.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- 原始代码（保留作为备份）：
```python
def safe_call_tool(tool_name: str, params: dict, max_retries: int = 3):
    """安全调用MCP工具，带重试机制"""
    for attempt in range(max_retries):
        try:
            result = client.call_tool(tool_name, params)
            return result
        except Exception as e:
            logger.warni<CodeFromFile 
  filePath="code_library/005_Chapter5_Candidate_Pool/5.4/code_5_4_get_cached_knowledge.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- 原始代码（保留作为备份）：
```python
from functools import lru_cache
from datetime import datetime, timedelta

@lru_cache(maxsize=100)
def get_cached_knowledge(query: str, collection: str, top_k: int, cache_key: str):
    """缓存知识库查询结果（<CodeFromFile 
  filePath="code_library/005_Chapter5_Candidate_Pool/5.4/code_5_4_validate_knowledge_results.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- 原始代码（保留作为备份）：
```python
def validate_knowledge_results(results: List[Dict]) -> List[Dict]:
    """验证知识库查询结果"""
    validated = []
    for result in results:
        # 验证必要字段
        required_fields = ['title', 'file_path', 'score']
        if all(field in result for fiel<CodeFromFile 
  filePath="code_library/005_Chapter5_Candidate_Pool/5.4/code_5_4_知识库查询.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- 原始代码（保留作为备份）：
```python
# 查询相关知识
knowledge = client.call_tool(
    "kb.query",
    {"query": "候选池构建 股票评分", "collection": "both"}
)

# 如果知识库结果不足，收集外部资料
if len(knowledge) < 3:
    exte<CodeFromFile 
  filePath="code_library/005_Chapter5_Candidate_Pool/5.4/code_5_4_知识库查询.py"
  language="python"
  showDesignPrinciples="true"
/>

<!-- 原始代码（保留作为备份）：
```python
# 查询候选池构建最佳实践
best_practices = client.call_tool(
    "kb.query",
    {
        "query": "候选池构建 最佳实践 筛选规则配置",
        "collection": "manual_kb",
        "top_k": 5
    }
)

# 基于最佳实践构建候选池
for practice in best_practices:
    # 解析最佳实践内容
    # 应用到候选池构建
    pass
```
-->posite_score = score_result['composite_score']
```

### 最佳实践

#### 1. 工具调用顺序

**推荐顺序**：
1. 先查询知识库（`kb.query`）
2. 如果知识库结果不足，收集外部资料（`data_collector.crawl_web`）
3. 基于查询结果进行候选池构建

#### 2. 错误处理

```python
def safe_call_tool(tool_name: str, params: dict, max_retries: int = 3):
    """安全调用MCP工具，带重试机制"""
    for attempt in range(max_retries):
        try:
            result = client.call_tool(tool_name, params)
            return result
        except Exception as e:
            logger.warning(f"工具调用失败 (尝试 {attempt + 1}/{max_retries}): {e}")
            if attempt == max_retries - 1:
                raise
            time.sleep(1)  # 等待1秒后重试
```

#### 3. 结果缓存

```python
from functools import lru_cache
from datetime import datetime, timedelta

@lru_cache(maxsize=100)
def get_cached_knowledge(query: str, collection: str, top_k: int, cache_key: str):
    """缓存知识库查询结果（5分钟有效期）"""
    # cache_key包含日期，确保每天更新
    return client.call_tool(
        "kb.query",
        {"query": query, "collection": collection, "top_k": top_k}
    )
```

#### 4. 结果验证

```python
def validate_knowledge_results(results: List[Dict]) -> List[Dict]:
    """验证知识库查询结果"""
    validated = []
    for result in results:
        # 验证必要字段
        required_fields = ['title', 'file_path', 'score']
        if all(field in result for field in required_fields):
            # 验证相关性分数
            if 0 <= result['score'] <= 1:
                validated.append(result)
    return validated
```

### 工具组合使用

#### 知识库查询 + 数据收集

```python
# 查询相关知识
knowledge = client.call_tool(
    "kb.query",
    {"query": "候选池构建 股票评分", "collection": "both"}
)

# 如果知识库结果不足，收集外部资料
if len(knowledge) < 3:
    external_data = client.call_tool(
        "data_collector.crawl_web",
        {"url": "https://example.com/candidate-pool-construction"}
    )
```

#### 知识库查询 + 候选池构建

```python
# 查询候选池构建最佳实践
best_practices = client.call_tool(
    "kb.query",
    {
        "query": "候选池构建 最佳实践 筛选规则配置",
        "collection": "manual_kb",
        "top_k": 5
    }
)

# 基于最佳实践构建候选池
for practice in best_practices:
    # 解析最佳实践内容
    # 应用到候选池构建
    pass
```

## 🔗 相关章节

- **5.1 股票池管理**：了解股票池管理，理解候选池构建的基础
- **5.2 筛选规则**：了解筛选规则，理解候选池构建的筛选逻辑
- **5.3 股票评分**：了解股票评分系统，理解候选池构建的评分方法
- **第6章：因子库**：了解因子库，候选池用于因子计算
- **第7章：策略开发**：了解策略开发，候选池用于策略生成
- **第10章：开发指南**：了解MCP工具的开发和使用方法

## 💡 关键要点

1. **KB MCP工具**：提供知识库查询功能，支持候选池构建相关研究和问题解决
2. **Data Collector工具**：提供数据收集功能，支持外部资料获取和研究
3. **工具集成工作流**：通过工具组合使用，构建完整的候选池构建工作流

## 🔮 总结与展望

<div class="summary-outlook">
  <h3>本节回顾</h3>
  <p>本节系统介绍了候选池构建模块与MCP工具的深度集成，包括KB MCP Server工具和Data Collector工具的使用方法、参数说明、返回结果和应用场景。通过理解MCP工具在候选池构建中的应用，帮助开发者掌握如何使用MCP工具提升候选池构建效率，实现AI增强的候选池构建能力。</p>
  
  <h3>下节预告</h3>
  <p>掌握了候选池构建模块后，下一章将介绍因子库模块，包括因子计算、因子管理、因子优化和因子推荐。通过理解因子库的核心实现，帮助开发者掌握如何构建完整的因子工程能力。</p>
  
  <a href="/ashare-book6/006_Chapter6_Factor_Library/006_Chapter6_Factor_Library_CN" class="next-section">
    继续学习：第6章：因子库 →
  </a>
</div>

> **适用版本**: v1.0.0+  
> **最后更新**: 2025-12-12

