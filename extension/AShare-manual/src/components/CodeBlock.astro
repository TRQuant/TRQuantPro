---
/**
 * ä»£ç å—ç»„ä»¶
 * 
 * åŠŸèƒ½ï¼š
 * 1. ä»ä»£ç åº“ä¸­è¯»å–ä»£ç æ–‡ä»¶å¹¶æ˜¾ç¤º
 * 2. æ”¯æŒä»£ç é«˜äº®
 * 3. æ”¯æŒè®¾è®¡åŸç†è¯´æ˜
 * 4. ä»£ç æ›´æ–°åæ–‡æ¡£è‡ªåŠ¨æ˜¾ç¤ºæœ€æ–°ç‰ˆæœ¬
 * 
 * ä½¿ç”¨æ–¹å¼ï¼š
 * <CodeBlock codeId="3.2.2.analyze_price_dimension" />
 * æˆ–
 * <CodeBlock 
 *   codeId="3.2.2.analyze_price_dimension" 
 *   showDesignPrinciples={true}
 *   language="python"
 * />
 */

import { readFile } from 'fs/promises';
import { join } from 'path';

interface Props {
  codeId: string;  // ä»£ç IDï¼Œæ ¼å¼ï¼šç« èŠ‚.å°èŠ‚.å‡½æ•°åï¼Œå¦‚ "3.2.2.analyze_price_dimension"
  language?: string;  // ç¼–ç¨‹è¯­è¨€ï¼Œé»˜è®¤ "python"
  showDesignPrinciples?: boolean;  // æ˜¯å¦æ˜¾ç¤ºè®¾è®¡åŸç†ï¼Œé»˜è®¤ true
  showLineNumbers?: boolean;  // æ˜¯å¦æ˜¾ç¤ºè¡Œå·ï¼Œé»˜è®¤ false
  highlightLines?: string;  // é«˜äº®è¡Œå·ï¼Œæ ¼å¼ï¼š"1-5,10,15-20"
  version?: string;  // æŒ‡å®šç‰ˆæœ¬å·ï¼Œé»˜è®¤æœ€æ–°ç‰ˆæœ¬
}

const {
  codeId,
  language = 'python',
  showDesignPrinciples = true,
  showLineNumbers = false,
  highlightLines,
  version
} = Astro.props;

// è§£æä»£ç IDï¼Œè·å–æ–‡ä»¶è·¯å¾„
// æ ¼å¼ï¼š3.2.2.analyze_price_dimension -> 003_Chapter3_Market_Analysis/3.2/code_3_2_2_analyze_price_dimension.py
function parseCodeId(codeId: string): { chapter: string; section: string; filename: string } {
  const parts = codeId.split('.');
  if (parts.length < 2) {
    throw new Error(`Invalid codeId format: ${codeId}. Expected format: section.function_name`);
  }
  
  // æå–ç« èŠ‚å·ï¼ˆå¦‚ 3.2.2 -> 3.2ï¼‰
  const section = parts.slice(0, -1).join('.');
  const chapterNum = parts[0];
  
  // æ ¹æ®ç« èŠ‚å·ç¡®å®šç« èŠ‚ç›®å½•
  const chapterMap: Record<string, string> = {
    '1': '001_Chapter1_System_Overview',
    '2': '002_Chapter2_Data_Source',
    '3': '003_Chapter3_Market_Analysis',
    '4': '004_Chapter4_Mainline_Identification',
    '5': '005_Chapter5_Candidate_Pool',
    '6': '006_Chapter6_Factor_Library',
    '7': '007_Chapter7_Strategy_Development',
    '8': '008_Chapter8_Backtest',
    '9': '009_Chapter9_Platform_Integration',
    '10': '010_Chapter10_Development_Guide',
    '11': '011_Chapter11_User_Manual',
    '12': '012_Chapter12_API_Reference',
    '13': '013_Appendix'
  };
  
  const chapter = chapterMap[chapterNum] || `00${chapterNum}_Chapter${chapterNum}`;
  
  // ç”Ÿæˆæ–‡ä»¶å
  const safeCodeId = codeId.replace(/\./g, '_').replace(/-/g, '_');
  const filename = `code_${safeCodeId}.py`;
  
  return { chapter, section, filename };
}

// è¯»å–ä»£ç æ–‡ä»¶
let codeContent = '';
let designPrinciples = '';
let error: string | null = null;

try {
  const { chapter, section, filename } = parseCodeId(codeId);
  const codePath = join(process.cwd(), 'code_library', chapter, section, filename);
  
  // è¯»å–ä»£ç æ–‡ä»¶
  codeContent = await readFile(codePath, 'utf-8');
  
  // æå–è®¾è®¡åŸç†è¯´æ˜ï¼ˆä»ä»£ç æ³¨é‡Šä¸­ï¼‰
  if (showDesignPrinciples) {
    const designMatch = codeContent.match(/\*\*è®¾è®¡åŸç†\*\*[ï¼š:]\s*\n(.*?)(?=\*\*|$)/s);
    if (designMatch) {
      designPrinciples = designMatch[1].trim();
    }
  }
  
  // ç§»é™¤è®¾è®¡åŸç†æ³¨é‡Šï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œåªä¿ç•™ä»£ç 
  codeContent = codeContent.replace(/\*\*è®¾è®¡åŸç†\*\*[ï¼š:].*?(?=\*\*|$)/gs, '').trim();
  
} catch (e) {
  error = `æ— æ³•åŠ è½½ä»£ç æ–‡ä»¶: ${codeId}. é”™è¯¯: ${e instanceof Error ? e.message : String(e)}`;
  console.error(error);
}

// ç”Ÿæˆè¡Œå·
function generateLineNumbers(content: string): string {
  const lines = content.split('\n');
  return lines.map((_, i) => (i + 1).toString().padStart(3, ' ')).join('\n');
}

// è§£æé«˜äº®è¡Œå·
function parseHighlightLines(highlightStr: string): Set<number> {
  const highlights = new Set<number>();
  const ranges = highlightStr.split(',');
  
  for (const range of ranges) {
    if (range.includes('-')) {
      const [start, end] = range.split('-').map(Number);
      for (let i = start; i <= end; i++) {
        highlights.add(i);
      }
    } else {
      highlights.add(Number(range));
    }
  }
  
  return highlights;
}

const highlightSet = highlightLines ? parseHighlightLines(highlightLines) : new Set();
const lines = codeContent.split('\n');
---

{error ? (
  <div class="code-error">
    <p>âš ï¸ {error}</p>
    <p>è¯·æ£€æŸ¥ä»£ç IDæ˜¯å¦æ­£ç¡®ï¼Œæˆ–ä»£ç æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚</p>
  </div>
) : (
  <div class="code-block-container">
    {showDesignPrinciples && designPrinciples && (
      <div class="design-principles">
        <h4>ğŸ’¡ è®¾è®¡åŸç†</h4>
        <div class="principles-content">
          {designPrinciples.split('\n').map(line => {
            // å¤„ç†Markdownæ ¼å¼çš„è®¾è®¡åŸç†è¯´æ˜
            if (line.trim().startsWith('- **')) {
              const match = line.match(/- \*\*(.*?)\*\*[ï¼š:]\s*(.*)/);
              if (match) {
                return (
                  <p>
                    <strong>{match[1]}</strong>ï¼š{match[2]}
                  </p>
                );
              }
            }
            return <p>{line}</p>;
          })}
        </div>
      </div>
    )}
    
    <div class="code-wrapper">
      {showLineNumbers && (
        <pre class="line-numbers"><code>{generateLineNumbers(codeContent)}</code></pre>
      )}
      <pre class={`language-${language} ${highlightLines ? 'has-highlights' : ''}`}>
        <code class={`language-${language}`}>
          {lines.map((line, index) => {
            const lineNum = index + 1;
            const isHighlighted = highlightSet.has(lineNum);
            return (
              <span class={isHighlighted ? 'highlight-line' : ''}>
                {line}
                {'\n'}
              </span>
            );
          })}
        </code>
      </pre>
    </div>
    
    <div class="code-meta">
      <span class="code-id">ä»£ç ID: {codeId}</span>
      {version && <span class="code-version">ç‰ˆæœ¬: {version}</span>}
      <a 
        href={`/code-editor?codeId=${codeId}`} 
        class="edit-code-link"
        target="_blank"
      >
        ç¼–è¾‘ä»£ç 
      </a>
    </div>
  </div>
)}

<style>
  .code-block-container {
    margin: 1.5rem 0;
    border: 1px solid var(--border-color, #e1e4e8);
    border-radius: 8px;
    overflow: hidden;
    background: var(--code-bg, #f6f8fa);
  }
  
  .design-principles {
    padding: 1rem 1.5rem;
    background: var(--principles-bg, #fff9e6);
    border-bottom: 1px solid var(--border-color, #e1e4e8);
  }
  
  .design-principles h4 {
    margin: 0 0 0.5rem 0;
    font-size: 0.9rem;
    color: var(--text-secondary, #586069);
  }
  
  .principles-content {
    font-size: 0.9rem;
    line-height: 1.6;
    color: var(--text-primary, #24292e);
  }
  
  .principles-content p {
    margin: 0.5rem 0;
  }
  
  .principles-content strong {
    color: var(--text-primary, #24292e);
  }
  
  .code-wrapper {
    display: flex;
    overflow-x: auto;
  }
  
  .line-numbers {
    margin: 0;
    padding: 1rem;
    background: var(--line-numbers-bg, #fafbfc);
    border-right: 1px solid var(--border-color, #e1e4e8);
    color: var(--text-secondary, #6a737d);
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    font-size: 0.85rem;
    line-height: 1.45;
    user-select: none;
    text-align: right;
  }
  
  pre code {
    display: block;
    padding: 1rem;
    overflow-x: auto;
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    font-size: 0.85rem;
    line-height: 1.45;
    color: var(--text-primary, #24292e);
    background: transparent;
  }
  
  .highlight-line {
    background: var(--highlight-bg, #fff5b1);
    display: block;
    padding: 0 0.5rem;
    margin: 0 -0.5rem;
  }
  
  .code-meta {
    padding: 0.75rem 1.5rem;
    background: var(--meta-bg, #fafbfc);
    border-top: 1px solid var(--border-color, #e1e4e8);
    font-size: 0.8rem;
    color: var(--text-secondary, #6a737d);
    display: flex;
    gap: 1rem;
    align-items: center;
  }
  
  .code-id {
    font-family: 'SFMono-Regular', Consolas, monospace;
  }
  
  .code-version {
    font-family: 'SFMono-Regular', Consolas, monospace;
  }
  
  .edit-code-link {
    margin-left: auto;
    color: var(--link-color, #0366d6);
    text-decoration: none;
  }
  
  .edit-code-link:hover {
    text-decoration: underline;
  }
  
  .code-error {
    padding: 1rem;
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 4px;
    color: #856404;
  }
</style>

