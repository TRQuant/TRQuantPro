---
/**
 * ä»æ–‡ä»¶ç›´æ¥è¯»å–ä»£ç çš„ç»„ä»¶ï¼ˆç®€åŒ–ç‰ˆï¼‰
 * 
 * ä½¿ç”¨æ–¹å¼ï¼š
 * <CodeBlockFromFile 
 *   filePath="code_library/003_Chapter3_Market_Analysis/3.2/code_3_2_2_analyze_price_dimension.py" 
 * />
 */

import { readFile } from 'fs/promises';
import { join } from 'path';

interface Props {
  filePath: string;  // ä»£ç æ–‡ä»¶è·¯å¾„ï¼ˆç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•ï¼‰
  language?: string;  // ç¼–ç¨‹è¯­è¨€ï¼Œé»˜è®¤ "python"
  showDesignPrinciples?: boolean;  // æ˜¯å¦æ˜¾ç¤ºè®¾è®¡åŸç†ï¼Œé»˜è®¤ true
  showLineNumbers?: boolean;  // æ˜¯å¦æ˜¾ç¤ºè¡Œå·ï¼Œé»˜è®¤ false
}

const {
  filePath,
  language = 'python',
  showDesignPrinciples = true,
  showLineNumbers = false
} = Astro.props;

// è¯»å–ä»£ç æ–‡ä»¶
let codeContent = '';
let designPrinciples = '';
let error: string | null = null;

try {
  const fullPath = join(process.cwd(), filePath);
  codeContent = await readFile(fullPath, 'utf-8');
  
  // æå–è®¾è®¡åŸç†è¯´æ˜
  if (showDesignPrinciples) {
    const designMatch = codeContent.match(/\*\*è®¾è®¡åŸç†\*\*[ï¼š:]\s*\n(.*?)(?=\*\*|$)/s);
    if (designMatch) {
      designPrinciples = designMatch[1].trim();
    }
  }
  
  // ç§»é™¤è®¾è®¡åŸç†æ³¨é‡Šï¼Œåªä¿ç•™ä»£ç 
  codeContent = codeContent.replace(/\*\*è®¾è®¡åŸç†\*\*[ï¼š:].*?(?=\*\*|$)/gs, '').trim();
  
} catch (e) {
  error = `æ— æ³•åŠ è½½ä»£ç æ–‡ä»¶: ${filePath}. é”™è¯¯: ${e instanceof Error ? e.message : String(e)}`;
  console.error(error);
}

const lines = codeContent.split('\n');
---

{error ? (
  <div class="code-error">
    <p>âš ï¸ {error}</p>
  </div>
) : (
  <div class="code-block-container">
    {showDesignPrinciples && designPrinciples && (
      <div class="design-principles">
        <h4>ğŸ’¡ è®¾è®¡åŸç†</h4>
        <div class="principles-content">
          {designPrinciples.split('\n').map(line => {
            if (line.trim().startsWith('- **')) {
              const match = line.match(/- \*\*(.*?)\*\*[ï¼š:]\s*(.*)/);
              if (match) {
                return (
                  <p>
                    <strong>{match[1]}</strong>ï¼š{match[2]}
                  </p>
                );
              }
            }
            return <p>{line}</p>;
          })}
        </div>
      </div>
    )}
    
    <pre class={`language-${language}`}>
      <code class={`language-${language}`}>
        {codeContent}
      </code>
    </pre>
  </div>
)}

<style>
  .code-block-container {
    margin: 1.5rem 0;
    border: 1px solid var(--border-color, #e1e4e8);
    border-radius: 8px;
    overflow: hidden;
    background: var(--code-bg, #f6f8fa);
  }
  
  .design-principles {
    padding: 1rem 1.5rem;
    background: var(--principles-bg, #fff9e6);
    border-bottom: 1px solid var(--border-color, #e1e4e8);
  }
  
  .design-principles h4 {
    margin: 0 0 0.5rem 0;
    font-size: 0.9rem;
    color: var(--text-secondary, #586069);
  }
  
  .principles-content {
    font-size: 0.9rem;
    line-height: 1.6;
    color: var(--text-primary, #24292e);
  }
  
  .principles-content p {
    margin: 0.5rem 0;
  }
  
  pre code {
    display: block;
    padding: 1rem;
    overflow-x: auto;
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    font-size: 0.85rem;
    line-height: 1.45;
    color: var(--text-primary, #24292e);
    background: transparent;
  }
  
  .code-error {
    padding: 1rem;
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 4px;
    color: #856404;
  }
</style>

